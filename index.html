<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Magius - Sistema de Checklist de Inspe√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- ESTILOS (CSS) -->
  <style>
  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:Arial,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#F4F6F9;
    color:#333;
  }

  /* TELA DE LOGIN */
  .login-screen{
    min-height:100vh;
    background:#051224;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .login-card{
    background:#0b1a33;
    border-radius:10px;
    padding:32px 36px 34px;
    max-width:520px;
    width:100%;
    box-shadow:0 12px 28px rgba(0,0,0,.45);
    color:#fff;
  }
  .login-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:14px;
  }
  .login-logo{
    font-weight:800;
    font-size:28px;
    letter-spacing:.08em;
  }
  .login-sub{
    font-size:15px;
    opacity:.8;
    text-transform:uppercase;
  }
  .login-title{
    font-size:22px;
    font-weight:700;
    margin:8px 0 14px;
  }
  .login-mode-toggle{
    display:flex;
    gap:12px;
    margin-bottom:16px;
  }
  .login-mode-btn{
    flex:1;
    border:none;
    border-radius:24px;
    padding:10px 14px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    background:rgba(255,255,255,.05);
    color:#fff;
  }
  .login-mode-btn.active{
    background:#1844F0;
  }
  .login-form-group{
    margin-bottom:14px;
  }
  .login-form-group label{
    font-size:16px;
    font-weight:600;
    display:block;
    margin-bottom:8px;
  }
  .login-form-group input,
  .login-form-group select{
    width:100%;
    padding:7px 9px;
    border-radius:4px;
    border:1px solid #2c3954;
    background:#020812;
    color:#fff;
    font-size:17px;
  }
  .login-help{
    font-size:15px;
    opacity:.75;
    margin-bottom:12px;
  }
  .login-error{
    font-size:15px;
    color:#E81C24;
    margin-bottom:12px;
    display:none;
  }
  .login-btn{
    width:100%;
    border:none;
    border-radius:8px;
    padding:12px 18px;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
    background:#1844F0;
    color:#fff;
  }
  .login-btn:hover{
    background:#2550ff;
  }

  /* LAYOUT PRINCIPAL */
  .layout{
    display:flex;
    min-height:100vh;
  }

  /* SIDEBAR LATERAL (identidade Magius) */
  .sidebar{
    width:220px;
    background:#051224;
    color:#fff;
    display:flex;
    flex-direction:column;
    padding:16px 12px;
    box-shadow:4px 0 14px rgba(0,0,0,.35);
    transition:width 0.3s ease;
  }
  .sidebar.collapsed{
    width:60px;
    padding:16px 8px;
  }

  .sidebar-logo{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:18px;
    padding:0 4px;
  }
  .sidebar.collapsed .sidebar-logo{
    justify-content:center;
  }
  .sidebar-logo-mark{
    width:30px;
    height:30px;
    border-radius:4px;
    background:#1844F0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:18px;
  }
  .sidebar-logo-text{
    line-height:1.05;
    transition:opacity 0.3s ease;
  }
  .sidebar.collapsed .sidebar-logo-text{
    opacity:0;
    width:0;
    overflow:hidden;
  }
  .sidebar-logo-main{
    font-weight:800;
    font-size:15px;
    letter-spacing:.08em;
  }
  .sidebar-logo-sub{
    font-size:10px;
    text-transform:uppercase;
    opacity:.75;
  }

  .sidebar-menu{
    display:flex;
    flex-direction:column;
    gap:2px;
    margin-top:8px;
  }
  .sidebar-item{
    border:none;
    background:transparent;
    color:#f0f4ff;
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px 10px;
    border-radius:3px;
    cursor:pointer;
    font-size:14px;
    position:relative;
  }
  .sidebar-item::before{
    content:"";
    position:absolute;
    left:0;
    top:4px;
    bottom:4px;
    width:3px;
    border-radius:2px;
    background:transparent;
  }
  .sidebar-item:hover{
    background:rgba(255,255,255,.05);
  }
  .sidebar-item.active{
    background:rgba(255,255,255,.06);
    color:#ffffff;
  }
  .sidebar-item.active::before{
    background:#1844F0;
  }
  .sidebar-icon{
    font-size:16px;
    width:20px;
    text-align:center;
    flex-shrink:0;
    opacity:0.9;
    font-weight:400;
  }
  .sidebar-label{
    flex:1;
    text-align:left;
    white-space:nowrap;
    transition:opacity 0.3s ease;
  }
  .sidebar.collapsed .sidebar-label{
    opacity:0;
    width:0;
    overflow:hidden;
  }

  .sidebar-footer{
    margin-top:auto;
    font-size:10px;
    opacity:0.8;
    padding:8px 4px;
    line-height:1.4;
    transition:opacity 0.3s ease;
  }
  .sidebar.collapsed .sidebar-footer{
    opacity:0;
    height:0;
    overflow:hidden;
  }

  /* MAIN / HEADER */

  .main{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#F4F6F9;
  }
  .top-header{
    background:#051224;
    color:#fff;
    padding:10px 24px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .header-left{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .header-circles{
    display:flex;
    gap:6px;
  }
  .header-circles span{
    width:12px;height:12px;border-radius:50%;border:2px solid #fff;
  }
  .header-tagline{
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
  }
  .header-brand{
    text-align:right;
  }
  .header-logo{
    font-size:20px;
    font-weight:800;
    letter-spacing:.12em;
  }
  .header-sub{
    font-size:11px;
    color:#cfe6ff;
  }
  .header-right-wrap{
    display:flex;
    align-items:center;
    gap:24px;
  }
  .header-user{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .header-user-avatar{
    width:32px;
    height:32px;
    border-radius:50%;
    background:#1844F0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:13px;
    font-weight:700;
  }
  .header-user-info{
    display:flex;
    flex-direction:column;
    font-size:11px;
  }
  .header-user-info span:nth-child(2){
    font-size:13px;
    font-weight:600;
  }
  .header-user-actions button{
    padding:4px 8px;
    font-size:11px;
  }

  .main-content{
    padding:16px 24px 32px;
  }

  /* CARDS, FORM, BOT√ïES */

  .card{
    background:#fff;
    border-radius:4px;
    padding:16px 18px 18px;
    box-shadow:0 1px 4px rgba(0,0,0,0.08);
    margin-bottom:10px;
  }
  .screen-title{
    margin:0 0 12px;
    font-size:18px;
    font-weight:700;
  }
  .card-title{
    margin:0 0 10px;
    font-size:15px;
    font-weight:700;
  }

  .form-group{margin-bottom:10px;}
  .form-group label{
    font-weight:600;
    font-size:13px;
    display:block;
    margin-bottom:4px;
  }
  .form-group input[type="text"],
  .form-group input[type="file"],
  .form-group select,
  .form-group textarea{
    width:100%;
    padding:7px 9px;
    border-radius:4px;
    border:1px solid #cbd3e3;
    font-size:13px;
  }
  .form-group textarea{resize:vertical;}
  .form-group.small{max-width:200px;}

  .btn-primary,.btn-secondary{
    border:none;
    border-radius:4px;
    padding:8px 18px;
    font-size:14px;
    cursor:pointer;
    font-weight:600;
  }
  .btn-primary{
    background:#1844F0;
    color:#fff;
  }
  .btn-primary:hover{background:#2550ff;}
  .btn-secondary{
    background:#fff;
    color:#1844F0;
    border:1px solid #1844F0;
  }
  .btn-secondary:hover{background:#eef3ff;}

  .grid-2{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px 16px;
  }
  .grid-3{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px 16px;
  }

  @media (max-width:900px){
    .grid-2,.grid-3{grid-template-columns:1fr;}
    .layout{flex-direction:column;}
    .sidebar{
      flex-direction:row;
      align-items:center;
      width:100%;
      overflow-x:auto;
    }
    .sidebar-menu{
      flex-direction:row;
      margin-left:16px;
    }
    .sidebar-footer{display:none;}
  }

  .screen{display:none;}
  .screen.active{display:block;}

  .mt-8{margin-top:8px;}
  .mt-16{margin-top:16px;}
  .mb-8{margin-bottom:8px;}

  /* CHECKLIST */

  .piece-image-box{
    height:220px;
    border-radius:4px;
    background:#f0f5fa;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top:8px;
    overflow:hidden;
  }
  .piece-image-box img{
    max-width:100%;
    max-height:220px;
    cursor:pointer;
  }
  .checklist-piece-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .checklist-piece-code{
    font-size:20px;
    font-weight:700;
    color:#003366;
  }
  .checklist-piece-desc{
    font-size:13px;
    color:#667;
    margin-top:2px;
  }

  .checklist-item{
    border-radius:4px;
    border:1px solid #d7ddeb;
    background:#fafbff;
    padding:10px;
    display:flex;
    gap:12px;
    margin-top:10px;
  }
  .checklist-item.ok{
    background:#e3fcec;
    border-color:#2ecc71;
  }
  .checklist-item.nok{
    background:#ffe6e8;
    border-color:#E81C24;
  }

  .checklist-item-thumb{
    width:90px;height:90px;border-radius:4px;
    background:#e0e5f0;
    overflow:hidden;
    flex-shrink:0;
  }
  .checklist-item-thumb img{
    width:100%;height:100%;object-fit:cover;cursor:pointer;
  }

  .checklist-item-body{flex:1;}
  .checklist-item-title{
    font-weight:700;
    font-size:14px;
  }
  .checklist-item-desc{
    font-size:12px;
    color:#555;
    margin-top:2px;
  }
  .checklist-item-actions{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .checklist-status-btn{
    border-radius:3px;
    border:none;
    padding:6px 10px;
    font-size:13px;
    cursor:pointer;
    color:#fff;
  }
  .btn-ok{background:#28b649;}
  .btn-nok{background:#E81C24;}

  .checklist-extra{
    margin-top:8px;
    border-radius:4px;
    border:2px solid #E81C24;
    background:#fff6f7;
    padding:8px 10px;
    font-size:12px;
  }
  .checklist-extra label{
    font-weight:600;
    font-size:12px;
  }
  .checklist-extra textarea{
    width:100%;
    min-height:60px;
    margin-top:4px;
    margin-bottom:6px;
  }

  .checklist-nok-library{
    background:#f7edf0;
    border-radius:4px;
    padding:10px 12px;
  }
  .checklist-nok-title{
    font-weight:700;
    color:#b02a3a;
    margin-bottom:8px;
  }
  .checklist-nok-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .checklist-nok-card{
    width:230px;
    border-radius:4px;
    background:#fff;
    border:2px solid #E81C24;
    padding:8px;
    font-size:11px;
  }
  .checklist-nok-card img{
    width:100%;
    height:120px;
    object-fit:cover;
    border-radius:4px;
    margin-top:4px;
    cursor:pointer;
  }

  /* INSPETORES */

  .inspectors-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .inspector-card{
    width:210px;
    border-radius:4px;
    border:1px solid #d6ddeb;
    padding:10px;
    background:#f9fbff;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .inspector-avatar{
    width:72px;height:72px;border-radius:50%;
    background:#dce3f4;
    overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    font-weight:700;color:#4b5a80;font-size:26px;
  }
  .inspector-avatar img{
    width:100%;height:100%;object-fit:cover;
  }
  .inspector-name{
    font-size:14px;
    font-weight:700;
  }
  .inspector-pin-status{
    font-size:11px;
    color:#555;
  }
  .inspector-actions{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
  }
  .btn-icon{
    border-radius:3px;
    border:none;
    padding:4px 8px;
    font-size:12px;
    cursor:pointer;
  }
  .btn-edit{background:#1844F0;color:#fff;}
  .btn-delete{background:#E81C24;color:#fff;}
  .btn-reset-pin{background:#f0ad4e;color:#fff;}

  /* PE√áAS & ITENS */

  .pieces-list{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .piece-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-radius:4px;
    padding:6px 8px;
    background:#f8faff;
    border:1px solid #dde3f3;
  }
  .piece-row-left{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .piece-thumb{
    width:40px;height:32px;border-radius:4px;
    background:#e0e5f0;
    overflow:hidden;
  }
  .piece-thumb img{
    width:100%;height:100%;object-fit:cover;
  }
  .piece-label{
    font-size:13px;
    font-weight:600;
  }

  .piece-item-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 6px;
    border-radius:4px;
    border:1px solid #e0e3f0;
    background:#f9fbff;
    margin-bottom:4px;
  }
  .piece-item-main{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .piece-item-thumb{
    width:26px;height:26px;border-radius:3px;
    background:#e0e5f0;
    overflow:hidden;
  }
  .piece-item-thumb img{
    width:100%;height:100%;object-fit:cover;
  }

  /* DASHBOARD & RELAT√ìRIOS */

  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px;
  }
  .kpi-card{
    border-radius:4px;
    padding:10px 12px;
    background:#f8faff;
    border:1px solid #dde3f3;
  }
  .kpi-card.kpi-large{grid-column:span 1;}
  .kpi-label{
    font-size:12px;
    color:#555;
    margin-bottom:4px;
  }
  .kpi-value{
    font-size:22px;
    font-weight:800;
    color:#003366;
  }
  .kpi-list{
    font-size:12px;
    margin-top:4px;
  }
  .kpi-list div{margin-bottom:2px;}

  .chart-wrapper{
    display:flex;
    justify-content:center;
    padding:6px 0 10px;
    min-height:200px;
    position:relative;
  }
  .chart-wrapper canvas{
    max-height:200px;
  }

  .report-controls{
    display:flex;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
  }
  .report-total{
    font-weight:600;
    font-size:14px;
  }
  .history-table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .history-table thead{background:#dde7f3;}
  .history-table th,
  .history-table td{
    border:1px solid #c8d3e6;
    padding:6px 8px;
    text-align:left;
  }

  /* BIBLIOTECA DE INSPE√á√ïES */

  .biblioteca-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
    gap:16px;
    margin-top:16px;
  }
  .biblioteca-card{
    border-radius:4px;
    border:1px solid #d6ddeb;
    padding:12px;
    background:#f9fbff;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .biblioteca-card-title{
    font-size:15px;
    font-weight:700;
    color:#003366;
  }
  .biblioteca-media-box{
    width:100%;
    aspect-ratio:16/9;
    background:#e0e5f0;
    border-radius:4px;
    overflow:hidden;
    cursor:pointer;
    position:relative;
  }
  .biblioteca-media-box:hover{
    opacity:0.9;
  }
  .biblioteca-media-box video,
  .biblioteca-media-box img{
    width:100%;
    height:100%;
    object-fit:contain;
  }
  .biblioteca-play-overlay{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.7);
    color:#fff;
    border-radius:50%;
    width:60px;
    height:60px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:30px;
    pointer-events:none;
  }
  .biblioteca-media-modal{
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.9);
    z-index:10000;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .biblioteca-media-modal-content{
    max-width:90vw;
    max-height:90vh;
    position:relative;
  }
  .biblioteca-media-modal video,
  .biblioteca-media-modal img{
    max-width:100%;
    max-height:90vh;
    display:block;
  }
  .biblioteca-media-modal-close{
    position:absolute;
    top:-40px;
    right:0;
    background:#fff;
    border:none;
    border-radius:50%;
    width:36px;
    height:36px;
    font-size:24px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#003366;
  }
  .biblioteca-media-modal-close:hover{
    background:#e0e5f0;
  }
  .biblioteca-actions{
    display:flex;
    gap:6px;
    margin-top:4px;
  }
  .biblioteca-materials-count{
    position:absolute;
    top:8px;
    right:8px;
    background:rgba(0,51,102,0.9);
    color:#fff;
    padding:4px 10px;
    border-radius:12px;
    font-size:12px;
    font-weight:600;
  }
  .biblioteca-materials-modal{
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.85);
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:40px 20px 20px;
    overflow-y:auto;
  }
  .biblioteca-materials-modal-content{
    background:#fff;
    border-radius:8px;
    max-width:900px;
    width:100%;
    max-height:90vh;
    overflow-y:auto;
    position:relative;
  }
  .biblioteca-materials-modal-header{
    padding:20px;
    border-bottom:1px solid #d6ddeb;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    background:#fff;
    z-index:1;
  }
  .biblioteca-materials-modal-title{
    font-size:18px;
    font-weight:700;
    color:#003366;
  }
  .biblioteca-materials-modal-close-btn{
    background:none;
    border:none;
    font-size:28px;
    cursor:pointer;
    color:#666;
    padding:0;
    width:32px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .biblioteca-materials-modal-close-btn:hover{
    color:#003366;
  }
  .biblioteca-materials-modal-body{
    padding:20px;
  }
  .biblioteca-materials-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
    gap:16px;
  }
  .biblioteca-material-item{
    border:1px solid #d6ddeb;
    border-radius:4px;
    overflow:hidden;
    cursor:pointer;
    position:relative;
  }
  .biblioteca-material-item:hover{
    box-shadow:0 2px 8px rgba(0,51,102,0.15);
  }
  .biblioteca-material-thumb{
    width:100%;
    aspect-ratio:16/9;
    background:#e0e5f0;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .biblioteca-material-thumb video,
  .biblioteca-material-thumb img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .biblioteca-material-type-badge{
    position:absolute;
    bottom:8px;
    left:8px;
    background:rgba(0,0,0,0.7);
    color:#fff;
    padding:4px 8px;
    border-radius:4px;
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
  }

  /* MODAL */

  .modal-overlay{
    position:fixed;inset:0;
    background:rgba(0,0,0,0.4);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .modal-box{
    background:#fff;
    border-radius:6px;
    padding:16px 18px 18px;
    max-width:420px;
    width:100%;
    box-shadow:0 6px 20px rgba(0,0,0,0.25);
  }
  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .modal-title{
    font-size:16px;
    font-weight:700;
  }
  .modal-close-btn{
    border:none;
    background:transparent;
    font-size:22px;
    cursor:pointer;
  }

  .divider{border-bottom:1px solid #e0e4f0;}
  .hide{display:none!important;}
  </style>
</head>
<body>

  <!-- TELA DE LOGIN -->
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <div class="login-header">
        <div>
          <div class="login-logo">MAGIUS</div>
          <div class="login-sub">Metal√∫rgica Industrial</div>
        </div>
      </div>
      <div class="login-title">Checklist de Inspe√ß√£o</div>
      <div class="login-help">
        Acesse como <strong>Inspetor</strong> (PIN) ou <strong>Admin</strong> (senha da Qualidade).
      </div>

      <div id="login-error" class="login-error"></div>

      <div class="login-mode-toggle">
        <button type="button" class="login-mode-btn active" data-mode="inspector">Inspetor</button>
        <button type="button" class="login-mode-btn" data-mode="admin">Admin</button>
      </div>

      <form id="login-form">
        <div id="login-inspector-fields">
          <div class="login-form-group">
            <label for="login-insp-select">Inspetor</label>
            <select id="login-insp-select">
              <option value="" disabled selected>Selecione o inspetor</option>
            </select>
          </div>
          <div class="login-form-group">
            <label for="login-insp-pin">PIN (4 d√≠gitos)</label>
            <input type="password" id="login-insp-pin" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>

        <div id="login-admin-fields" style="display:none;">
          <div class="login-form-group">
            <label for="login-admin-pin">Senha do administrador</label>
            <input type="password" id="login-admin-pin" placeholder="Digite a senha">
          </div>
        </div>

        <button type="submit" class="login-btn">Entrar</button>
      </form>
    </div>
  </div>

  <!-- APLICA√á√ÉO PRINCIPAL -->
  <div id="app-root" class="layout" style="display:none;">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-mark">M</div>
        <div class="sidebar-logo-text">
          <div class="sidebar-logo-main">MAGIUS</div>
          <div class="sidebar-logo-sub">Checklist</div>
        </div>
      </div>

      <nav class="sidebar-menu">
        <button class="sidebar-item active" data-screen="checklist" onclick="selectSidebar('checklist')">
          <span class="sidebar-icon">‚òë</span>
          <span class="sidebar-label">Checklist</span>
        </button>
        <button class="sidebar-item" data-screen="inspectors" onclick="selectSidebar('inspectors')">
          <span class="sidebar-icon">üë•</span>
          <span class="sidebar-label">Inspetores</span>
        </button>
        <button class="sidebar-item" data-screen="pieces" onclick="selectSidebar('pieces')">
          <span class="sidebar-icon">‚öô</span>
          <span class="sidebar-label">Pe√ßas & Itens</span>
        </button>
        <button class="sidebar-item" data-screen="dashboard" onclick="selectSidebar('dashboard')">
          <span class="sidebar-icon">‚ñ§</span>
          <span class="sidebar-label">Dashboard</span>
        </button>
        <button class="sidebar-item" data-screen="reports" onclick="selectSidebar('reports')">
          <span class="sidebar-icon">üìù</span>
          <span class="sidebar-label">Relat√≥rios</span>
        </button>
        <button class="sidebar-item" data-screen="biblioteca" onclick="selectSidebar('biblioteca')" aria-label="Ir para p√°gina de Biblioteca de Inspe√ß√µes">
          <span class="sidebar-icon">‚ñ∂</span>
          <span class="sidebar-label">Biblioteca de Inspe√ß√µes</span>
        </button>
        <button class="sidebar-item" data-screen="settings" onclick="selectSidebar('settings')" aria-label="Ir para p√°gina de Configura√ß√µes">
          <span class="sidebar-icon">‚öô</span>
          <span class="sidebar-label">Configura√ß√µes</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        Ajudando a construir,<br>
        cultivar, transportar e<br>
        seguir em frente.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="top-header">
        <div class="header-left">
          <div class="header-circles"><span></span><span></span><span></span><span></span></div>
          <div class="header-tagline">
            AJUDANDO A CONSTRUIR, CULTIVAR,<br>TRANSPORTAR E SEGUIR EM FRENTE
          </div>
        </div>
        <div class="header-right-wrap">
          <div class="header-brand">
            <div class="header-logo">MAGIUS</div>
            <div class="header-sub">METAL√öRGICA INDUSTRIAL</div>
          </div>
          <div id="header-user" class="header-user"></div>
        </div>
      </header>

      <div class="main-content">

        <!-- TELA: CHECKLIST -->
        <section id="checklist" class="screen active">
          <div class="card" id="piece-selection-card">
            <h2 class="screen-title">Checklist de Inspe√ß√£o</h2>
            <div class="form-group">
              <label for="piece-selector">Selecione a pe√ßa para inspe√ß√£o</label>
              <select id="piece-selector">
                <option value="" disabled selected>Selecionar pe√ßa</option>
              </select>
            </div>
          </div>

          <div id="checklist-execution" class="card mt-16 hide">
            <div class="checklist-piece-header">
              <div>
                <div class="checklist-piece-code" id="cl-piece-code"></div>
                <div class="checklist-piece-desc" id="cl-piece-desc"></div>
              </div>
            </div>
            <div id="cl-piece-info" style="margin-top:8px;padding:12px;background:#f0f4f8;border-radius:6px;border:1px solid #c8d3e6;">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:14px;">
                <div><strong>Cliente:</strong> <span id="cl-piece-client"></span></div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="font-size:13px;font-weight:600;color:#003366;">Esta√ß√£o/Linha:</label>
                  <select id="cl-piece-station-select" style="padding:6px;border:1px solid #c8d3e6;border-radius:4px;font-size:13px;">
                    <option value="">Selecione a esta√ß√£o</option>
                  </select>
                </div>
              </div>
            </div>
            <div id="cl-piece-image-box" class="piece-image-box">[Imagem da pe√ßa]</div>
            <div id="piece-serial-number-section" style="margin-top:16px;margin-bottom:16px;"></div>
            <div id="checklist-item-list"></div>
            <div style="display:flex;gap:12px;margin-top:16px;">
              <button class="btn-secondary" id="btn-cancel-checklist">Cancelar</button>
              <button class="btn-primary" style="flex:1;" id="btn-finish-checklist">Finalizar inspe√ß√£o</button>
            </div>
            <div id="checklist-nok-library" class="checklist-nok-library mt-16"></div>
          </div>
        </section>

        <!-- TELA: INSPETORES -->
        <section id="inspectors" class="screen">
          <div class="card">
            <h2 class="screen-title">Cadastro de Inspetores</h2>
            <div class="grid-3">
              <div class="form-group">
                <label for="insp-name-input">Nome do inspetor</label>
                <input type="text" id="insp-name-input" placeholder="Ex: Jo√£o Silva">
              </div>
              <div class="form-group">
                <label for="insp-shift-input">Turno</label>
                <select id="insp-shift-input">
                  <option value="">Selecione o turno</option>
                  <option value="1¬∫ Turno">1¬∫ Turno</option>
                  <option value="2¬∫ Turno">2¬∫ Turno</option>
                  <option value="3¬∫ Turno">3¬∫ Turno</option>
                  <option value="Administrativo">Administrativo</option>
                </select>
              </div>
              <div class="form-group">
                <label for="insp-photo-input">Foto do inspetor</label>
                <input type="file" id="insp-photo-input" accept="image/*">
              </div>
            </div>
            <button class="btn-primary" id="btn-add-inspector">Adicionar inspetor</button>
          </div>

          <div class="card mt-16">
            <h3 class="card-title">Inspetores cadastrados</h3>
            <div id="inspectors-list" class="inspectors-grid"></div>
          </div>
        </section>

        <!-- TELA: PE√áAS & ITENS -->
        <section id="pieces" class="screen">
          <div class="card">
            <h2 class="screen-title">Cadastro de Pe√ßas</h2>
            <div class="grid-3">
              <div class="form-group">
                <label for="piece-code-input">C√≥digo da pe√ßa</label>
                <input type="text" id="piece-code-input" placeholder="597-2445#01">
              </div>
              <div class="form-group">
                <label for="piece-desc-input">Descri√ß√£o</label>
                <input type="text" id="piece-desc-input" placeholder="Longarina">
              </div>
              <div class="form-group">
                <label for="piece-client-input">Cliente</label>
                <select id="piece-client-input">
                  <option value="">Selecione o cliente</option>
                  <option value="AGCO Canoas">AGCO Canoas</option>
                  <option value="AGCO Mogi">AGCO Mogi</option>
                  <option value="AGCO Santa Rosa">AGCO Santa Rosa</option>
                  <option value="Agritech Indaiatuba">Agritech Indaiatuba</option>
                  <option value="Caterpillar Campo Largo">Caterpillar Campo Largo</option>
                  <option value="Caterpillar Piracicaba">Caterpillar Piracicaba</option>
                  <option value="Caterpillar Piracicaba Reposi√ß√£o">Caterpillar Piracicaba Reposi√ß√£o</option>
                  <option value="CNH Curitiba">CNH Curitiba</option>
                  <option value="CNH Reposi√ß√£o Sorocaba">CNH Reposi√ß√£o Sorocaba</option>
                  <option value="CNH Sorocaba">CNH Sorocaba</option>
                  <option value="DAF Ponta Grossa">DAF Ponta Grossa</option>
                  <option value="Dana Industrias">Dana Industrias</option>
                  <option value="Deere Hitachi ‚Äì Indaiatuba">Deere Hitachi ‚Äì Indaiatuba</option>
                  <option value="Flamma">Flamma</option>
                  <option value="Gedore">Gedore</option>
                  <option value="GTS">GTS</option>
                  <option value="Horsch do Brasil">Horsch do Brasil</option>
                  <option value="Iveco Sete Lagoas">Iveco Sete Lagoas</option>
                  <option value="John Deere Catal√£o">John Deere Catal√£o</option>
                  <option value="John Deere Horizontina">John Deere Horizontina</option>
                  <option value="John Deere Indaiatuba">John Deere Indaiatuba</option>
                  <option value="John Deere Montenegro">John Deere Montenegro</option>
                  <option value="John Deere Reposi√ß√£o Campinas">John Deere Reposi√ß√£o Campinas</option>
                  <option value="Landini ‚Äì Contagem / MG">Landini ‚Äì Contagem / MG</option>
                  <option value="Maxion Cruzeiro">Maxion Cruzeiro</option>
                  <option value="Mercedes Juiz de Fora">Mercedes Juiz de Fora</option>
                  <option value="Mercedes S√£o Bernardo do Campo">Mercedes S√£o Bernardo do Campo</option>
                  <option value="Metalsa Campo Largo">Metalsa Campo Largo</option>
                  <option value="Metalsa Osasco">Metalsa Osasco</option>
                  <option value="MWM">MWM</option>
                  <option value="Renault SJP">Renault SJP</option>
                  <option value="Scania Reposi√ß√£o Vinhedos">Scania Reposi√ß√£o Vinhedos</option>
                  <option value="Scania S√£o Bernardo do Campo">Scania S√£o Bernardo do Campo</option>
                  <option value="Solinftec">Solinftec</option>
                  <option value="Tatu">Tatu</option>
                  <option value="Volvo CE Pederneiras">Volvo CE Pederneiras</option>
                  <option value="Volvo Curitiba">Volvo Curitiba</option>
                  <option value="Volvo Pederneiras">Volvo Pederneiras</option>
                  <option value="Volvo Reposi√ß√£o">Volvo Reposi√ß√£o</option>
                </select>
              </div>
            </div>
            <div class="grid-3">
              <div class="form-group">
                <label for="piece-image-input">Imagem da pe√ßa</label>
                <input type="file" id="piece-image-input" accept="image/*">
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="piece-has-serial-input">
                  Pe√ßa possui serial number?
                </label>
              </div>
            </div>
            <button class="btn-primary" id="btn-add-piece">Adicionar pe√ßa</button>
          </div>

          <div class="grid-2 mt-16">
            <div class="card">
              <h3 class="card-title">Pe√ßas cadastradas</h3>
              <div id="pieces-list" class="pieces-list"></div>
            </div>
            <div class="card">
              <h3 class="card-title">Itens de checklist da pe√ßa</h3>
              <div class="form-group">
                <label for="piece-items-selector">Selecionar pe√ßa</label>
                <select id="piece-items-selector"></select>
              </div>
              <div id="piece-items-list"></div>
              <div class="divider mt-8 mb-8"></div>
              <div class="form-group">
                <label for="item-name-input">Novo item</label>
                <input type="text" id="item-name-input" placeholder="Ex: Dimens√£o A (√ò)">
              </div>
              <div class="form-group">
                <label for="item-desc-input">Descri√ß√£o do item</label>
                <textarea id="item-desc-input" rows="2" placeholder="Descreva o que deve ser verificado"></textarea>
              </div>
              <div class="form-group">
                <label for="item-failure-mode-input">Modo de falha</label>
                <select id="item-failure-mode-input">
                  <option value="">Selecione o modo de falha</option>
                  <option value="√Çngulo fora do especificado">√Çngulo fora do especificado</option>
                  <option value="Backlog interno">Backlog interno</option>
                  <option value="Borra de e-coat">Borra de e-coat</option>
                  <option value="Camada fora do especificado">Camada fora do especificado</option>
                  <option value="Componente soldado deslocado">Componente soldado deslocado</option>
                  <option value="Componente soldado invertido">Componente soldado invertido</option>
                  <option value="Comprimento do cord√£o de solda fora do especificado">Comprimento do cord√£o de solda fora do especificado</option>
                  <option value="Contamina√ß√£o">Contamina√ß√£o</option>
                  <option value="Corpo ou cabeceira invertida">Corpo ou cabeceira invertida</option>
                  <option value="Cravamento irregular ‚Äì parafuso / porca / pino / porca">Cravamento irregular ‚Äì parafuso / porca / pino / porca</option>
                  <option value="Dimensional fora do especificado">Dimensional fora do especificado</option>
                  <option value="Dobra invertida">Dobra invertida</option>
                  <option value="Emenda deficiente">Emenda deficiente</option>
                  <option value="Espa√ßamento entre componentes">Espa√ßamento entre componentes</option>
                  <option value="Excesso de p√≥">Excesso de p√≥</option>
                  <option value="Falha no corte da pe√ßa">Falha no corte da pe√ßa</option>
                  <option value="Falha no mascaramento / prote√ß√£o">Falha no mascaramento / prote√ß√£o</option>
                  <option value="Falta de cord√£o de solda">Falta de cord√£o de solda</option>
                  <option value="Falta de cura">Falta de cura</option>
                  <option value="Falta de opera√ß√£o (rosca, chanfro, furo, montagem)">Falta de opera√ß√£o (rosca, chanfro, furo, montagem)</option>
                  <option value="Falta de penetra√ß√£o de solda">Falta de penetra√ß√£o de solda</option>
                  <option value="Ficha tratamento superficial FTS errada">Ficha tratamento superficial FTS errada</option>
                  <option value="Gap">Gap</option>
                  <option value="Grava√ß√£o fora do especificado">Grava√ß√£o fora do especificado</option>
                  <option value="Identifica√ß√£o incorreta">Identifica√ß√£o incorreta</option>
                  <option value="Inclus√£o de arame de solda">Inclus√£o de arame de solda</option>
                  <option value="Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega">Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega</option>
                  <option value="M√° forma√ß√£o do rebite">M√° forma√ß√£o do rebite</option>
                  <option value="Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)">Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)</option>
                  <option value="Montagem incorreta">Montagem incorreta</option>
                  <option value="Mordedura">Mordedura</option>
                  <option value="Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)">Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)</option>
                  <option value="Oxida√ß√£o">Oxida√ß√£o</option>
                  <option value="Pe√ßas com componentes fora do especificado">Pe√ßas com componentes fora do especificado</option>
                  <option value="Pe√ßas com trincas">Pe√ßas com trincas</option>
                  <option value="Pe√ßas danificadas em processo (marcas e riscos, etc.)">Pe√ßas danificadas em processo (marcas e riscos, etc.)</option>
                  <option value="Pe√ßas faltando componentes">Pe√ßas faltando componentes</option>
                  <option value="Pe√ßas misturadas">Pe√ßas misturadas</option>
                  <option value="Perna da solda filete abaixo da medida">Perna da solda filete abaixo da medida</option>
                  <option value="Pintura escorrida">Pintura escorrida</option>
                  <option value="Pintura com casca de laranja">Pintura com casca de laranja</option>
                  <option value="Pintura cratera">Pintura cratera</option>
                  <option value="Pintura com desplacamento">Pintura com desplacamento</option>
                  <option value="Pintura com olho de peixe">Pintura com olho de peixe</option>
                  <option value="Pintura com sujeira">Pintura com sujeira</option>
                  <option value="Pintura danificada">Pintura danificada</option>
                  <option value="Pintura falhada">Pintura falhada</option>
                  <option value="Pintura fervida">Pintura fervida</option>
                  <option value="Plano de embalagem fora do especificado">Plano de embalagem fora do especificado</option>
                  <option value="Porosidade">Porosidade</option>
                  <option value="Rebarbas">Rebarbas</option>
                  <option value="Respingos">Respingos</option>
                  <option value="Rosca danificada">Rosca danificada</option>
                  <option value="Roscas / furos com tinta e/ou sujeiras">Roscas / furos com tinta e/ou sujeiras</option>
                  <option value="Solda com sobreposi√ß√£o">Solda com sobreposi√ß√£o</option>
                </select>
              </div>
              <div class="form-group">
                <label for="item-image-input">Imagem do item</label>
                <input type="file" id="item-image-input" accept="image/*">
              </div>
              <button class="btn-primary" id="btn-add-item">Adicionar item</button>
            </div>
          </div>
        </section>

        <!-- TELA: DASHBOARD -->
        <section id="dashboard" class="screen">
          <div class="card">
            <h2 class="screen-title">Dashboard ‚Äì Resultados de Inspe√ß√£o</h2>
            
            <!-- Filtros -->
            <div class="dashboard-filters" style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;padding:12px;background:#f8faff;border-radius:6px;">
              <div class="form-group" style="margin:0;min-width:150px;">
                <label style="font-size:12px;margin-bottom:4px;">Data In√≠cio</label>
                <input type="date" id="filter-date-start" style="padding:6px 8px;font-size:13px;border:1px solid #cbd3e3;border-radius:4px;width:100%;">
              </div>
              <div class="form-group" style="margin:0;min-width:150px;">
                <label style="font-size:12px;margin-bottom:4px;">Data Fim</label>
                <input type="date" id="filter-date-end" style="padding:6px 8px;font-size:13px;border:1px solid #cbd3e3;border-radius:4px;width:100%;">
              </div>
              <div class="form-group" style="margin:0;min-width:150px;">
                <label style="font-size:12px;margin-bottom:4px;">Cliente</label>
                <select id="filter-client" style="padding:6px 8px;font-size:13px;border:1px solid #cbd3e3;border-radius:4px;width:100%;">
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="form-group" style="margin:0;min-width:150px;">
                <label style="font-size:12px;margin-bottom:4px;">Pe√ßa</label>
                <select id="filter-item" style="padding:6px 8px;font-size:13px;border:1px solid #cbd3e3;border-radius:4px;width:100%;">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="form-group" style="margin:0;min-width:150px;">
                <label style="font-size:12px;margin-bottom:4px;">Modo de Falha</label>
                <select id="filter-failure-mode" style="padding:6px 8px;font-size:13px;border:1px solid #cbd3e3;border-radius:4px;width:100%;">
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="form-group" style="margin:0;min-width:150px;">
                <label style="font-size:12px;margin-bottom:4px;">Inspetor</label>
                <select id="filter-inspector" style="padding:6px 8px;font-size:13px;border:1px solid #cbd3e3;border-radius:4px;width:100%;">
                  <option value="">Todos</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end;">
                <button class="btn-primary" id="btn-apply-filters" style="padding:6px 16px;font-size:13px;">Aplicar Filtros</button>
              </div>
            </div>

            <!-- KPIs -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px;">
              <div class="kpi-card">
                <div class="kpi-label">Total de Inspe√ß√µes</div>
                <div class="kpi-value" id="kpi-total-inspecoes">0</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Pe√ßas Aprovadas</div>
                <div class="kpi-value" style="color:#28b649;" id="kpi-aprovados">0</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Pe√ßas Reprovadas</div>
                <div class="kpi-value" style="color:#E81C24;" id="kpi-reprovados">0</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">% Defeitos</div>
                <div class="kpi-value" id="kpi-percent-defeitos">0%</div>
              </div>
            </div>

            <!-- Status de Inspe√ß√£o (Gr√°fico de Rosca) -->
            <div style="margin-bottom:16px;">
              <h3 class="card-title" style="margin-bottom:12px;">Status de Inspe√ß√£o</h3>
              <div style="max-width:400px;margin:0 auto;">
                <canvas id="dashboard-chart" width="400" height="200"></canvas>
              </div>
            </div>

            <!-- Volume Mensal de Inspe√ß√µes -->
            <div style="margin-bottom:16px;">
              <h3 class="card-title" style="margin-bottom:12px;">Volume Mensal de Inspe√ß√µes</h3>
              <div style="max-width:800px;margin:0 auto;">
                <canvas id="chart-monthly-volume" width="800" height="300"></canvas>
              </div>
            </div>
          </div>

          <!-- Gr√°ficos de Defeitos -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px;">
            <div class="card" style="padding:16px;">
              <h3 class="card-title" style="font-size:14px;margin-bottom:8px;">Defeitos por Esta√ß√£o</h3>
              <div class="chart-wrapper">
                <canvas id="chart-by-station" width="280" height="180"></canvas>
              </div>
            </div>
            <div class="card" style="padding:16px;">
              <h3 class="card-title" style="font-size:14px;margin-bottom:8px;">Defeitos por Cliente</h3>
              <div class="chart-wrapper">
                <canvas id="chart-by-client" width="280" height="180"></canvas>
              </div>
            </div>
            <div class="card" style="padding:16px;">
              <h3 class="card-title" style="font-size:14px;margin-bottom:8px;">Defeitos por Modo de Falha</h3>
              <div class="chart-wrapper">
                <canvas id="chart-by-failure" width="280" height="180"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- TELA: RELAT√ìRIOS -->
        <section id="reports" class="screen">
          <div class="card">
            <h2 class="screen-title">Relat√≥rios</h2>
            <div class="report-controls">
              <button class="btn-secondary" id="btn-export-csv">Exportar CSV</button>
              <div class="form-group small">
                <label for="report-month-select">M√™s:</label>
                <select id="report-month-select"></select>
              </div>
              <div class="report-total">
                Total inspe√ß√µes: <span id="total-inspecoes">0</span>
              </div>
            </div>
          </div>

          <div class="card mt-16">
            <h3 class="card-title">Hist√≥rico de inspe√ß√µes</h3>
            <table class="history-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Inspetor</th>
                  <th>Pe√ßa</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="reports-history-body"></tbody>
            </table>
          </div>
        </section>

        <!-- TELA: BIBLIOTECA DE INSPE√á√ïES -->
        <section id="biblioteca" class="screen">
          <div class="card" id="biblioteca-admin-form">
            <h2 class="screen-title">Biblioteca de Inspe√ß√µes</h2>
            <p id="biblioteca-description" style="font-size:13px;color:#555;margin-bottom:16px;">
              Adicione v√≠deos e imagens de refer√™ncia demonstrando como inspecionar cada pe√ßa. 
              O material serve como treinamento e consulta para os inspetores.
            </p>
            <div class="grid-2">
              <div class="form-group">
                <label for="biblioteca-piece-select">Selecionar pe√ßa *</label>
                <select id="biblioteca-piece-select" aria-required="true" aria-describedby="biblioteca-description">
                  <option value="" disabled selected>Selecione uma pe√ßa</option>
                </select>
              </div>
              <div class="form-group">
                <label for="biblioteca-media-input">V√≠deo, Imagem ou PDF *</label>
<input type="file" id="biblioteca-media-input" accept="video/*,image/*,application/pdf" aria-required="true" aria-describedby="biblioteca-description">
              </div>
            </div>
            <button class="btn-primary" id="btn-add-biblioteca" aria-label="Adicionar material de refer√™ncia √† biblioteca">Adicionar material</button>
          </div>

          <div class="card mt-16">
            <h3 class="card-title">Material de refer√™ncia cadastrado</h3>
            <div id="biblioteca-list" class="biblioteca-grid"></div>
          </div>
        </section>

        <!-- TELA: CONFIGURA√á√ïES -->
        <section id="settings" class="screen">
          <div class="card">
            <h2 class="screen-title">Configura√ß√µes do Sistema</h2>
            <p style="font-size:13px;color:#555;margin-bottom:20px;">
              Gerencie as listas de clientes, modos de falha e esta√ß√µes/linhas usadas no sistema.
            </p>
            
            <!-- Gerenciar Clientes -->
            <div style="margin-bottom:32px;">
              <h3 class="card-title" style="font-size:16px;margin-bottom:12px;">Clientes</h3>
              <div style="display:flex;gap:10px;margin-bottom:12px;">
                <input type="text" id="new-client-input" placeholder="Nome do cliente" style="flex:1;padding:8px 10px;border:1px solid #cbd3e3;border-radius:4px;font-size:13px;">
                <button class="btn-primary" onclick="addClient()" style="padding:8px 16px;">Adicionar</button>
              </div>
              <div id="clients-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:8px;"></div>
            </div>

            <!-- Gerenciar Modos de Falha -->
            <div style="margin-bottom:32px;">
              <h3 class="card-title" style="font-size:16px;margin-bottom:12px;">Modos de Falha</h3>
              <div style="display:flex;gap:10px;margin-bottom:12px;">
                <input type="text" id="new-failure-mode-input" placeholder="Nome do modo de falha" style="flex:1;padding:8px 10px;border:1px solid #cbd3e3;border-radius:4px;font-size:13px;">
                <button class="btn-primary" onclick="addFailureMode()" style="padding:8px 16px;">Adicionar</button>
              </div>
              <div id="failure-modes-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:8px;"></div>
            </div>

            <!-- Gerenciar Esta√ß√µes/Linhas -->
            <div>
              <h3 class="card-title" style="font-size:16px;margin-bottom:12px;">Esta√ß√µes/Linhas</h3>
              <div style="display:flex;gap:10px;margin-bottom:12px;">
                <input type="text" id="new-station-input" placeholder="Nome da esta√ß√£o/linha" style="flex:1;padding:8px 10px;border:1px solid #cbd3e3;border-radius:4px;font-size:13px;">
                <button class="btn-primary" onclick="addStation()" style="padding:8px 16px;">Adicionar</button>
              </div>
              <div id="stations-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:8px;"></div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- MODAL -->
  <div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div id="modal-box" class="modal-box"></div>
  </div>

  <!-- SCRIPT FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAAowsqkoUjIAPhSvq6dUlKMZGdXOO1b0",
      authDomain: "magiuschecklist-9ad0f.firebaseapp.com",
      projectId: "magiuschecklist-9ad0f",
      storageBucket: "magiuschecklist-9ad0f.firebasestorage.app",
      messagingSenderId: "14669686712",
      appId: "1:14669686712:web:1c205b1111cde18379114d",
      measurementId: "G-GQS591WCBD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const auth = getAuth(app);
    signInAnonymously(auth).catch(err => console.warn("Falha auth an√¥nima:", err));
    onAuthStateChanged(auth, user => {
      if (user) console.log("Auth ok:", user.uid);
      else console.log("Auth none");
    });

    async function uploadFileAndGetUrl(path, file) {
      if (!file) return null;
      const ref = sRef(storage, path);
      const metadata = { contentType: file.type || "image/jpeg" };
      await uploadBytes(ref, file, metadata);
      const url = await getDownloadURL(ref);
      return url;
    }

    async function loadAll() {
      const pieces = [];
      let inspectors = [];
      let inspections = [];

      try {
        const piecesSnap = await getDocs(collection(db, "pieces"));
        piecesSnap.docs.forEach(d => {
          const data = d.data();
          pieces.push({
            code: data.code,
            description: data.description,
            client: data.client || "",
            station: data.station || "",
            image: null,
            imageUrl: data.imageUrl || null,
            hasSerialNumber: data.hasSerialNumber || false,
            items: (data.items || []).map(it => ({
              name: it.name,
              description: it.description,
              failureMode: it.failureMode || "",
              image: null,
              imageUrl: it.imageUrl || null
            }))
          });
        });
      } catch (err) {
        console.warn("Erro load pieces:", err);
      }

      try {
        const inspRef = doc(db, "config", "inspectors");
        const inspSnap = await getDoc(inspRef);
        if (inspSnap && inspSnap.exists()) {
          const rawList = inspSnap.data().list || [];
          inspectors = rawList
            .map(i => {
              if (typeof i === "string") {
                return { name: i, pinHash: "" };
              } else {
                return {
                  name: i.name || "",
                  pinHash: i.pinHash || "",
                  photoUrl: i.photoUrl || ""
                };
              }
            })
            .filter(i => i.name);
        }
      } catch (err) {
        console.warn("Erro load inspectors:", err);
      }

      try {
        const inspecSnap = await getDocs(collection(db, "inspections"));
        inspecSnap.docs.forEach(d => {
          const data = d.data();
          inspections.push({
            id: d.id,
            date: data.date,
            inspector: data.inspector,
            piece: data.piece,
            descricao: data.descricao || "",
            itens: (data.itens || []).map(it => ({
              status: it.status,
              motivo: it.motivo,
              encaminhamento: it.encaminhamento,
              nome_terceiro: it.nome_terceiro || "",
              foto: null,
              fotoUrl: it.fotoUrl || null
            }))
          });
        });
      } catch (err) {
        console.warn("Erro load inspections:", err);
      }

      return { pieces, inspectors, inspections };
    }

    async function savePiece(piece) {
      if (!piece || !piece.code) return;
      let imageUrl = piece.imageUrl || null;
      if (piece.image instanceof File) {
        const ext = (piece.image.name && piece.image.name.split(".").pop()) || "jpg";
        imageUrl = await uploadFileAndGetUrl(`pieces/${piece.code}/main_${Date.now()}.${ext}`, piece.image);
      }
      const itemsToSave = [];
      for (let idx = 0; idx < (piece.items || []).length; idx++) {
        const it = piece.items[idx];
        let itemImageUrl = it.imageUrl || null;
        if (it.image instanceof File) {
          const ext = (it.image.name && it.image.name.split(".").pop()) || "jpg";
          itemImageUrl = await uploadFileAndGetUrl(`pieces/${piece.code}/items/${idx}_${Date.now()}.${ext}`, it.image);
        }
        itemsToSave.push({
          name: it.name,
          description: it.description,
          failureMode: it.failureMode || "",
          imageUrl: itemImageUrl
        });
      }
      const ref = doc(db, "pieces", piece.code);
      await setDoc(ref, {
        code: piece.code,
        description: piece.description,
        client: piece.client || "",
        station: piece.station || "",
        hasSerialNumber: piece.hasSerialNumber || false,
        imageUrl,
        items: itemsToSave
      });
    }

    async function deletePiece(code) {
      if (!code) return;
      // Delete the piece
      await deleteDoc(doc(db, "pieces", code));
      
      // Also delete all biblioteca items associated with this piece
      try {
        const bibliotecaSnapshot = await getDocs(collection(db, "biblioteca"));
        const deletePromises = [];
        bibliotecaSnapshot.docs.forEach(d => {
          const data = d.data();
          if (data.piece === code) {
            deletePromises.push(deleteDoc(doc(db, "biblioteca", d.id)));
          }
        });
        await Promise.all(deletePromises);
      } catch (e) {
        console.error("Erro ao deletar materiais da biblioteca:", e);
      }
    }

    async function setInspectors(list) {
      const ref = doc(db, "config", "inspectors");
      await setDoc(ref, { list: list || [] });
    }

    async function saveInspection(inspec) {
      const timeStamp = Date.now();
      const itensToSave = [];
      for (let idx = 0; idx < (inspec.itens || []).length; idx++) {
        const it = inspec.itens[idx];
        let fotoUrl = it.fotoUrl || null;
        if (it.foto instanceof File) {
          const ext = (it.foto.name && it.foto.name.split(".").pop()) || "jpg";
          fotoUrl = await uploadFileAndGetUrl(
            `inspections/${inspec.piece}/${timeStamp}_${idx}.${ext}`,
            it.foto
          );
        }
        itensToSave.push({
          status: it.status,
          motivo: it.motivo,
          encaminhamento: it.encaminhamento,
          nome_terceiro: it.nome_terceiro || "",
          fotoUrl
        });
      }
      const docData = {
        date: inspec.date,
        inspector: inspec.inspector,
        piece: inspec.piece,
        descricao: inspec.descricao || "",
        itens: itensToSave
      };
      const ref = await addDoc(collection(db, "inspections"), docData);
      return { id: ref.id, ...docData };
    }

    async function loadBiblioteca() {
      const items = [];
      try {
        const snapshot = await getDocs(collection(db, "biblioteca"));
        snapshot.docs.forEach(d => {
          const data = d.data();
          items.push({
            id: d.id,
            piece: data.piece || "",
            videoUrl: data.videoUrl || null,
            imageUrl: data.imageUrl || null,
            mediaType: data.mediaType || 'video' // 'video' or 'image'
          });
        });
      } catch (err) {
        console.warn("Erro load biblioteca:", err);
      }
      return items;
    }

    async function saveBibliotecaItem(item) {
      if (!item || !item.piece) return;
      let videoUrl = item.videoUrl || null;
      let imageUrl = item.imageUrl || null;
      let mediaType = item.mediaType || 'video';
      
      if (item.media instanceof File) {
        const ext = (item.media.name && item.media.name.split(".").pop()) || "mp4";
        const sanitizedPiece = item.piece.replace(/[^a-zA-Z0-9]/g, '_');
        const mediaUrl = await uploadFileAndGetUrl(`biblioteca/${sanitizedPiece}_${Date.now()}.${ext}`, item.media);
        
        // Determine if it's video or image based on file type
        if (item.media.type.startsWith('video/')) {
          videoUrl = mediaUrl;
          imageUrl = null;
          mediaType = 'video';
        } else if (item.media.type.startsWith('image/')) {
          imageUrl = mediaUrl;
          videoUrl = null;
          mediaType = 'image';
        }
      }
      
      const docData = {
        piece: item.piece,
        videoUrl,
        imageUrl,
        mediaType
      };
      const ref = await addDoc(collection(db, "biblioteca"), docData);
      return { id: ref.id, ...docData };
    }

    async function deleteBibliotecaItem(id) {
      if (!id) return;
      await deleteDoc(doc(db, "biblioteca", id));
    }

    window.fbApi = { loadAll, savePiece, deletePiece, setInspectors, saveInspection, loadBiblioteca, saveBibliotecaItem, deleteBibliotecaItem };
  </script>

  <!-- SCRIPT PRINCIPAL (UI) -->
  <script>
  const ADMIN_PIN = "qualidade2025";

  // Production data lists
  const PRODUCTION_CLIENTS = [
    "AGCO Canoas",
    "AGCO Mogi",
    "AGCO Santa Rosa",
    "Agritech Indaiatuba",
    "Caterpillar Campo Largo",
    "Caterpillar Piracicaba",
    "Caterpillar Piracicaba Reposi√ß√£o",
    "CNH Curitiba",
    "CNH Reposi√ß√£o Sorocaba",
    "CNH Sorocaba",
    "DAF Ponta Grossa",
    "Dana Industrias",
    "Deere Hitachi ‚Äì Indaiatuba",
    "Flamma",
    "Gedore",
    "GTS",
    "Horsch do Brasil",
    "Iveco Sete Lagoas",
    "John Deere Catal√£o",
    "John Deere Horizontina",
    "John Deere Indaiatuba",
    "John Deere Montenegro",
    "John Deere Reposi√ß√£o Campinas",
    "Landini ‚Äì Contagem / MG",
    "Maxion Cruzeiro",
    "Mercedes Juiz de Fora",
    "Mercedes S√£o Bernardo do Campo",
    "Metalsa Campo Largo",
    "Metalsa Osasco",
    "MWM",
    "Renault SJP",
    "Scania Reposi√ß√£o Vinhedos",
    "Scania S√£o Bernardo do Campo",
    "Solinftec",
    "Tatu",
    "Volvo CE Pederneiras",
    "Volvo Curitiba",
    "Volvo Pederneiras",
    "Volvo Reposi√ß√£o"
  ];

  const PRODUCTION_FAILURE_MODES = [
    "√Çngulo fora do especificado",
    "Backlog interno",
    "Borra de e-coat",
    "Camada fora do especificado",
    "Componente soldado deslocado",
    "Componente soldado invertido",
    "Comprimento do cord√£o de solda fora do especificado",
    "Contamina√ß√£o",
    "Corpo ou cabeceira invertida",
    "Cravamento irregular ‚Äì parafuso / porca / pino / porca",
    "Dimensional fora do especificado",
    "Dobra invertida",
    "Emenda deficiente",
    "Espa√ßamento entre componentes",
    "Excesso de p√≥",
    "Falha no corte da pe√ßa",
    "Falha no mascaramento / prote√ß√£o",
    "Falta de cord√£o de solda",
    "Falta de cura",
    "Falta de opera√ß√£o (rosca, chanfro, furo, montagem)",
    "Falta de penetra√ß√£o de solda",
    "Ficha tratamento superficial FTS errada",
    "Gap",
    "Grava√ß√£o fora do especificado",
    "Identifica√ß√£o incorreta",
    "Inclus√£o de arame de solda",
    "Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega",
    "M√° forma√ß√£o do rebite",
    "Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)",
    "Montagem incorreta",
    "Mordedura",
    "Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)",
    "Oxida√ß√£o",
    "Pe√ßas com componentes fora do especificado",
    "Pe√ßas com trincas",
    "Pe√ßas danificadas em processo (marcas e riscos, etc.)",
    "Pe√ßas faltando componentes",
    "Pe√ßas misturadas",
    "Perna da solda filete abaixo da medida",
    "Pintura escorrida",
    "Pintura com casca de laranja",
    "Pintura cratera",
    "Pintura com desplacamento",
    "Pintura com olho de peixe",
    "Pintura com sujeira",
    "Pintura danificada",
    "Pintura falhada",
    "Pintura fervida",
    "Plano de embalagem fora do especificado",
    "Porosidade",
    "Rebarbas",
    "Respingos",
    "Rosca danificada",
    "Roscas / furos com tinta e/ou sujeiras",
    "Solda com sobreposi√ß√£o"
  ];

  const PRODUCTION_STATIONS = [
    "Solda Rob√¥ 1 / Solda Proje√ß√£o",
    "Jato Autom√°tico",
    "Mesa Desempeno",
    "Tratamento Superficial",
    "Jato",
    "Calibragem / Estanqueidade / Acabamento",
    "Solda Manual / Solda Extra Pesada"
  ];

  // Estado principal
  let pieces = [];
  let inspectors = []; // { name, pinHash, photoUrl? }
  let inspections = [];
  let inspectorPhotos = {}; // nome -> base64 local
  let bibliotecaItems = []; // { id, piece, media?, mediaType?, videoUrl?, imageUrl?, pdfUrl? }

  let currentChecklistPiece = null;
  let checklistItemStates = [];
  let currentPieceSerialNumber = ""; // Serial number for the current piece being inspected
  let currentClient = ""; // Client for current inspection
  let currentStation = ""; // Station for current inspection

  let dashboardChart = null;
  let chartByStation = null;
  let chartByClient = null;
  let chartByFailure = null;
  let chartMonthlyVolume = null;

  let currentUser = null; // { role: "admin"|"inspector", name: string }
  window._appDataLoaded = false;

  // Util: hash SHA-256 para PIN
  async function hashString(str){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const digest = await crypto.subtle.digest("SHA-256", data);
    const bytes = Array.from(new Uint8Array(digest));
    return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // Render select de inspetores no login
  function renderLoginInspectorSelect(){
    const sel = document.getElementById("login-insp-select");
    if(!sel) return;
    sel.innerHTML =
      '<option value="" disabled selected>Selecione o inspetor</option>' +
      inspectors
        .map(i=>`<option value="${i.name}">${i.name}</option>`)
        .join("");
  }

  // Navega√ß√£o entre telas
  function selectSidebar(screenId){
    // Block navigation if checklist is active (checklist execution is visible)
    const checklistExecution = document.getElementById("checklist-execution");
    if(checklistExecution && !checklistExecution.classList.contains("hide")){
      alert("Voc√™ precisa finalizar ou cancelar o checklist atual antes de navegar para outra p√°gina.");
      return;
    }
    
    document.querySelectorAll(".sidebar-item").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.screen===screenId);
    });
    document.querySelectorAll(".screen").forEach(s=>{
      s.classList.toggle("active", s.id===screenId);
    });

    if(screenId==="checklist") renderChecklistSelectors();
    if(screenId==="inspectors") renderInspectors();
    if(screenId==="pieces") renderPieces();
    if(screenId==="reports") renderReports();
    if(screenId==="dashboard") renderDashboard();
    if(screenId==="biblioteca") renderBiblioteca();
    if(screenId==="settings") renderSettings();
  }
  window.selectSidebar = selectSidebar;

  // Modal
  function showModal(html){
    const overlay = document.getElementById("modal-overlay");
    const box = document.getElementById("modal-box");
    box.innerHTML = html;
    overlay.style.display = "flex";
    const closeBtn = box.querySelector(".modal-close-btn");
    if(closeBtn) closeBtn.onclick = closeModal;
    overlay.onclick = e=>{ if(e.target===overlay) closeModal(); };
  }
  function closeModal(){
    const overlay = document.getElementById("modal-overlay");
    const box = document.getElementById("modal-box");
    overlay.style.display="none";
    box.innerHTML="";
  }
  function showImageModal(src){
    if(!src) return;
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Visualizar imagem</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div style="margin-top:8px;text-align:center;">
        <img src="${src}" style="max-width:100%;max-height:70vh;border-radius:6px;">
      </div>
    `);
  }

  // Header - usu√°rio logado
  function updateHeaderUser(){
    const container = document.getElementById("header-user");
    if(!container){ return; }
    if(!currentUser){
      container.innerHTML = "";
      return;
    }
    const initials = currentUser.name
      .split(" ")
      .map(p=>p[0])
      .join("")
      .slice(0,2)
      .toUpperCase();
    const roleLabel = currentUser.role === "admin" ? "Admin" : "Inspetor";

    container.innerHTML = `
      <div class="header-user-avatar">${initials}</div>
      <div class="header-user-info">
        <span>${roleLabel}</span>
        <span>${currentUser.name}</span>
      </div>
      <div class="header-user-actions">
        <button class="btn-secondary" id="btn-change-pin">Alterar PIN</button>
        <button class="btn-secondary" id="btn-logout">Sair</button>
      </div>
    `;

    const btnLogout = document.getElementById("btn-logout");
    if(btnLogout) btnLogout.onclick = logout;

    const btnChange = document.getElementById("btn-change-pin");
    if(btnChange){
      if(currentUser.role === "inspector"){
        btnChange.style.display="inline-block";
        btnChange.onclick = openChangePinModal;
      }else{
        btnChange.style.display="none";
      }
    }
  }

  function updateSidebarForRole(){
    // Hide/show menu items based on user role
    const inspectorsBtn = document.querySelector('[data-screen="inspectors"]');
    const piecesBtn = document.querySelector('[data-screen="pieces"]');
    const settingsBtn = document.querySelector('[data-screen="settings"]');
    
    if(currentUser && currentUser.role === "inspector"){
      // Hide Inspetores, Pe√ßas & Itens, and Configura√ß√µes for inspectors
      if(inspectorsBtn) inspectorsBtn.style.display = "none";
      if(piecesBtn) piecesBtn.style.display = "none";
      if(settingsBtn) settingsBtn.style.display = "none";
    } else {
      // Show all menu items for admins
      if(inspectorsBtn) inspectorsBtn.style.display = "";
      if(piecesBtn) piecesBtn.style.display = "";
      if(settingsBtn) settingsBtn.style.display = "";
    }
  }

  function logout(){
    currentUser = null;
    updateHeaderUser();
    document.getElementById("app-root").style.display="none";
    document.getElementById("login-screen").style.display="flex";

    const loginError = document.getElementById("login-error");
    if(loginError) loginError.style.display="none";
  }

  function openChangePinModal(){
    if(!currentUser || currentUser.role!=="inspector") return;
    const insp = inspectors.find(i=>i.name===currentUser.name);
    if(!insp){
      alert("Inspetor n√£o encontrado.");
      return;
    }
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Alterar PIN</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>PIN atual</label>
        <input type="password" id="pin-current">
      </div>
      <div class="form-group">
        <label>Novo PIN (4 d√≠gitos)</label>
        <input type="password" id="pin-new" maxlength="4">
      </div>
      <div class="form-group">
        <label>Confirmar novo PIN</label>
        <input type="password" id="pin-confirm" maxlength="4">
      </div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="btn-save-pin">Salvar</button>
      </div>
    `);

    document.getElementById("btn-save-pin").addEventListener("click",async()=>{
      const current = document.getElementById("pin-current").value.trim();
      const n1 = document.getElementById("pin-new").value.trim();
      const n2 = document.getElementById("pin-confirm").value.trim();
      if(!current || !n1 || !n2){
        alert("Preencha todos os campos.");
        return;
      }
      if(n1 !== n2){
        alert("Novo PIN e confirma√ß√£o n√£o conferem.");
        return;
      }
      if(n1.length !== 4){
        alert("O PIN deve ter 4 d√≠gitos.");
        return;
      }
      const currentHash = await hashString(current);
      if(insp.pinHash && insp.pinHash !== currentHash){
        alert("PIN atual incorreto.");
        return;
      }
      insp.pinHash = await hashString(n1);
      if(window.fbApi && window.fbApi.setInspectors){
        try{
          await window.fbApi.setInspectors(inspectors);
        }catch(e){
          console.error("Erro salvar PIN:",e);
        }
      }
      alert("PIN alterado com sucesso.");
      closeModal();
      renderInspectors();
    });
  }

  // Helpers de imagem
  function getPieceImageSrc(piece){
    if(!piece) return null;
    if(piece.image instanceof File) return URL.createObjectURL(piece.image);
    return piece.imageUrl || null;
  }
  function getItemImageSrc(item){
    if(!item) return null;
    if(item.image instanceof File) return URL.createObjectURL(item.image);
    return item.imageUrl || null;
  }
  function getStatePhotoSrc(st){
    if(!st) return null;
    if(st.fotoFile instanceof File) return URL.createObjectURL(st.fotoFile);
    return st.fotoUrl || null;
  }

  // Checklist
  function renderChecklistSelectors(){
    const pieceSel = document.getElementById("piece-selector");
    if(!pieceSel) return;
    pieceSel.innerHTML = '<option value="" disabled selected>Selecionar pe√ßa</option>' +
      pieces.map(p=>`<option value="${p.code}">${p.code}</option>`).join("");

    // Always ensure piece selection card is visible and execution is hidden
    const selectionCard = document.getElementById("piece-selection-card");
    const exec = document.getElementById("checklist-execution");
    if(selectionCard) selectionCard.classList.remove("hide");
    if(exec) exec.classList.add("hide");
    
    // Expand sidebar when showing checklist selection
    expandSidebar();
  }

  function startChecklist(){
    if(!currentUser || !currentUser.name){
      alert("Nenhum usu√°rio logado.");
      return;
    }
    const pieceCode = document.getElementById("piece-selector").value;
    
    if(!pieceCode){
      alert("Selecione a pe√ßa.");
      return;
    }
    
    currentChecklistPiece = pieces.find(p=>p.code===pieceCode);
    if(!currentChecklistPiece){
      alert("Pe√ßa n√£o encontrada.");
      return;
    }
    
    // Pull client from piece registration
    currentClient = currentChecklistPiece.client || "";
    currentStation = ""; // Station will be selected during inspection
    
    if(!currentClient){
      alert("A pe√ßa selecionada n√£o possui cliente cadastrado. Por favor, edite a pe√ßa e adicione o cliente.");
      return;
    }
    
    checklistItemStates = (currentChecklistPiece.items||[]).map(()=>({
      status:null,motivo:"",encaminhamento:"",nomeTerceiro:"",
      fotoFile:null,fotoUrl:null,failureMode:""
    }));
    currentPieceSerialNumber = ""; // Reset serial number for new inspection
    
    // Hide piece selection card and show checklist
    document.getElementById("piece-selection-card").classList.add("hide");
    document.getElementById("checklist-execution").classList.remove("hide");
    
    // Collapse sidebar when checklist opens
    collapseSidebar();
    
    renderChecklistExecution();
  }

  function renderChecklistExecution(){
    const piece = currentChecklistPiece;
    if(!piece) return;

    document.getElementById("cl-piece-code").textContent = piece.code;
    document.getElementById("cl-piece-desc").textContent = piece.description || "";
    
    // Display client from piece
    document.getElementById("cl-piece-client").textContent = piece.client || "-";
    
    // Setup station dropdown with dynamic stations
    const stationSelect = document.getElementById("cl-piece-station-select");
    if(stationSelect){
      stationSelect.innerHTML = '<option value="">Selecione a esta√ß√£o</option>' +
        PRODUCTION_STATIONS.map(station => 
          `<option value="${escapeHtml(station)}">${escapeHtml(station)}</option>`
        ).join("");
      stationSelect.value = currentStation || "";
      stationSelect.addEventListener("change",()=>{
        currentStation = stationSelect.value;
      });
    }

    const imgBox = document.getElementById("cl-piece-image-box");
    const mainSrc = getPieceImageSrc(piece);
    if(mainSrc){
      imgBox.innerHTML = `<img src="${mainSrc}" onclick="showImageModal('${mainSrc}')">`;
    }else{
      imgBox.textContent = "[Imagem da pe√ßa]";
    }

    // Show serial number input if piece has serial number
    const serialSection = document.getElementById("piece-serial-number-section");
    if(piece.hasSerialNumber){
      serialSection.innerHTML = `
        <div style="padding:12px;background:#f0f4f8;border-radius:6px;border:1px solid #c8d3e6;">
          <label style="font-size:14px;font-weight:600;color:#003366;display:block;margin-bottom:6px;">Serial Number da Pe√ßa:</label>
          <input type="text" id="piece-serial-input" value="${currentPieceSerialNumber}" placeholder="Digite o serial number da pe√ßa" style="width:100%;padding:8px;border:1px solid #c8d3e6;border-radius:4px;font-size:14px;">
        </div>
      `;
      const serialInput = serialSection.querySelector("#piece-serial-input");
      if(serialInput){
        serialInput.addEventListener("input",()=>{
          currentPieceSerialNumber = serialInput.value;
        });
      }
    }else{
      serialSection.innerHTML = "";
    }

    const listDiv = document.getElementById("checklist-item-list");
    listDiv.innerHTML = "";

    (piece.items||[]).forEach((item,idx)=>{
      const st = checklistItemStates[idx] || {};
      const statusClass = st.status==="OK" ? "ok" : st.status==="NOK" ? "nok" : "";
      const itemSrc = getItemImageSrc(item);
      const wrap = document.createElement("div");
      wrap.className = `checklist-item ${statusClass}`;
      wrap.innerHTML = `
        <div class="checklist-item-thumb">
          ${itemSrc?`<img src="${itemSrc}" onclick="showImageModal('${itemSrc}')">`:``}
        </div>
        <div class="checklist-item-body">
          <div class="checklist-item-title">${item.name}</div>
          <div class="checklist-item-desc">${item.description||""}</div>
          <div class="checklist-item-extra" id="extra-${idx}"></div>
        </div>
        <div class="checklist-item-actions">
          <button class="checklist-status-btn btn-ok" data-idx="${idx}" data-status="OK">OK</button>
          <button class="checklist-status-btn btn-nok" data-idx="${idx}" data-status="NOK">N√ÉO OK</button>
        </div>
      `;
      listDiv.appendChild(wrap);

      if(st.status==="NOK"){
        const extraDiv = wrap.querySelector(`#extra-${idx}`);
        // Support both old (failureModes array) and new (failureMode string) format
        const itemFailureMode = item.failureMode || (item.failureModes && item.failureModes[0]) || "";
        const failureModeOptions = itemFailureMode
          ? `<option value="${itemFailureMode}" ${st.failureMode===itemFailureMode?"selected":""}>${itemFailureMode}</option>`
          : `
            <option value="√Çngulo fora do especificado" ${st.failureMode==="√Çngulo fora do especificado"?"selected":""}>√Çngulo fora do especificado</option>
            <option value="Backlog interno" ${st.failureMode==="Backlog interno"?"selected":""}>Backlog interno</option>
            <option value="Borra de e-coat" ${st.failureMode==="Borra de e-coat"?"selected":""}>Borra de e-coat</option>
            <option value="Camada fora do especificado" ${st.failureMode==="Camada fora do especificado"?"selected":""}>Camada fora do especificado</option>
            <option value="Componente soldado deslocado" ${st.failureMode==="Componente soldado deslocado"?"selected":""}>Componente soldado deslocado</option>
            <option value="Componente soldado invertido" ${st.failureMode==="Componente soldado invertido"?"selected":""}>Componente soldado invertido</option>
            <option value="Comprimento do cord√£o de solda fora do especificado" ${st.failureMode==="Comprimento do cord√£o de solda fora do especificado"?"selected":""}>Comprimento do cord√£o de solda fora do especificado</option>
            <option value="Contamina√ß√£o" ${st.failureMode==="Contamina√ß√£o"?"selected":""}>Contamina√ß√£o</option>
            <option value="Corpo ou cabeceira invertida" ${st.failureMode==="Corpo ou cabeceira invertida"?"selected":""}>Corpo ou cabeceira invertida</option>
            <option value="Cravamento irregular ‚Äì parafuso / porca / pino / porca" ${st.failureMode==="Cravamento irregular ‚Äì parafuso / porca / pino / porca"?"selected":""}>Cravamento irregular ‚Äì parafuso / porca / pino / porca</option>
            <option value="Dimensional fora do especificado" ${st.failureMode==="Dimensional fora do especificado"?"selected":""}>Dimensional fora do especificado</option>
            <option value="Dobra invertida" ${st.failureMode==="Dobra invertida"?"selected":""}>Dobra invertida</option>
            <option value="Emenda deficiente" ${st.failureMode==="Emenda deficiente"?"selected":""}>Emenda deficiente</option>
            <option value="Espa√ßamento entre componentes" ${st.failureMode==="Espa√ßamento entre componentes"?"selected":""}>Espa√ßamento entre componentes</option>
            <option value="Excesso de p√≥" ${st.failureMode==="Excesso de p√≥"?"selected":""}>Excesso de p√≥</option>
            <option value="Falha no corte da pe√ßa" ${st.failureMode==="Falha no corte da pe√ßa"?"selected":""}>Falha no corte da pe√ßa</option>
            <option value="Falha no mascaramento / prote√ß√£o" ${st.failureMode==="Falha no mascaramento / prote√ß√£o"?"selected":""}>Falha no mascaramento / prote√ß√£o</option>
            <option value="Falta de cord√£o de solda" ${st.failureMode==="Falta de cord√£o de solda"?"selected":""}>Falta de cord√£o de solda</option>
            <option value="Falta de cura" ${st.failureMode==="Falta de cura"?"selected":""}>Falta de cura</option>
            <option value="Falta de opera√ß√£o (rosca, chanfro, furo, montagem)" ${st.failureMode==="Falta de opera√ß√£o (rosca, chanfro, furo, montagem)"?"selected":""}>Falta de opera√ß√£o (rosca, chanfro, furo, montagem)</option>
            <option value="Falta de penetra√ß√£o de solda" ${st.failureMode==="Falta de penetra√ß√£o de solda"?"selected":""}>Falta de penetra√ß√£o de solda</option>
            <option value="Ficha tratamento superficial FTS errada" ${st.failureMode==="Ficha tratamento superficial FTS errada"?"selected":""}>Ficha tratamento superficial FTS errada</option>
            <option value="Gap" ${st.failureMode==="Gap"?"selected":""}>Gap</option>
            <option value="Grava√ß√£o fora do especificado" ${st.failureMode==="Grava√ß√£o fora do especificado"?"selected":""}>Grava√ß√£o fora do especificado</option>
            <option value="Identifica√ß√£o incorreta" ${st.failureMode==="Identifica√ß√£o incorreta"?"selected":""}>Identifica√ß√£o incorreta</option>
            <option value="Inclus√£o de arame de solda" ${st.failureMode==="Inclus√£o de arame de solda"?"selected":""}>Inclus√£o de arame de solda</option>
            <option value="Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega" ${st.failureMode==="Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega"?"selected":""}>Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega</option>
            <option value="M√° forma√ß√£o do rebite" ${st.failureMode==="M√° forma√ß√£o do rebite"?"selected":""}>M√° forma√ß√£o do rebite</option>
            <option value="Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)" ${st.failureMode==="Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)"?"selected":""}>Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)</option>
            <option value="Montagem incorreta" ${st.failureMode==="Montagem incorreta"?"selected":""}>Montagem incorreta</option>
            <option value="Mordedura" ${st.failureMode==="Mordedura"?"selected":""}>Mordedura</option>
            <option value="Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)" ${st.failureMode==="Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)"?"selected":""}>Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)</option>
            <option value="Oxida√ß√£o" ${st.failureMode==="Oxida√ß√£o"?"selected":""}>Oxida√ß√£o</option>
            <option value="Pe√ßas com componentes fora do especificado" ${st.failureMode==="Pe√ßas com componentes fora do especificado"?"selected":""}>Pe√ßas com componentes fora do especificado</option>
            <option value="Pe√ßas com trincas" ${st.failureMode==="Pe√ßas com trincas"?"selected":""}>Pe√ßas com trincas</option>
            <option value="Pe√ßas danificadas em processo (marcas e riscos, etc.)" ${st.failureMode==="Pe√ßas danificadas em processo (marcas e riscos, etc.)"?"selected":""}>Pe√ßas danificadas em processo (marcas e riscos, etc.)</option>
            <option value="Pe√ßas faltando componentes" ${st.failureMode==="Pe√ßas faltando componentes"?"selected":""}>Pe√ßas faltando componentes</option>
            <option value="Pe√ßas misturadas" ${st.failureMode==="Pe√ßas misturadas"?"selected":""}>Pe√ßas misturadas</option>
            <option value="Perna da solda filete abaixo da medida" ${st.failureMode==="Perna da solda filete abaixo da medida"?"selected":""}>Perna da solda filete abaixo da medida</option>
            <option value="Pintura escorrida" ${st.failureMode==="Pintura escorrida"?"selected":""}>Pintura escorrida</option>
            <option value="Pintura com casca de laranja" ${st.failureMode==="Pintura com casca de laranja"?"selected":""}>Pintura com casca de laranja</option>
            <option value="Pintura cratera" ${st.failureMode==="Pintura cratera"?"selected":""}>Pintura cratera</option>
            <option value="Pintura com desplacamento" ${st.failureMode==="Pintura com desplacamento"?"selected":""}>Pintura com desplacamento</option>
            <option value="Pintura com olho de peixe" ${st.failureMode==="Pintura com olho de peixe"?"selected":""}>Pintura com olho de peixe</option>
            <option value="Pintura com sujeira" ${st.failureMode==="Pintura com sujeira"?"selected":""}>Pintura com sujeira</option>
            <option value="Pintura danificada" ${st.failureMode==="Pintura danificada"?"selected":""}>Pintura danificada</option>
            <option value="Pintura falhada" ${st.failureMode==="Pintura falhada"?"selected":""}>Pintura falhada</option>
            <option value="Pintura fervida" ${st.failureMode==="Pintura fervida"?"selected":""}>Pintura fervida</option>
            <option value="Plano de embalagem fora do especificado" ${st.failureMode==="Plano de embalagem fora do especificado"?"selected":""}>Plano de embalagem fora do especificado</option>
            <option value="Porosidade" ${st.failureMode==="Porosidade"?"selected":""}>Porosidade</option>
            <option value="Rebarbas" ${st.failureMode==="Rebarbas"?"selected":""}>Rebarbas</option>
            <option value="Respingos" ${st.failureMode==="Respingos"?"selected":""}>Respingos</option>
            <option value="Rosca danificada" ${st.failureMode==="Rosca danificada"?"selected":""}>Rosca danificada</option>
            <option value="Roscas / furos com tinta e/ou sujeiras" ${st.failureMode==="Roscas / furos com tinta e/ou sujeiras"?"selected":""}>Roscas / furos com tinta e/ou sujeiras</option>
            <option value="Solda com sobreposi√ß√£o" ${st.failureMode==="Solda com sobreposi√ß√£o"?"selected":""}>Solda com sobreposi√ß√£o</option>
          `;
        
        extraDiv.innerHTML = `
          <div class="checklist-extra">
            <label>Modo de falha (obrigat√≥rio):</label>
            <select id="failure-mode-${idx}" style="width:100%;padding:6px 8px;margin-top:4px;margin-bottom:6px;border:1px solid #cbd3e3;border-radius:4px;font-size:13px;max-height:150px;overflow-y:auto;">
              <option value="">Selecione o modo de falha</option>
              ${failureModeOptions}
            </select>

            <label>Descri√ß√£o da n√£o conformidade (obrigat√≥rio):</label>
            <textarea id="motivo-${idx}">${st.motivo||""}</textarea>

            <label>Foto (obrigat√≥rio):</label>
            <input type="file" id="foto-${idx}" accept="image/*">

            <div style="margin-top:6px;">
              <label><input type="radio" name="enc-${idx}" value="retrabalho" ${st.encaminhamento==="retrabalho"?"checked":""}> Encaminhar para retrabalho</label><br>
              <label><input type="radio" name="enc-${idx}" value="terceiro" ${st.encaminhamento==="terceiro"?"checked":""}> Aprovado por terceiro</label>
            </div>
            ${st.encaminhamento==="retrabalho" ? `
              <div style="margin-top:6px;">
                <label>Numero da op de retrabalho:</label>
                <input type="number" id="retrabalho-desc-${idx}" value="${st.descricaoRetrabalho||""}" style="width:100%;padding:8px;margin-top:4px;border:1px solid #cbd3e3;border-radius:4px;font-size:13px;">
              </div>
            `:""}
            ${st.encaminhamento==="terceiro" ? `
              <div style="margin-top:6px;">
                <label>Nome / matr√≠cula do aprovador:</label>
                <input type="text" id="terceiro-${idx}" value="${st.nomeTerceiro||""}">
              </div>
            `:""}
            ${getStatePhotoSrc(st)?`
              <div style="margin-top:6px;">
                <img src="${getStatePhotoSrc(st)}" style="width:80px;height:80px;object-fit:cover;border-radius:4px;cursor:pointer;" onclick="showImageModal('${getStatePhotoSrc(st)}')">
              </div>
            `:""}
          </div>
        `;
        const failureModeSelect = extraDiv.querySelector(`#failure-mode-${idx}`);
        const motivo = extraDiv.querySelector(`#motivo-${idx}`);
        const fotoInput = extraDiv.querySelector(`#foto-${idx}`);
        const radios = extraDiv.querySelectorAll(`input[name="enc-${idx}"]`);
        const terceiro = extraDiv.querySelector(`#terceiro-${idx}`);
        const retrabalhoDesc = extraDiv.querySelector(`#retrabalho-desc-${idx}`);

        failureModeSelect.addEventListener("change",()=>{
          checklistItemStates[idx].failureMode = failureModeSelect.value;
        });
        motivo.addEventListener("input",()=>{
          checklistItemStates[idx].motivo = motivo.value;
        });
        fotoInput.addEventListener("change",()=>{
          const f = fotoInput.files[0]||null;
          checklistItemStates[idx].fotoFile = f;
          checklistItemStates[idx].fotoUrl = null;
          renderChecklistExecution();
        });
        radios.forEach(r=>r.addEventListener("change",()=>{
          checklistItemStates[idx].encaminhamento = r.value;
          renderChecklistExecution();
        }));
        if(terceiro){
          terceiro.addEventListener("input",()=>{
            checklistItemStates[idx].nomeTerceiro = terceiro.value;
          });
        }
        if(retrabalhoDesc){
          retrabalhoDesc.addEventListener("input",()=>{
            checklistItemStates[idx].descricaoRetrabalho = retrabalhoDesc.value;
          });
        }
      }
    });

    document.querySelectorAll(".checklist-status-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx = Number(btn.dataset.idx);
        const status = btn.dataset.status;
        checklistItemStates[idx].status = status;
        if(status==="OK"){
          checklistItemStates[idx].motivo="";
          checklistItemStates[idx].fotoFile=null;
          checklistItemStates[idx].fotoUrl=null;
          checklistItemStates[idx].encaminhamento="";
          checklistItemStates[idx].nomeTerceiro="";
          checklistItemStates[idx].descricaoRetrabalho="";
          checklistItemStates[idx].failureMode="";
        }
        renderChecklistExecution();
      });
    });

    renderNokLibrary();
  }

  function renderNokLibrary(){
    const div = document.getElementById("checklist-nok-library");
    const pieceCode = currentChecklistPiece?.code;
    if(!pieceCode){ div.innerHTML=""; return; }

    const nokCases = inspections
      .filter(i=>i.piece===pieceCode)
      .flatMap(ins => (ins.itens||[])
        .map(it=>({...it, ins}))
        .filter(it=>it.status==="NOK")
      );

    if(!nokCases.length){
      div.innerHTML = '<div style="font-size:12px;color:#555;">Nenhuma reprova√ß√£o registrada para esta pe√ßa.</div>';
      return;
    }

    div.innerHTML = `
      <div class="checklist-nok-title">Hist√≥rico de reprova√ß√µes (${nokCases.length})</div>
      <div class="checklist-nok-grid">
        ${nokCases.map(c=>{
          const src = c.fotoUrl || "";
          return `
            <div class="checklist-nok-card">
              <div><strong>${c.ins.date}</strong></div>
              <div>Inspetor: ${c.inspector || c.ins.inspector}</div>
              <div style="margin-top:4px;">${c.motivo||""}</div>
              ${c.encaminhamento==="retrabalho" && c.descricao_retrabalho ? `<div style="margin-top:4px;padding:4px;background:#fff3cd;border-radius:3px;"><strong>N¬∫ OP Retrabalho:</strong> ${c.descricao_retrabalho}</div>` : ""}
              ${src?`<img src="${src}" onclick="showImageModal('${src}')">`:""}
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  async function finishChecklist(){
    if(!currentChecklistPiece){
      alert("Nenhuma pe√ßa selecionada.");
      return;
    }
    
    // Validate station is selected
    if(!currentStation?.trim()){
      alert("Selecione a esta√ß√£o/linha.");
      return;
    }
    
    // Validate serial number if piece has it
    if(currentChecklistPiece.hasSerialNumber && !currentPieceSerialNumber?.trim()){
      alert("Preencha o serial number da pe√ßa.");
      return;
    }
    
    for(let i=0;i<checklistItemStates.length;i++){
      const st = checklistItemStates[i];
      if(!st.status){
        alert("Responda todos os itens do checklist.");
        return;
      }
      if(st.status==="NOK"){
        if(!st.failureMode?.trim()){
          alert("Selecione o modo de falha em todos os itens N√ÉO OK.");
          return;
        }
        if(!st.motivo?.trim()){
          alert("Preencha o motivo em todos os itens N√ÉO OK.");
          return;
        }
        if(!st.fotoFile && !st.fotoUrl){
          alert("Adicione foto em todos os itens N√ÉO OK.");
          return;
        }
        if(!st.encaminhamento){
          alert("Selecione o encaminhamento em todos os itens N√ÉO OK.");
          return;
        }
        if(st.encaminhamento==="terceiro" && !st.nomeTerceiro?.trim()){
          alert("Informe o aprovador em todos os itens aprovados por terceiro.");
          return;
        }
        if(st.encaminhamento==="retrabalho" && !st.descricaoRetrabalho?.trim()){
          alert("Preencha o n√∫mero da OP de retrabalho em todos os itens encaminhados para retrabalho.");
          return;
        }
      }
    }

    const now = new Date();
    const inspName = currentUser ? currentUser.name : "";

    const inspecToSave = {
      date: now.toLocaleDateString("pt-BR"),
      inspector: inspName,
      piece: currentChecklistPiece.code,
      descricao: "Inspe√ß√£o realizada",
      serialNumber: currentPieceSerialNumber || "",
      client: currentClient || "",
      station: currentStation || "",
      itens: checklistItemStates.map(s=>({
        status: s.status,
        motivo: s.motivo,
        encaminhamento: s.encaminhamento,
        nome_terceiro: s.nomeTerceiro,
        descricao_retrabalho: s.descricaoRetrabalho,
        failureMode: s.failureMode || "",
        foto: s.fotoFile,
        fotoUrl: s.fotoUrl
      }))
    };

    if(window.fbApi && window.fbApi.saveInspection){
      try{
        const saved = await window.fbApi.saveInspection(inspecToSave);
        inspections.push(saved);
        saveInspectionsToLocalStorage();
        alert("Inspe√ß√£o salva no servidor.");
      }catch(err){
        console.error("Erro salvar inspe√ß√£o Firebase:", err);
        inspections.push({
          ...inspecToSave,
          itens: inspecToSave.itens.map(i=>({...i, foto:null, fotoUrl:null}))
        });
        saveInspectionsToLocalStorage();
        alert("Erro ao salvar no servidor. Inspe√ß√£o registrada apenas neste navegador.");
      }
    }else{
      inspections.push({
        ...inspecToSave,
        itens: inspecToSave.itens.map(i=>({...i, foto:null, fotoUrl:null}))
      });
      saveInspectionsToLocalStorage();
      alert("Inspe√ß√£o registrada localmente.");
    }

    renderReports();
    renderDashboard();
    renderChecklistExecution();

    // resetar sele√ß√£o e voltar ao in√≠cio do checklist
    const pieceSel = document.getElementById("piece-selector");
    if(pieceSel) pieceSel.value = "";
    currentChecklistPiece = null;
    checklistItemStates = [];
    currentPieceSerialNumber = ""; // Reset serial number
    currentClient = ""; // Reset client
    currentStation = ""; // Reset station
    
    // Show piece selection card again and hide checklist
    document.getElementById("piece-selection-card").classList.remove("hide");
    const exec = document.getElementById("checklist-execution");
    if(exec) exec.classList.add("hide");
    
    // Expand sidebar when returning to piece selection
    expandSidebar();
    
    window.scrollTo({top:0,behavior:"smooth"});
  }

  function cancelChecklist(){
    if(!confirm("Deseja cancelar esta inspe√ß√£o? Todos os dados n√£o salvos ser√£o perdidos.")){
      return;
    }
    
    // Reset all state
    const pieceSel = document.getElementById("piece-selector");
    if(pieceSel) pieceSel.value = "";
    currentChecklistPiece = null;
    checklistItemStates = [];
    currentPieceSerialNumber = "";
    currentClient = "";
    currentStation = "";
    
    // Show piece selection card again and hide checklist
    document.getElementById("piece-selection-card").classList.remove("hide");
    const exec = document.getElementById("checklist-execution");
    if(exec) exec.classList.add("hide");
    
    // Expand sidebar when returning to piece selection
    expandSidebar();
    
    window.scrollTo({top:0,behavior:"smooth"});
  }

  function collapseSidebar(){
    const sidebar = document.querySelector(".sidebar");
    if(sidebar){
      sidebar.classList.add("collapsed");
    }
  }

  function expandSidebar(){
    const sidebar = document.querySelector(".sidebar");
    if(sidebar){
      sidebar.classList.remove("collapsed");
    }
  }

  // Inspetores (fotos locais)
  function loadInspectorPhotosFromLocalStorage(){
    try{
      const raw = localStorage.getItem("inspPhotos");
      inspectorPhotos = raw ? JSON.parse(raw) : {};
    }catch{ inspectorPhotos = {}; }
  }
  function saveInspectorPhotosToLocalStorage(){
    try{
      localStorage.setItem("inspPhotos", JSON.stringify(inspectorPhotos||{}));
    }catch(e){ console.warn("Erro salvar fotos localStorage",e); }
  }

  // Inspe√ß√µes (localStorage backup)
  function loadInspectionsFromLocalStorage(){
    try{
      const raw = localStorage.getItem("inspections");
      const localInspections = raw ? JSON.parse(raw) : [];
      // Merge with existing inspections (avoid duplicates)
      localInspections.forEach(localInsp=>{
        const exists = inspections.some(i=>i.date===localInsp.date && i.inspector===localInsp.inspector && i.piece===localInsp.piece);
        if(!exists) inspections.push(localInsp);
      });
    }catch(e){ console.warn("Erro carregar inspe√ß√µes localStorage",e); }
  }
  function saveInspectionsToLocalStorage(){
    try{
      localStorage.setItem("inspections", JSON.stringify(inspections||[]));
    }catch(e){ console.warn("Erro salvar inspe√ß√µes localStorage",e); }
  }

  function renderInspectors(){
    const listDiv = document.getElementById("inspectors-list");
    if(!listDiv) return;
    listDiv.innerHTML = "";
    inspectors.forEach(insp=>{
      const name = insp.name;
      const shift = insp.shift || "N√£o definido";
      const hasPin = !!insp.pinHash;
      const card = document.createElement("div");
      card.className="inspector-card";
      const photoSrc = inspectorPhotos[name] || "";
      card.innerHTML = `
        <div class="inspector-avatar">
          ${photoSrc?`<img src="${photoSrc}" onclick="showImageModal('${photoSrc}')">`:
            name.split(" ").map(p=>p[0]).join("")}
        </div>
        <div class="inspector-name">${name}</div>
        <div class="inspector-pin-status">Turno: ${shift}</div>
        <div class="inspector-pin-status">PIN: ${hasPin ? "Cadastrado" : "N√£o definido"}</div>
        <div class="inspector-actions">
          <button class="btn-icon btn-edit" data-name="${name}">Editar</button>
          <button class="btn-icon btn-delete" data-name="${name}">Remover</button>
          ${currentUser && currentUser.role==="admin"
            ? `<button class="btn-icon btn-reset-pin" data-name="${name}" data-action="reset-pin">Resetar PIN</button>`
            : ""}
        </div>
      `;
      listDiv.appendChild(card);
    });

    listDiv.querySelectorAll(".btn-edit").forEach(btn=>{
      btn.addEventListener("click",()=>{
        openEditInspectorModal(btn.dataset.name);
      });
    });
    listDiv.querySelectorAll(".btn-delete").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const name = btn.dataset.name;
        if(!confirm(`Remover inspetor "${name}"?`)) return;
        inspectors = inspectors.filter(i=>i.name!==name);
        delete inspectorPhotos[name];
        saveInspectorPhotosToLocalStorage();
        renderInspectors();
        renderChecklistSelectors();
        renderLoginInspectorSelect();
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
      });
    });
    listDiv.querySelectorAll("button[data-action='reset-pin']").forEach(btn=>{
      btn.addEventListener("click",async()=>{
        const name = btn.dataset.name;
        const insp = inspectors.find(i=>i.name===name);
        if(!insp) return;
        if(!confirm(`Resetar PIN do inspetor "${name}"?`)) return;
        insp.pinHash = "";
        if(window.fbApi && window.fbApi.setInspectors){
          try{
            await window.fbApi.setInspectors(inspectors);
          }catch(e){
            console.error("Erro ao resetar PIN:",e);
          }
        }
        renderInspectors();
        alert("PIN resetado. O pr√≥ximo login deste inspetor ir√° cadastrar um novo PIN.");
      });
    });

    const nameInput = document.getElementById("insp-name-input");
    const shiftInput = document.getElementById("insp-shift-input");
    const photoInput = document.getElementById("insp-photo-input");
    if(nameInput) nameInput.value="";
    if(shiftInput) shiftInput.value="";
    if(photoInput) photoInput.value="";

    // Atualiza tamb√©m o select da tela de login
    renderLoginInspectorSelect();
  }

  function openEditInspectorModal(name){
    const insp = inspectors.find(i=>i.name===name);
    if(!insp) return;
    const currentPhoto = inspectorPhotos[name] || "";
    const currentShift = insp.shift || "";
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Inspetor</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Nome</label>
        <input type="text" id="modal-insp-name" value="${insp.name}">
      </div>
      <div class="form-group">
        <label>Turno</label>
        <select id="modal-insp-shift">
          <option value="">Selecione o turno</option>
          <option value="1¬∫ Turno" ${currentShift==="1¬∫ Turno"?"selected":""}>1¬∫ Turno</option>
          <option value="2¬∫ Turno" ${currentShift==="2¬∫ Turno"?"selected":""}>2¬∫ Turno</option>
          <option value="3¬∫ Turno" ${currentShift==="3¬∫ Turno"?"selected":""}>3¬∫ Turno</option>
          <option value="Administrativo" ${currentShift==="Administrativo"?"selected":""}>Administrativo</option>
        </select>
      </div>
      <div class="form-group">
        <label>Foto</label>
        <input type="file" id="modal-insp-photo" accept="image/*">
      </div>
      ${currentPhoto?`
        <div style="margin-top:6px;text-align:center;">
          <img src="${currentPhoto}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
        </div>`:""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-insp-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-insp-save").addEventListener("click",()=>{
      const newName = document.getElementById("modal-insp-name").value.trim();
      const newShift = document.getElementById("modal-insp-shift").value.trim();
      const file = document.getElementById("modal-insp-photo").files[0];
      if(!newName){ alert("Nome n√£o pode ser vazio."); return; }
      if(!newShift){ alert("Selecione o turno."); return; }

      const oldName = insp.name;
      insp.name = newName;
      insp.shift = newShift;

      if(newName!==oldName){
        inspectorPhotos[newName] = inspectorPhotos[oldName];
        delete inspectorPhotos[oldName];
      }

      const finalize = ()=>{
        saveInspectorPhotosToLocalStorage();
        closeModal();
        renderInspectors();
        renderChecklistSelectors();
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
        if(currentUser && currentUser.role==="inspector" && currentUser.name===oldName){
          currentUser.name = newName;
          updateHeaderUser();
        }
      };

      if(file){
        const reader = new FileReader();
        reader.onload = e=>{
          inspectorPhotos[newName] = e.target.result;
          finalize();
        };
        reader.readAsDataURL(file);
      }else{
        finalize();
      }
    });
  }

  // Pe√ßas & itens
  function renderPieces(){
    const listDiv = document.getElementById("pieces-list");
    const selectItems = document.getElementById("piece-items-selector");
    if(!listDiv || !selectItems) return;
    listDiv.innerHTML=""; selectItems.innerHTML="";

    pieces.forEach((p,idx)=>{
      const row = document.createElement("div");
      row.className="piece-row";
      const src = getPieceImageSrc(p);
      row.innerHTML = `
        <div class="piece-row-left">
          <div class="piece-thumb">${src?`<img src="${src}">`:""}</div>
          <div class="piece-label">${p.code} ‚Äî ${p.description||""}</div>
        </div>
        <div>
          <button class="btn-icon btn-edit" data-idx="${idx}">Editar</button>
          <button class="btn-icon btn-delete" data-idx="${idx}">Remover</button>
        </div>
      `;
      listDiv.appendChild(row);
      selectItems.innerHTML += `<option value="${idx}">${p.code}</option>`;
    });

    document.querySelectorAll("#pieces-list .btn-edit").forEach(btn=>{
      btn.addEventListener("click",()=>openEditPieceModal(Number(btn.dataset.idx)));
    });
    document.querySelectorAll("#pieces-list .btn-delete").forEach(btn=>{
      btn.addEventListener("click",async()=>{
        const idx = Number(btn.dataset.idx);
        const p = pieces[idx];
        if(!confirm(`Excluir pe√ßa "${p.code}"?`)) return;
        pieces.splice(idx,1);
        renderPieces();
        renderChecklistSelectors();
        
        // Also remove biblioteca items for this piece from local array
        bibliotecaItems = bibliotecaItems.filter(item => item.piece !== p.code);
        renderBiblioteca();
        
        if(window.fbApi && window.fbApi.deletePiece){
          window.fbApi.deletePiece(p.code).catch(e=>console.error("Erro delete piece Firebase",e));
        }
      });
    });

    if(pieces.length){
      document.getElementById("piece-items-selector").value = 0;
      renderPieceItemsList(0);
    }else{
      document.getElementById("piece-items-list").innerHTML =
        "<div style='font-size:12px;color:#666;'>Nenhuma pe√ßa cadastrada.</div>";
    }

    document.getElementById("piece-code-input").value="";
    document.getElementById("piece-desc-input").value="";
    document.getElementById("piece-image-input").value="";
  }

  function openEditPieceModal(idx){
    const p = pieces[idx];
    const src = getPieceImageSrc(p) || "";
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Pe√ßa</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>C√≥digo</label>
        <input type="text" id="modal-piece-code" value="${p.code}">
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <input type="text" id="modal-piece-desc" value="${p.description||""}">
      </div>
      <div class="form-group">
        <label>Cliente</label>
        <select id="modal-piece-client">
          <option value="">Selecione o cliente</option>
          <option value="AGCO Canoas" ${p.client==="AGCO Canoas"?"selected":""}>AGCO Canoas</option>
          <option value="AGCO Mogi" ${p.client==="AGCO Mogi"?"selected":""}>AGCO Mogi</option>
          <option value="AGCO Santa Rosa" ${p.client==="AGCO Santa Rosa"?"selected":""}>AGCO Santa Rosa</option>
          <option value="Agritech Indaiatuba" ${p.client==="Agritech Indaiatuba"?"selected":""}>Agritech Indaiatuba</option>
          <option value="Caterpillar Campo Largo" ${p.client==="Caterpillar Campo Largo"?"selected":""}>Caterpillar Campo Largo</option>
          <option value="Caterpillar Piracicaba" ${p.client==="Caterpillar Piracicaba"?"selected":""}>Caterpillar Piracicaba</option>
          <option value="Caterpillar Piracicaba Reposi√ß√£o" ${p.client==="Caterpillar Piracicaba Reposi√ß√£o"?"selected":""}>Caterpillar Piracicaba Reposi√ß√£o</option>
          <option value="CNH Curitiba" ${p.client==="CNH Curitiba"?"selected":""}>CNH Curitiba</option>
          <option value="CNH Reposi√ß√£o Sorocaba" ${p.client==="CNH Reposi√ß√£o Sorocaba"?"selected":""}>CNH Reposi√ß√£o Sorocaba</option>
          <option value="CNH Sorocaba" ${p.client==="CNH Sorocaba"?"selected":""}>CNH Sorocaba</option>
          <option value="DAF Ponta Grossa" ${p.client==="DAF Ponta Grossa"?"selected":""}>DAF Ponta Grossa</option>
          <option value="Dana Industrias" ${p.client==="Dana Industrias"?"selected":""}>Dana Industrias</option>
          <option value="Deere Hitachi ‚Äì Indaiatuba" ${p.client==="Deere Hitachi ‚Äì Indaiatuba"?"selected":""}>Deere Hitachi ‚Äì Indaiatuba</option>
          <option value="Flamma" ${p.client==="Flamma"?"selected":""}>Flamma</option>
          <option value="Gedore" ${p.client==="Gedore"?"selected":""}>Gedore</option>
          <option value="GTS" ${p.client==="GTS"?"selected":""}>GTS</option>
          <option value="Horsch do Brasil" ${p.client==="Horsch do Brasil"?"selected":""}>Horsch do Brasil</option>
          <option value="Iveco Sete Lagoas" ${p.client==="Iveco Sete Lagoas"?"selected":""}>Iveco Sete Lagoas</option>
          <option value="John Deere Catal√£o" ${p.client==="John Deere Catal√£o"?"selected":""}>John Deere Catal√£o</option>
          <option value="John Deere Horizontina" ${p.client==="John Deere Horizontina"?"selected":""}>John Deere Horizontina</option>
          <option value="John Deere Indaiatuba" ${p.client==="John Deere Indaiatuba"?"selected":""}>John Deere Indaiatuba</option>
          <option value="John Deere Montenegro" ${p.client==="John Deere Montenegro"?"selected":""}>John Deere Montenegro</option>
          <option value="John Deere Reposi√ß√£o Campinas" ${p.client==="John Deere Reposi√ß√£o Campinas"?"selected":""}>John Deere Reposi√ß√£o Campinas</option>
          <option value="Landini ‚Äì Contagem / MG" ${p.client==="Landini ‚Äì Contagem / MG"?"selected":""}>Landini ‚Äì Contagem / MG</option>
          <option value="Maxion Cruzeiro" ${p.client==="Maxion Cruzeiro"?"selected":""}>Maxion Cruzeiro</option>
          <option value="Mercedes Juiz de Fora" ${p.client==="Mercedes Juiz de Fora"?"selected":""}>Mercedes Juiz de Fora</option>
          <option value="Mercedes S√£o Bernardo do Campo" ${p.client==="Mercedes S√£o Bernardo do Campo"?"selected":""}>Mercedes S√£o Bernardo do Campo</option>
          <option value="Metalsa Campo Largo" ${p.client==="Metalsa Campo Largo"?"selected":""}>Metalsa Campo Largo</option>
          <option value="Metalsa Osasco" ${p.client==="Metalsa Osasco"?"selected":""}>Metalsa Osasco</option>
          <option value="MWM" ${p.client==="MWM"?"selected":""}>MWM</option>
          <option value="Renault SJP" ${p.client==="Renault SJP"?"selected":""}>Renault SJP</option>
          <option value="Scania Reposi√ß√£o Vinhedos" ${p.client==="Scania Reposi√ß√£o Vinhedos"?"selected":""}>Scania Reposi√ß√£o Vinhedos</option>
          <option value="Scania S√£o Bernardo do Campo" ${p.client==="Scania S√£o Bernardo do Campo"?"selected":""}>Scania S√£o Bernardo do Campo</option>
          <option value="Solinftec" ${p.client==="Solinftec"?"selected":""}>Solinftec</option>
          <option value="Tatu" ${p.client==="Tatu"?"selected":""}>Tatu</option>
          <option value="Volvo CE Pederneiras" ${p.client==="Volvo CE Pederneiras"?"selected":""}>Volvo CE Pederneiras</option>
          <option value="Volvo Curitiba" ${p.client==="Volvo Curitiba"?"selected":""}>Volvo Curitiba</option>
          <option value="Volvo Pederneiras" ${p.client==="Volvo Pederneiras"?"selected":""}>Volvo Pederneiras</option>
          <option value="Volvo Reposi√ß√£o" ${p.client==="Volvo Reposi√ß√£o"?"selected":""}>Volvo Reposi√ß√£o</option>
        </select>
      </div>
      <div class="form-group">
        <label>Imagem</label>
        <input type="file" id="modal-piece-img" accept="image/*">
      </div>
      ${src?`
        <div style="margin-top:6px;text-align:center;">
          <img src="${src}" style="max-width:120px;max-height:80px;border-radius:4px;">
        </div>`:""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-piece-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-piece-save").addEventListener("click",()=>{
      const newCode = document.getElementById("modal-piece-code").value.trim();
      const newDesc = document.getElementById("modal-piece-desc").value.trim();
      const newClient = document.getElementById("modal-piece-client").value.trim();
      const file = document.getElementById("modal-piece-img").files[0];
      if(!newCode || !newDesc || !newClient){ 
        alert("Preencha c√≥digo, descri√ß√£o e cliente."); 
        return; 
      }
      p.code=newCode; 
      p.description=newDesc;
      p.client=newClient;
      if(file){ p.image=file; p.imageUrl=null; }
      closeModal();
      renderPieces();
      renderChecklistSelectors();
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(p).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });
  }

  function renderPieceItemsList(pieceIdx){
    const box = document.getElementById("piece-items-list");
    if(!box) return;
    box.innerHTML="";
    const p = pieces[pieceIdx];
    if(!p) return;
    (p.items||[]).forEach((it,idx)=>{
      const row = document.createElement("div");
      row.className="piece-item-row";
      const src = getItemImageSrc(it);
      row.innerHTML = `
        <div class="piece-item-main">
          <div class="piece-item-thumb">${src?`<img src="${src}">`:""}</div>
          <div>
            <div style="font-size:13px;font-weight:600;">${it.name}</div>
            <div style="font-size:11px;color:#555;">${it.description||""}</div>
          </div>
        </div>
        <div>
          <button class="btn-icon btn-edit" data-pidx="${pieceIdx}" data-idx="${idx}">Editar</button>
          <button class="btn-icon btn-delete" data-pidx="${pieceIdx}" data-idx="${idx}">Remover</button>
        </div>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll(".btn-edit").forEach(btn=>{
      btn.addEventListener("click",()=>openEditItemModal(Number(btn.dataset.pidx),Number(btn.dataset.idx)));
    });
    box.querySelectorAll(".btn-delete").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const pidx = Number(btn.dataset.pidx);
        const idx = Number(btn.dataset.idx);
        const p = pieces[pidx];
        if(!confirm(`Remover item "${p.items[idx].name}"?`)) return;
        p.items.splice(idx,1);
        renderPieceItemsList(pidx);
        if(window.fbApi && window.fbApi.savePiece){
          window.fbApi.savePiece(p).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
        }
      });
    });
  }

  function openEditItemModal(pieceIdx,idx){
    const item = pieces[pieceIdx].items[idx];
    const src = getItemImageSrc(item) || "";
    const failureMode = item.failureMode || item.failureModes?.[0] || ""; // Support old data format
    
    const allModes = [
      "√Çngulo fora do especificado",
      "Backlog interno",
      "Borra de e-coat",
      "Camada fora do especificado",
      "Componente soldado deslocado",
      "Componente soldado invertido",
      "Comprimento do cord√£o de solda fora do especificado",
      "Contamina√ß√£o",
      "Corpo ou cabeceira invertida",
      "Cravamento irregular ‚Äì parafuso / porca / pino / porca",
      "Dimensional fora do especificado",
      "Dobra invertida",
      "Emenda deficiente",
      "Espa√ßamento entre componentes",
      "Excesso de p√≥",
      "Falha no corte da pe√ßa",
      "Falha no mascaramento / prote√ß√£o",
      "Falta de cord√£o de solda",
      "Falta de cura",
      "Falta de opera√ß√£o (rosca, chanfro, furo, montagem)",
      "Falta de penetra√ß√£o de solda",
      "Ficha tratamento superficial FTS errada",
      "Gap",
      "Grava√ß√£o fora do especificado",
      "Identifica√ß√£o incorreta",
      "Inclus√£o de arame de solda",
      "Log√≠stica ‚Äì pe√ßa enviada fora do programa de entrega",
      "M√° forma√ß√£o do rebite",
      "Mat√©ria-prima n√£o conforme (riscos, marcas, etc.)",
      "Montagem incorreta",
      "Mordedura",
      "Opera√ß√£o incompleta (rosca, chanfro, furo, etc.)",
      "Oxida√ß√£o",
      "Pe√ßas com componentes fora do especificado",
      "Pe√ßas com trincas",
      "Pe√ßas danificadas em processo (marcas e riscos, etc.)",
      "Pe√ßas faltando componentes",
      "Pe√ßas misturadas",
      "Perna da solda filete abaixo da medida",
      "Pintura escorrida",
      "Pintura com casca de laranja",
      "Pintura cratera",
      "Pintura com desplacamento",
      "Pintura com olho de peixe",
      "Pintura com sujeira",
      "Pintura danificada",
      "Pintura falhada",
      "Pintura fervida",
      "Plano de embalagem fora do especificado",
      "Porosidade",
      "Rebarbas",
      "Respingos",
      "Rosca danificada",
      "Roscas / furos com tinta e/ou sujeiras",
      "Solda com sobreposi√ß√£o"
    ];
    const modeOptions = allModes.map(mode => 
      `<option value="${mode}" ${failureMode===mode?"selected":""}>${mode}</option>`
    ).join("");
    
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Item</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Nome</label>
        <input type="text" id="modal-item-name" value="${item.name}">
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <textarea id="modal-item-desc" rows="2">${item.description||""}</textarea>
      </div>
      <div class="form-group">
        <label>Modo de falha</label>
        <select id="modal-item-failure-mode" style="width:100%;padding:6px;border:1px solid #cbd3e3;border-radius:4px;font-size:13px;">
          <option value="">Selecione o modo de falha</option>
          ${modeOptions}
        </select>
      </div>
      <div class="form-group">
        <label>Imagem</label>
        <input type="file" id="modal-item-img" accept="image/*">
      </div>
      ${src?`
        <div style="margin-top:6px;text-align:center;">
          <img src="${src}" style="max-width:120px;max-height:80px;border-radius:4px;">
        </div>`:""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-item-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-item-save").addEventListener("click",()=>{
      const name = document.getElementById("modal-item-name").value.trim();
      const desc = document.getElementById("modal-item-desc").value.trim();
      const file = document.getElementById("modal-item-img").files[0];
      const failureModeSelect = document.getElementById("modal-item-failure-mode");
      const newFailureMode = failureModeSelect.value;
      
      if(!name || !desc){ alert("Preencha nome e descri√ß√£o."); return; }
      if(!newFailureMode){
        alert("Selecione o modo de falha.");
        return;
      }
      
      item.name=name; 
      item.description=desc;
      item.failureMode=newFailureMode;
      delete item.failureModes; // Remove old field if exists
      if(file){ item.image=file; item.imageUrl=null; }
      closeModal();
      renderPieceItemsList(pieceIdx);
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(pieces[pieceIdx]).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });
  }

  // Relat√≥rios
  function renderReports(){
    const monthSelect = document.getElementById("report-month-select");
    const tbody = document.getElementById("reports-history-body");
    const totalSpan = document.getElementById("total-inspecoes");
    if(!monthSelect || !tbody || !totalSpan) return;

    const monthsSet = new Set();
    inspections.forEach(i=>{
      if(!i.date) return;
      const [d,m,y] = i.date.split("/");
      if(m&&y) monthsSet.add(`${m}/${y}`);
    });
    const months = Array.from(monthsSet).sort((a,b)=>{
      const [m1,y1] = a.split("/").map(Number);
      const [m2,y2] = b.split("/").map(Number);
      if(y1 !== y2) return y2 - y1; // Year descending
      return m2 - m1; // Month descending
    });
    
    // Save current selection before updating options
    const prevSelection = monthSelect.value;
    
    monthSelect.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");
    
    // Restore previous selection if it still exists, otherwise use first month
    const current = (prevSelection && months.includes(prevSelection)) ? prevSelection : (months[0] || "");
    monthSelect.value = current;

    const filtered = inspections.filter(i=>{
      if(!i.date) return false;
      const [d,m,y] = i.date.split("/");
      return `${m}/${y}`===current;
    });

    totalSpan.textContent = filtered.length;
    
    // Helper function to check if piece is approved
    function isPieceApproved(inspection){
      if(!inspection.itens || inspection.itens.length === 0) return true;
      return inspection.itens.every(item => item.status === "OK");
    }
    
    tbody.innerHTML = filtered.length
      ? filtered.map(i=>{
          const status = isPieceApproved(i) ? "Aprovada" : "Reprovada";
          return `
        <tr>
          <td>${i.date}</td>
          <td>${i.inspector}</td>
          <td>${i.piece}</td>
          <td>${status}</td>
        </tr>`;
        }).join("")
      : `<tr><td colspan="4" style="text-align:center;">Nenhuma inspe√ß√£o para o m√™s selecionado.</td></tr>`;
  }

  function exportCSV(){
    if(!inspections.length){
      alert("Sem inspe√ß√µes para exportar.");
      return;
    }
    
    // Helper function to check if piece is approved
    function isPieceApproved(inspection){
      if(!inspection.itens || inspection.itens.length === 0) return true;
      return inspection.itens.every(item => item.status === "OK");
    }
    
    // CSV header: Data, Inspetor, Pe√ßa, Status
    const rows = ["Data,Inspetor,Pe√ßa,Status"];
    
    inspections.forEach(i=>{
      const date = i.date || "";
      const inspector = (i.inspector || "").replace(/"/g, '""');
      const piece = (i.piece || "").replace(/"/g, '""');
      const status = isPieceApproved(i) ? "Aprovada" : "Reprovada";
      
      rows.push(`${date},"${inspector}","${piece}",${status}`);
    });
    
    const csvContent = rows.join("\n");
    const BOM = "\uFEFF"; // UTF-8 BOM for Excel compatibility
    const blob = new Blob([BOM + csvContent], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "relatorio_inspecoes.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function ensureDashboardChart(){
    const ctx = document.getElementById("dashboard-chart")?.getContext("2d");
    if(!ctx) return;
    if(!dashboardChart){
      dashboardChart = new Chart(ctx,{
        type:"doughnut",
        data:{
          labels:["Pe√ßas Boas","Pe√ßas Reprovadas"],
          datasets:[{
            data:[0,0],
            backgroundColor:["#28b649","#E81C24"],
            borderColor:"#fff",
            borderWidth:2
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'bottom'}}}
      });
    }
  }

  function ensureChartByStation(){
    const canvas = document.getElementById("chart-by-station");
    if(!canvas) {
      console.log('Canvas chart-by-station not found');
      return;
    }
    // Only create chart if it doesn't exist
    if(chartByStation){
      console.log('chartByStation already exists');
      return;
    }
    const ctx = canvas.getContext("2d");
    if(!ctx) {
      console.log('Context for chart-by-station not available');
      return;
    }
    console.log('Creating chartByStation');
    chartByStation = new Chart(ctx,{
      type:"bar",
      data:{
        labels:[],
        datasets:[{
          label:"Pe√ßas Reprovadas",
          data:[],
          backgroundColor:"#E81C24",
          borderColor:"#c41820",
          borderWidth:1
        }]
      },
      options:{
        indexAxis: 'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:true,position:'top'},
          title:{display:false}
        },
        scales:{
          x:{beginAtZero:true,ticks:{precision:0}},
          y:{ticks:{font:{size:11}}}
        }
      }
    });
  }

  function ensureChartByClient(){
    const canvas = document.getElementById("chart-by-client");
    if(!canvas) {
      console.log('Canvas chart-by-client not found');
      return;
    }
    // Only create chart if it doesn't exist
    if(chartByClient){
      console.log('chartByClient already exists');
      return;
    }
    const ctx = canvas.getContext("2d");
    if(!ctx) {
      console.log('Context for chart-by-client not available');
      return;
    }
    console.log('Creating chartByClient');
    chartByClient = new Chart(ctx,{
      type:"bar",
      data:{
        labels:[],
        datasets:[{
          label:"Pe√ßas Reprovadas",
          data:[],
          backgroundColor:"#1844F0",
          borderColor:"#0f34d0",
          borderWidth:1
        }]
      },
      options:{
        indexAxis: 'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:true,position:'top'},
          title:{display:false}
        },
        scales:{
          x:{beginAtZero:true,ticks:{precision:0}},
          y:{ticks:{font:{size:11}}}
        }
      }
    });
  }

  function ensureChartByFailure(){
    const canvas = document.getElementById("chart-by-failure");
    if(!canvas) {
      console.log('Canvas chart-by-failure not found');
      return;
    }
    // Only create chart if it doesn't exist
    if(chartByFailure){
      console.log('chartByFailure already exists');
      return;
    }
    const ctx = canvas.getContext("2d");
    if(!ctx) {
      console.log('Context for chart-by-failure not available');
      return;
    }
    console.log('Creating chartByFailure');
    chartByFailure = new Chart(ctx,{
      type:"bar",
      data:{
        labels:[],
        datasets:[{
          label:"Ocorr√™ncias",
          data:[],
          backgroundColor:"#f59f00",
          borderColor:"#d98200",
          borderWidth:1
        }]
      },
      options:{
        indexAxis: 'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:true,position:'top'},
          title:{display:false}
        },
        scales:{
          x:{beginAtZero:true,ticks:{precision:0}},
          y:{ticks:{font:{size:11}}}
        }
      }
    });
  }

  function ensureChartMonthlyVolume(){
    const canvas = document.getElementById("chart-monthly-volume");
    if(!canvas) {
      console.log('Canvas chart-monthly-volume not found');
      return;
    }
    // Only create chart if it doesn't exist
    if(chartMonthlyVolume){
      console.log('chartMonthlyVolume already exists');
      return;
    }
    const ctx = canvas.getContext("2d");
    if(!ctx) {
      console.log('Cannot get 2D context for chart-monthly-volume');
      return;
    }
    console.log('Creating chartMonthlyVolume');
    chartMonthlyVolume = new Chart(ctx,{
      type:"bar",
      data:{
        labels:[],
        datasets:[{
          label:"Inspe√ß√µes",
          data:[],
          backgroundColor:"#206bc4",
          borderColor:"#1a5aa8",
          borderWidth:1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:true,position:'top'},
          title:{display:false}
        },
        scales:{
          x:{ticks:{font:{size:11}}},
          y:{beginAtZero:true,ticks:{precision:0,stepSize:1}}
        }
      }
    });
  }

  function renderDashboard(){
    // Use setTimeout to ensure DOM is ready and visible
    setTimeout(() => {
      ensureDashboardChart();
      ensureChartByStation();
      ensureChartByClient();
      ensureChartByFailure();
      ensureChartMonthlyVolume();
      
      // Populate filter dropdowns
      populateDashboardFilters();
      
      // Apply filters and render data
      applyDashboardFilters();
    }, 100);
  }

  function populateDashboardFilters(){
    // Populate clients - use production list
    const clientFilter = document.getElementById("filter-client");
    if(clientFilter){
      clientFilter.innerHTML = '<option value="">Todos</option>' +
        PRODUCTION_CLIENTS.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    // Populate pieces - from registered pieces
    const itemFilter = document.getElementById("filter-item");
    if(itemFilter){
      itemFilter.innerHTML = '<option value="">Todas</option>' +
        pieces.map(p=>`<option value="${escapeHtml(p.code)}">${escapeHtml(p.code)} - ${escapeHtml(p.description||"")}</option>`).join("");
    }

    // Populate failure modes - use production list
    const failureFilter = document.getElementById("filter-failure-mode");
    if(failureFilter){
      failureFilter.innerHTML = '<option value="">Todos</option>' +
        PRODUCTION_FAILURE_MODES.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");
    }

    // Populate inspectors
    const inspectorFilter = document.getElementById("filter-inspector");
    if(inspectorFilter){
      inspectorFilter.innerHTML = '<option value="">Todos</option>' +
        inspectors.map(i=>`<option value="${escapeHtml(i.name)}">${escapeHtml(i.name)}</option>`).join("");
    }
  }

  function applyDashboardFilters(){
    const startDate = document.getElementById("filter-date-start")?.value || "";
    const endDate = document.getElementById("filter-date-end")?.value || "";
    const clientFilter = document.getElementById("filter-client")?.value || "";
    const itemFilter = document.getElementById("filter-item")?.value || "";
    const failureModeFilter = document.getElementById("filter-failure-mode")?.value || "";
    const inspectorFilter = document.getElementById("filter-inspector")?.value || "";

    // Filter inspections
    const filtered = inspections.filter(i=>{
      // Date filter
      if(startDate || endDate){
        const [d,m,y] = (i.date||"").split("/");
        const day = parseInt(d);
        const month = parseInt(m);
        const year = parseInt(y);
        
        // Validate date components
        if(isNaN(day) || isNaN(month) || isNaN(year) || day < 1 || day > 31 || month < 1 || month > 12){
          return false; // Skip invalid dates
        }
        
        const inspDate = new Date(year, month-1, day);
        
        // Check if date is valid
        if(isNaN(inspDate.getTime())){
          return false; // Skip invalid dates
        }
        
        if(startDate){
          const start = new Date(startDate);
          if(inspDate < start) return false;
        }
        if(endDate){
          const end = new Date(endDate);
          if(inspDate > end) return false;
        }
      }
      
      // Client filter
      if(clientFilter && i.client !== clientFilter) return false;
      
      // Item/Piece filter
      if(itemFilter && i.piece !== itemFilter) return false;
      
      // Inspector filter
      if(inspectorFilter && i.inspector !== inspectorFilter) return false;
      
      // Failure mode filter (at least one item matches)
      if(failureModeFilter){
        const hasFailure = (i.itens||[]).some(it=>it.failureMode === failureModeFilter);
        if(!hasFailure) return false;
      }
      
      return true;
    });

    // Calculate KPIs - piece-level aggregation
    let totalInsp = filtered.length;
    let pecasBoas = 0;  // Pieces with all OK items
    let pecasReprovadas = 0;  // Pieces with at least one NOK item
    const defectsByStation = {};
    const defectsByClient = {};
    const defectsByFailure = {};

    filtered.forEach(i=>{
      const itens = i.itens || [];
      const hasNOK = itens.some(it => it.status === "NOK");
      
      if(hasNOK){
        // Piece is rejected if it has ANY NOK item
        pecasReprovadas++;
        
        // Count this rejected piece once per station/client
        if(i.station){
          defectsByStation[i.station] = (defectsByStation[i.station]||0)+1;
        }
        
        if(i.client){
          defectsByClient[i.client] = (defectsByClient[i.client]||0)+1;
        }
        
        // Count all failure modes found in this piece
        itens.forEach(it=>{
          if(it.status === "NOK" && it.failureMode){
            defectsByFailure[it.failureMode] = (defectsByFailure[it.failureMode]||0)+1;
          }
        });
      }else{
        // Piece is good if ALL items are OK
        pecasBoas++;
      }
    });

    const totalPecas = pecasBoas + pecasReprovadas;
    const percentDefects = totalPecas > 0 ? ((pecasReprovadas/totalPecas)*100).toFixed(1) : "0.0";

    // Update KPIs
    const kpiTotal = document.getElementById("kpi-total-inspecoes");
    const kpiAprovados = document.getElementById("kpi-aprovados");
    const kpiReprovados = document.getElementById("kpi-reprovados");
    const kpiPercent = document.getElementById("kpi-percent-defeitos");
    
    if(kpiTotal) kpiTotal.textContent = totalInsp;
    if(kpiAprovados) kpiAprovados.textContent = pecasBoas;
    if(kpiReprovados) kpiReprovados.textContent = pecasReprovadas;
    if(kpiPercent) kpiPercent.textContent = `${percentDefects}%`;

    // Update doughnut chart - showing good vs rejected pieces
    if(dashboardChart){
      dashboardChart.data.datasets[0].data = [pecasBoas, pecasReprovadas];
      dashboardChart.update();
    }

    // Update chart by station
    if(chartByStation){
      const stationLabels = Object.keys(defectsByStation).sort();
      const stationData = stationLabels.map(s=>defectsByStation[s]);
      console.log('Updating chartByStation:', {stationLabels, stationData, defectsByStation});
      chartByStation.data.labels = stationLabels;
      chartByStation.data.datasets[0].data = stationData;
      chartByStation.update('active');
    } else {
      console.log('chartByStation not initialized');
    }

    // Update chart by client
    if(chartByClient){
      const clientLabels = Object.keys(defectsByClient).sort();
      const clientData = clientLabels.map(c=>defectsByClient[c]);
      console.log('Updating chartByClient:', {clientLabels, clientData, defectsByClient});
      chartByClient.data.labels = clientLabels;
      chartByClient.data.datasets[0].data = clientData;
      chartByClient.update('active');
    } else {
      console.log('chartByClient not initialized');
    }

    // Update chart by failure mode
    if(chartByFailure){
      const failureLabels = Object.keys(defectsByFailure).sort();
      const failureData = failureLabels.map(f=>defectsByFailure[f]);
      console.log('Updating chartByFailure:', {failureLabels, failureData, defectsByFailure});
      chartByFailure.data.labels = failureLabels;
      chartByFailure.data.datasets[0].data = failureData;
      chartByFailure.update('active');
    } else {
      console.log('chartByFailure not initialized');
    }

    // Update monthly volume chart
    if(chartMonthlyVolume){
      // Group inspections by month
      const monthlyVolume = {};
      filtered.forEach(i=>{
        if(!i.date) return;
        const [d,m,y] = i.date.split("/");
        if(m && y){
          const monthKey = `${m}/${y}`;
          monthlyVolume[monthKey] = (monthlyVolume[monthKey] || 0) + 1;
        }
      });
      
      // Sort months chronologically
      const monthKeys = Object.keys(monthlyVolume).sort((a,b)=>{
        const [m1,y1] = a.split("/").map(Number);
        const [m2,y2] = b.split("/").map(Number);
        if(y1 !== y2) return y1 - y2;
        return m1 - m2;
      });
      
      const monthlyData = monthKeys.map(k=>monthlyVolume[k]);
      console.log('Updating chartMonthlyVolume:', {monthKeys, monthlyData, monthlyVolume});
      chartMonthlyVolume.data.labels = monthKeys;
      chartMonthlyVolume.data.datasets[0].data = monthlyData;
      chartMonthlyVolume.update('active');
    } else {
      console.log('chartMonthlyVolume not initialized');
    }
  }

  // Biblioteca de Inspe√ß√µes
  function escapeHtml(str){
    if(!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function getBibliotecaMediaSrc(item){
    if(!item) return null;
    if(item.media instanceof File) return URL.createObjectURL(item.media);
    if(item.video instanceof File) return URL.createObjectURL(item.video); // backward compat
    if(item.mediaType === 'image') return item.imageUrl || null;
    if(item.mediaType === 'pdf') return item.pdfUrl || null;
    return item.videoUrl || null;
  }

  function openBibliotecaMediaModal(item){
    const mediaSrc = getBibliotecaMediaSrc(item);
    if(!mediaSrc) return;
    
    const modal = document.createElement('div');
    modal.className = 'biblioteca-media-modal';
    modal.onclick = (e) => {
      if(e.target === modal) modal.remove();
    };
    
    const content = document.createElement('div');
    content.className = 'biblioteca-media-modal-content';
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'biblioteca-media-modal-close';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = () => modal.remove();
    
    let mediaElement;
    if(item.mediaType === 'image'){
      mediaElement = document.createElement('img');
      mediaElement.src = mediaSrc;
      mediaElement.alt = item.piece;
    } else if(item.mediaType === 'pdf'){
      mediaElement = document.createElement('iframe');
      mediaElement.src = mediaSrc;
      mediaElement.style.cssText = 'width:100%;height:100%;border:none;';
      mediaElement.type = 'application/pdf';
    } else {
      mediaElement = document.createElement('video');
      mediaElement.controls = true;
      mediaElement.autoplay = true;
      mediaElement.style.cssText = 'background:#000;';
      mediaElement.src = mediaSrc;
      
      // Determine video type from file extension
      const ext = mediaSrc.split('.').pop().split('?')[0].toLowerCase();
      mediaElement.type = ext === 'webm' ? 'video/webm' : ext === 'ogg' ? 'video/ogg' : 'video/mp4';
    }
    
    content.appendChild(closeBtn);
    content.appendChild(mediaElement);
    modal.appendChild(content);
    document.body.appendChild(modal);
  }

  function renderBiblioteca(){
    const listDiv = document.getElementById("biblioteca-list");
    if(!listDiv) return;
    listDiv.innerHTML = "";

    // Show/hide admin form based on user role
    const adminForm = document.getElementById("biblioteca-admin-form");
    if(adminForm){
      adminForm.style.display = (currentUser && currentUser.role === "admin") ? "block" : "none";
    }

    // Populate piece selector for admin
    const pieceSelect = document.getElementById("biblioteca-piece-select");
    if(pieceSelect && currentUser && currentUser.role === "admin"){
      pieceSelect.innerHTML = '<option value="" disabled selected>Selecione uma pe√ßa</option>' +
        pieces.map(p=>{
          const pieceName = `${p.code} - ${p.description||""}`;
          return `<option value="${escapeHtml(pieceName)}">${escapeHtml(pieceName)}</option>`;
        }).join("");
    }

    if(!bibliotecaItems.length){
      listDiv.innerHTML = '<div style="font-size:13px;color:#666;padding:20px;text-align:center;">Nenhum material cadastrado na biblioteca.</div>';
      return;
    }

    // Group biblioteca items by piece
    const groupedByPiece = {};
    bibliotecaItems.forEach(item => {
      if(!groupedByPiece[item.piece]) {
        groupedByPiece[item.piece] = [];
      }
      groupedByPiece[item.piece].push(item);
    });

    // Render one card per piece
    Object.keys(groupedByPiece).forEach(pieceName => {
      const items = groupedByPiece[pieceName];
      const card = document.createElement("div");
      card.className = "biblioteca-card";
      
      // Create title element safely
      const titleDiv = document.createElement("div");
      titleDiv.className = "biblioteca-card-title";
      titleDiv.textContent = pieceName;
      
      // Create media box - show piece reference image
      const mediaBox = document.createElement("div");
      mediaBox.className = "biblioteca-media-box";
      mediaBox.onclick = () => openBibliotecaMaterialsModal(pieceName, items);
      
      // Find the piece to get reference image
      const piece = pieces.find(p => `${p.code} - ${p.description||""}` === pieceName);
      if(piece && piece.imageUrl) {
        const img = document.createElement("img");
        img.src = piece.imageUrl;
        img.alt = pieceName;
        img.style.cssText = "width:100%;height:100%;object-fit:cover;";
        mediaBox.appendChild(img);
      } else {
        const noImage = document.createElement("div");
        noImage.style.cssText = "display:flex;align-items:center;justify-content:center;height:100%;color:#666;background:#e0e5f0;";
        noImage.textContent = "Sem foto de refer√™ncia";
        mediaBox.appendChild(noImage);
      }
      
      // Add materials count badge
      const countBadge = document.createElement("div");
      countBadge.className = "biblioteca-materials-count";
      countBadge.textContent = `${items.length} ${items.length === 1 ? 'material' : 'materiais'}`;
      mediaBox.appendChild(countBadge);
      
      card.appendChild(titleDiv);
      card.appendChild(mediaBox);
      
      // Only show admin actions for the piece (not individual materials)
      if(currentUser && currentUser.role === "admin"){
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "biblioteca-actions";
        
        const manageBtn = document.createElement("button");
        manageBtn.className = "btn-icon";
        manageBtn.textContent = "Gerenciar Materiais";
        manageBtn.style.cssText = "flex:1;background:#1844F0;color:#fff;";
        manageBtn.onclick = (e) => {
          e.stopPropagation();
          openBibliotecaMaterialsModal(pieceName, items);
        };
        
        actionsDiv.appendChild(manageBtn);
        card.appendChild(actionsDiv);
      }
      
      listDiv.appendChild(card);
    });

    // Limpar form (somente para admin)
    if(currentUser && currentUser.role === "admin"){
      const mediaInput = document.getElementById("biblioteca-media-input");
      if(mediaInput) mediaInput.value = "";
      if(pieceSelect) pieceSelect.value = "";
    }
  }

  function openEditBibliotecaModal(id){
    const item = bibliotecaItems.find(i=>i.id===id);
    if(!item) return;
    const mediaSrc = getBibliotecaMediaSrc(item) || "";
    
    // Use utility function for HTML escaping
    const escapedPiece = escapeHtml(item.piece);
    const escapedMediaSrc = escapeHtml(mediaSrc);
    
    // Build piece selector options
    const pieceOptions = pieces.map(p=>{
      const pieceName = `${p.code} - ${p.description||""}`;
      const selected = pieceName === item.piece ? 'selected' : '';
      return `<option value="${escapeHtml(pieceName)}" ${selected}>${escapeHtml(pieceName)}</option>`;
    }).join("");
    
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Material de Refer√™ncia</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Pe√ßa</label>
        <select id="modal-biblioteca-piece">
          ${pieceOptions}
        </select>
      </div>
      <div class="form-group">
        <label>V√≠deo, Imagem ou PDF</label>
        <input type="file" id="modal-biblioteca-media" accept="video/*,image/*,application/pdf">
      </div>
      ${mediaSrc ? `
        <div style="margin-top:6px;">
          ${item.mediaType === 'image' ? 
            `<img src="${escapedMediaSrc}" style="max-width:100%;max-height:200px;border-radius:4px;" alt="${escapedPiece}">` :
            item.mediaType === 'pdf' ?
            `<iframe src="${escapedMediaSrc}" style="width:100%;height:200px;border:1px solid #ddd;border-radius:4px;" type="application/pdf"></iframe>` :
            `<video controls style="max-width:100%;max-height:200px;border-radius:4px;">
              <source src="${escapedMediaSrc}" type="video/mp4">
              Seu navegador n√£o suporta v√≠deos.
            </video>`
          }
        </div>` : ""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-biblioteca-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-biblioteca-save").addEventListener("click",async()=>{
      const newPiece = document.getElementById("modal-biblioteca-piece").value;
      const file = document.getElementById("modal-biblioteca-media").files[0];
      if(!newPiece){ alert("Selecione uma pe√ßa."); return; }
      
      item.piece = newPiece;
      if(file){ 
        item.media = file;
        item.video = null; // clear old video field
        item.videoUrl = null;
        item.imageUrl = null;
        item.pdfUrl = null;
        // Determine media type
        if(file.type.startsWith('image/')){
          item.mediaType = 'image';
        }else if(file.type === 'application/pdf'){
          item.mediaType = 'pdf';
        }else{
          item.mediaType = 'video';
        }
      }
      
      closeModal();
      renderBiblioteca();
      
      if(window.fbApi && window.fbApi.deleteBibliotecaItem && window.fbApi.saveBibliotecaItem){
        try{
          await window.fbApi.deleteBibliotecaItem(item.id);
          const saved = await window.fbApi.saveBibliotecaItem(item);
          const idx = bibliotecaItems.findIndex(i=>i.id===id);
          if(idx >= 0) bibliotecaItems[idx] = saved;
        }catch(e){
          console.error("Erro atualizar biblioteca Firebase",e);
        }
      }
    });
  }

  function openBibliotecaMaterialsModal(pieceName, items) {
    // Create modal container
    const modal = document.createElement("div");
    modal.className = "biblioteca-materials-modal";
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    };

    // Create modal content
    const content = document.createElement("div");
    content.className = "biblioteca-materials-modal-content";

    // Header
    const header = document.createElement("div");
    header.className = "biblioteca-materials-modal-header";
    
    const title = document.createElement("div");
    title.className = "biblioteca-materials-modal-title";
    title.textContent = pieceName;
    
    const closeBtn = document.createElement("button");
    closeBtn.className = "biblioteca-materials-modal-close-btn";
    closeBtn.innerHTML = "&times;";
    closeBtn.onclick = () => document.body.removeChild(modal);
    
    header.appendChild(title);
    header.appendChild(closeBtn);

    // Body
    const body = document.createElement("div");
    body.className = "biblioteca-materials-modal-body";

    if (!items || items.length === 0) {
      body.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">Nenhum material dispon√≠vel para esta pe√ßa.</div>';
    } else {
      const grid = document.createElement("div");
      grid.className = "biblioteca-materials-grid";

      items.forEach(item => {
        const materialItem = document.createElement("div");
        materialItem.className = "biblioteca-material-item";
        materialItem.onclick = () => openBibliotecaMediaModal(item);

        const thumb = document.createElement("div");
        thumb.className = "biblioteca-material-thumb";

        const mediaSrc = getBibliotecaMediaSrc(item);
        if (mediaSrc) {
          if (item.mediaType === 'image') {
            const img = document.createElement("img");
            img.src = mediaSrc;
            img.alt = pieceName;
            thumb.appendChild(img);
          } else if (item.mediaType === 'pdf') {
            // PDF thumbnail - show icon
            const pdfIcon = document.createElement("div");
            pdfIcon.style.cssText = "display:flex;align-items:center;justify-content:center;height:100%;background:#f0f0f0;font-size:48px;";
            pdfIcon.innerHTML = "üìÑ";
            thumb.appendChild(pdfIcon);
          } else {
            // Video
            const video = document.createElement("video");
            video.style.cssText = "width:100%;height:100%;object-fit:cover;pointer-events:none;";
            video.src = mediaSrc;
            thumb.appendChild(video);

            const playOverlay = document.createElement("div");
            playOverlay.className = "biblioteca-play-overlay";
            playOverlay.innerHTML = "‚ñ∂";
            playOverlay.style.cssText = "width:40px;height:40px;font-size:20px;";
            thumb.appendChild(playOverlay);
          }

          const typeBadge = document.createElement("div");
          typeBadge.className = "biblioteca-material-type-badge";
          let typeText = 'V√≠deo';
          if(item.mediaType === 'image') typeText = 'Imagem';
          if(item.mediaType === 'pdf') typeText = 'PDF';
          typeBadge.textContent = typeText;
          thumb.appendChild(typeBadge);
        } else {
          const noMedia = document.createElement("div");
          noMedia.style.cssText = "display:flex;align-items:center;justify-content:center;height:100%;color:#666;";
          noMedia.textContent = "Sem m√≠dia";
          thumb.appendChild(noMedia);
        }

        materialItem.appendChild(thumb);

        // Admin actions
        if (currentUser && currentUser.role === "admin") {
          const actions = document.createElement("div");
          actions.style.cssText = "padding:8px;display:flex;gap:6px;background:#f9fbff;";

          const editBtn = document.createElement("button");
          editBtn.className = "btn-icon";
          editBtn.textContent = "Editar";
          editBtn.style.cssText = "flex:1;font-size:12px;padding:4px 8px;";
          editBtn.onclick = (e) => {
            e.stopPropagation();
            document.body.removeChild(modal);
            openEditBibliotecaModal(item.id);
          };

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "btn-icon btn-delete";
          deleteBtn.textContent = "Remover";
          deleteBtn.style.cssText = "flex:1;font-size:12px;padding:4px 8px;";
          deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            if (!confirm(`Remover este material?`)) return;
            bibliotecaItems = bibliotecaItems.filter(i => i.id !== item.id);
            document.body.removeChild(modal);
            renderBiblioteca();
            if (window.fbApi && window.fbApi.deleteBibliotecaItem) {
              window.fbApi.deleteBibliotecaItem(item.id).catch(e => console.error("Erro deletar biblioteca Firebase", e));
            }
          };

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          materialItem.appendChild(actions);
        }

        grid.appendChild(materialItem);
      });

      body.appendChild(grid);
    }

    // Add "Adicionar Material" button for admins
    if (currentUser && currentUser.role === "admin") {
      const addMaterialBtn = document.createElement("button");
      addMaterialBtn.className = "btn-primary";
      addMaterialBtn.textContent = "+ Adicionar Material";
      addMaterialBtn.style.cssText = "width:100%;margin-top:16px;";
      addMaterialBtn.onclick = (e) => {
        e.stopPropagation();
        document.body.removeChild(modal);
        openAddMaterialForPieceModal(pieceName);
      };
      body.appendChild(addMaterialBtn);
    }

    content.appendChild(header);
    content.appendChild(body);
    modal.appendChild(content);
    document.body.appendChild(modal);
  }

  function openAddMaterialForPieceModal(pieceName) {
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Adicionar Material para ${escapeHtml(pieceName)}</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>V√≠deo, Imagem ou PDF *</label>
        <input type="file" id="modal-add-material-file" accept="video/*,image/*,application/pdf">
      </div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-add-material-save">Adicionar</button>
      </div>
    `);

    document.getElementById("modal-add-material-save").addEventListener("click", async () => {
      const file = document.getElementById("modal-add-material-file").files[0];
      if (!file) {
        alert("Selecione um v√≠deo, imagem ou PDF.");
        return;
      }

      let mediaType = 'video';
      if(file.type.startsWith('image/')){
        mediaType = 'image';
      }else if(file.type === 'application/pdf'){
        mediaType = 'pdf';
      }
      
      const newItem = {
        id: "bib" + Date.now() + "_" + Math.random().toString(36).substr(2, 9),
        piece: pieceName,
        media: file,
        mediaType: mediaType
      };

      bibliotecaItems.push(newItem);
      closeModal();
      renderBiblioteca();

      if (window.fbApi && window.fbApi.saveBibliotecaItem) {
        try {
          const saved = await window.fbApi.saveBibliotecaItem(newItem);
          const idx = bibliotecaItems.findIndex(i => i.id === newItem.id);
          if (idx >= 0) bibliotecaItems[idx] = saved;
          renderBiblioteca();
        } catch (e) {
          console.error("Erro salvar material na biblioteca Firebase", e);
          alert("Erro ao salvar material. Tente novamente.");
        }
      }
    });
  }

  // ===== SETTINGS / CONFIGURA√á√ïES =====
  
  function renderSettings(){
    const clientsList = document.getElementById("clients-list");
    const failureModesList = document.getElementById("failure-modes-list");
    const stationsList = document.getElementById("stations-list");
    
    if(!clientsList || !failureModesList || !stationsList) return;
    
    // Render Clients
    clientsList.innerHTML = PRODUCTION_CLIENTS.map((client, idx) => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f8f9fa;border:1px solid #e0e5f0;border-radius:4px;">
        <span style="flex:1;font-size:13px;">${escapeHtml(client)}</span>
        <button class="btn-icon" onclick="editClient(${idx})" style="padding:4px 8px;font-size:12px;">Editar</button>
        <button class="btn-icon" onclick="deleteClient(${idx})" style="padding:4px 8px;font-size:12px;background:#dc3545;">Excluir</button>
      </div>
    `).join("");
    
    // Render Failure Modes
    failureModesList.innerHTML = PRODUCTION_FAILURE_MODES.map((mode, idx) => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f8f9fa;border:1px solid #e0e5f0;border-radius:4px;">
        <span style="flex:1;font-size:13px;">${escapeHtml(mode)}</span>
        <button class="btn-icon" onclick="editFailureMode(${idx})" style="padding:4px 8px;font-size:12px;">Editar</button>
        <button class="btn-icon" onclick="deleteFailureMode(${idx})" style="padding:4px 8px;font-size:12px;background:#dc3545;">Excluir</button>
      </div>
    `).join("");
    
    // Render Stations
    stationsList.innerHTML = PRODUCTION_STATIONS.map((station, idx) => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f8f9fa;border:1px solid #e0e5f0;border-radius:4px;">
        <span style="flex:1;font-size:13px;">${escapeHtml(station)}</span>
        <button class="btn-icon" onclick="editStation(${idx})" style="padding:4px 8px;font-size:12px;">Editar</button>
        <button class="btn-icon" onclick="deleteStation(${idx})" style="padding:4px 8px;font-size:12px;background:#dc3545;">Excluir</button>
      </div>
    `).join("");
  }
  window.renderSettings = renderSettings;
  
  function addClient(){
    const input = document.getElementById("new-client-input");
    if(!input) return;
    
    const name = input.value.trim();
    if(!name){
      alert("Digite o nome do cliente");
      return;
    }
    
    if(PRODUCTION_CLIENTS.includes(name)){
      alert("Este cliente j√° existe");
      return;
    }
    
    PRODUCTION_CLIENTS.push(name);
    PRODUCTION_CLIENTS.sort();
    input.value = "";
    renderSettings();
    alert("Cliente adicionado com sucesso!");
  }
  window.addClient = addClient;
  
  function editClient(idx){
    const current = PRODUCTION_CLIENTS[idx];
    const newName = prompt("Editar cliente:", current);
    
    if(newName === null) return;
    if(!newName.trim()){
      alert("O nome n√£o pode estar vazio");
      return;
    }
    
    PRODUCTION_CLIENTS[idx] = newName.trim();
    PRODUCTION_CLIENTS.sort();
    renderSettings();
    alert("Cliente atualizado com sucesso!");
  }
  window.editClient = editClient;
  
  function deleteClient(idx){
    const client = PRODUCTION_CLIENTS[idx];
    if(!confirm(`Tem certeza que deseja excluir o cliente "${client}"?\n\nAten√ß√£o: Esta a√ß√£o n√£o pode ser desfeita.`)){
      return;
    }
    
    PRODUCTION_CLIENTS.splice(idx, 1);
    renderSettings();
    alert("Cliente exclu√≠do com sucesso!");
  }
  window.deleteClient = deleteClient;
  
  function addFailureMode(){
    const input = document.getElementById("new-failure-mode-input");
    if(!input) return;
    
    const name = input.value.trim();
    if(!name){
      alert("Digite o nome do modo de falha");
      return;
    }
    
    if(PRODUCTION_FAILURE_MODES.includes(name)){
      alert("Este modo de falha j√° existe");
      return;
    }
    
    PRODUCTION_FAILURE_MODES.push(name);
    PRODUCTION_FAILURE_MODES.sort();
    input.value = "";
    renderSettings();
    alert("Modo de falha adicionado com sucesso!");
  }
  window.addFailureMode = addFailureMode;
  
  function editFailureMode(idx){
    const current = PRODUCTION_FAILURE_MODES[idx];
    const newName = prompt("Editar modo de falha:", current);
    
    if(newName === null) return;
    if(!newName.trim()){
      alert("O nome n√£o pode estar vazio");
      return;
    }
    
    PRODUCTION_FAILURE_MODES[idx] = newName.trim();
    PRODUCTION_FAILURE_MODES.sort();
    renderSettings();
    alert("Modo de falha atualizado com sucesso!");
  }
  window.editFailureMode = editFailureMode;
  
  function deleteFailureMode(idx){
    const mode = PRODUCTION_FAILURE_MODES[idx];
    if(!confirm(`Tem certeza que deseja excluir o modo de falha "${mode}"?\n\nAten√ß√£o: Esta a√ß√£o n√£o pode ser desfeita.`)){
      return;
    }
    
    PRODUCTION_FAILURE_MODES.splice(idx, 1);
    renderSettings();
    alert("Modo de falha exclu√≠do com sucesso!");
  }
  window.deleteFailureMode = deleteFailureMode;
  
  function addStation(){
    const input = document.getElementById("new-station-input");
    if(!input) return;
    
    const name = input.value.trim();
    if(!name){
      alert("Digite o nome da esta√ß√£o/linha");
      return;
    }
    
    if(PRODUCTION_STATIONS.includes(name)){
      alert("Esta esta√ß√£o/linha j√° existe");
      return;
    }
    
    PRODUCTION_STATIONS.push(name);
    PRODUCTION_STATIONS.sort();
    input.value = "";
    renderSettings();
    alert("Esta√ß√£o/linha adicionada com sucesso!");
  }
  window.addStation = addStation;
  
  function editStation(idx){
    const current = PRODUCTION_STATIONS[idx];
    const newName = prompt("Editar esta√ß√£o/linha:", current);
    
    if(newName === null) return;
    if(!newName.trim()){
      alert("O nome n√£o pode estar vazio");
      return;
    }
    
    PRODUCTION_STATIONS[idx] = newName.trim();
    PRODUCTION_STATIONS.sort();
    renderSettings();
    alert("Esta√ß√£o/linha atualizada com sucesso!");
  }
  window.editStation = editStation;
  
  function deleteStation(idx){
    const station = PRODUCTION_STATIONS[idx];
    if(!confirm(`Tem certeza que deseja excluir a esta√ß√£o/linha "${station}"?\n\nAten√ß√£o: Esta a√ß√£o n√£o pode ser desfeita.`)){
      return;
    }
    
    PRODUCTION_STATIONS.splice(idx, 1);
    renderSettings();
    alert("Esta√ß√£o/linha exclu√≠da com sucesso!");
  }
  window.deleteStation = deleteStation;

  async function initAppAfterLogin(){
    loadInspectorPhotosFromLocalStorage();
    loadInspectionsFromLocalStorage();

    if(window.fbApi && window.fbApi.loadAll && !window._appDataLoaded){
      try{
        const data = await window.fbApi.loadAll();
        if(data.pieces && data.pieces.length) pieces = data.pieces;
        if(data.inspectors && data.inspectors.length) inspectors = data.inspectors;
        if(data.inspections && data.inspections.length) inspections = data.inspections;
        window._appDataLoaded = true;
        renderLoginInspectorSelect();
      }catch(err){
        console.error("Erro carregar Firebase:",err);
      }
    }

    // Carregar biblioteca
    if(window.fbApi && window.fbApi.loadBiblioteca){
      try{
        bibliotecaItems = await window.fbApi.loadBiblioteca();
      }catch(err){
        console.error("Erro carregar biblioteca:",err);
      }
    }

    // Auto-start checklist when piece is selected (event listener added later in this function)
    document.getElementById("btn-finish-checklist").addEventListener("click",finishChecklist);
    document.getElementById("btn-cancel-checklist").addEventListener("click",cancelChecklist);

    document.getElementById("btn-add-inspector").addEventListener("click",()=>{
      const name = document.getElementById("insp-name-input").value.trim();
      const shift = document.getElementById("insp-shift-input").value.trim();
      const file = document.getElementById("insp-photo-input").files[0];
      if(!name){ alert("Informe o nome do inspetor."); return; }
      if(!shift){ alert("Selecione o turno do inspetor."); return; }
      if(inspectors.some(i=>i.name.toLowerCase()===name.toLowerCase())){
        alert("J√° existe um inspetor com esse nome.");
        return;
      }

      const addInspector = (photoDataUrl)=>{
        inspectors.push({ name, pinHash:"", shift });
        if(photoDataUrl) inspectorPhotos[name]=photoDataUrl;
        saveInspectorPhotosToLocalStorage();
        renderInspectors();
        renderChecklistSelectors();
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
      };

      if(file){
        const reader = new FileReader();
        reader.onload = e=>addInspector(e.target.result);
        reader.readAsDataURL(file);
      }else{
        addInspector(null);
      }
    });

    document.getElementById("piece-items-selector").addEventListener("change",e=>{
      const idx = Number(e.target.value);
      renderPieceItemsList(idx);
    });

    document.getElementById("btn-add-piece").addEventListener("click",async()=>{
      const code = document.getElementById("piece-code-input").value.trim();
      const desc = document.getElementById("piece-desc-input").value.trim();
      const client = document.getElementById("piece-client-input").value.trim();
      const file = document.getElementById("piece-image-input").files[0];
      const hasSerial = document.getElementById("piece-has-serial-input").checked;
      if(!code || !desc || !client || !file){
        alert("Preencha c√≥digo, descri√ß√£o, cliente e imagem.");
        return;
      }
      if(pieces.some(p=>p.code===code)){
        alert("J√° existe uma pe√ßa com esse c√≥digo.");
        return;
      }
      const newPiece = {code,description:desc,client,image:file,imageUrl:null,items:[],hasSerialNumber:hasSerial};
      pieces.push(newPiece);
      renderPieces();
      renderChecklistSelectors();
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(newPiece).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
      
      // Auto-sync to biblioteca (create entry without media)
      const pieceName = `${code} - ${desc}`;
      const existingBibliotecaItem = bibliotecaItems.find(b=>b.piece===pieceName);
      if(!existingBibliotecaItem){
        const bibliotecaEntry = { piece: pieceName, media: null, videoUrl: null, imageUrl: null, mediaType: 'video' };
        if(window.fbApi && window.fbApi.saveBibliotecaItem){
          try{
            const saved = await window.fbApi.saveBibliotecaItem(bibliotecaEntry);
            bibliotecaItems.push(saved);
          }catch(e){
            console.error("Erro criar entrada na biblioteca:",e);
          }
        }else{
          bibliotecaEntry.id = `local_${Date.now()}`;
          bibliotecaItems.push(bibliotecaEntry);
        }
      }
      renderBiblioteca();
      
      // Clear form
      document.getElementById("piece-code-input").value="";
      document.getElementById("piece-desc-input").value="";
      document.getElementById("piece-client-input").value="";
      document.getElementById("piece-image-input").value="";
      document.getElementById("piece-has-serial-input").checked=false;
    });

    document.getElementById("btn-add-item").addEventListener("click",()=>{
      const pieceIdx = Number(document.getElementById("piece-items-selector").value);
      if(Number.isNaN(pieceIdx) || !pieces[pieceIdx]){
        alert("Selecione uma pe√ßa.");
        return;
      }
      const name = document.getElementById("item-name-input").value.trim();
      const desc = document.getElementById("item-desc-input").value.trim();
      const file = document.getElementById("item-image-input").files[0];
      const failureModeSelect = document.getElementById("item-failure-mode-input");
      const failureMode = failureModeSelect.value;
      
      if(!name || !desc || !file){
        alert("Preencha nome, descri√ß√£o e imagem do item.");
        return;
      }
      if(!failureMode){
        alert("Selecione o modo de falha.");
        return;
      }
      
      pieces[pieceIdx].items.push({name,description:desc,failureMode,image:file,imageUrl:null});
      document.getElementById("item-name-input").value="";
      document.getElementById("item-desc-input").value="";
      document.getElementById("item-image-input").value="";
      failureModeSelect.value = ""; // Clear selection
      renderPieceItemsList(pieceIdx);
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(pieces[pieceIdx]).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });
    
    // Auto-start checklist when piece is selected
    document.getElementById("piece-selector").addEventListener("change",()=>{
      startChecklist();
    });

    document.getElementById("btn-export-csv").addEventListener("click",exportCSV);
    const reportMonthSelect = document.getElementById("report-month-select");
    if(reportMonthSelect) reportMonthSelect.addEventListener("change",renderReports);

    // Dashboard filters
    const btnApplyFilters = document.getElementById("btn-apply-filters");
    if(btnApplyFilters) btnApplyFilters.addEventListener("click",applyDashboardFilters);

    // Populate client and station datalists
    function updateDataLists(){
      const clientList = document.getElementById("client-list");
      const stationList = document.getElementById("station-list");
      const clientSet = new Set();
      const stationSet = new Set();
      
      inspections.forEach(i=>{
        if(i.client) clientSet.add(i.client);
        if(i.station) stationSet.add(i.station);
      });
      
      if(clientList){
        clientList.innerHTML = Array.from(clientSet).map(c=>`<option value="${escapeHtml(c)}">`).join("");
      }
      if(stationList){
        stationList.innerHTML = Array.from(stationSet).map(s=>`<option value="${escapeHtml(s)}">`).join("");
      }
    }
    updateDataLists();

    // Biblioteca de Inspe√ß√µes
    document.getElementById("btn-add-biblioteca").addEventListener("click",async()=>{
      const pieceCode = document.getElementById("biblioteca-piece-select").value;
      const file = document.getElementById("biblioteca-media-input").files[0];
      
      if(!pieceCode || !file){
        alert("Selecione uma pe√ßa e um arquivo (v√≠deo, imagem ou PDF).");
        return;
      }

      // Determine media type
      let mediaType = 'video';
      if(file.type.startsWith('image/')){
        mediaType = 'image';
      }else if(file.type === 'application/pdf'){
        mediaType = 'pdf';
      }

      // Find or update existing biblioteca item
      const existingItem = bibliotecaItems.find(b=>b.piece===pieceCode);
      
      if(existingItem){
        // Update existing item with new media
        existingItem.media = file;
        existingItem.video = null; // clear old field
        existingItem.videoUrl = null;
        existingItem.imageUrl = null;
        existingItem.pdfUrl = null;
        existingItem.mediaType = mediaType;
        
        if(window.fbApi && window.fbApi.deleteBibliotecaItem && window.fbApi.saveBibliotecaItem){
          try{
            await window.fbApi.deleteBibliotecaItem(existingItem.id);
            const saved = await window.fbApi.saveBibliotecaItem(existingItem);
            const idx = bibliotecaItems.findIndex(i=>i.id===existingItem.id);
            if(idx >= 0) bibliotecaItems[idx] = saved;
          }catch(err){
            console.error("Erro atualizar biblioteca Firebase:", err);
            alert("Erro ao salvar no servidor. Tente novamente.");
          }
        }
      }else{
        // Create new item
        const newItem = { piece: pieceCode, media: file, mediaType, videoUrl: null, imageUrl: null, pdfUrl: null };
        
        if(window.fbApi && window.fbApi.saveBibliotecaItem){
          try{
            const saved = await window.fbApi.saveBibliotecaItem(newItem);
            bibliotecaItems.push(saved);
          }catch(err){
            console.error("Erro salvar biblioteca Firebase:", err);
            alert("Erro ao salvar no servidor. Tente novamente.");
          }
        }else{
          // Fallback local (sem Firebase)
          newItem.id = `local_${Date.now()}`;
          bibliotecaItems.push(newItem);
        }
      }
      
      renderBiblioteca();
    });

    renderChecklistSelectors();
    renderInspectors();
    renderPieces();
    renderReports();
    renderDashboard();
  }

  // Login
  document.addEventListener("DOMContentLoaded",()=>{
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const modeButtons = document.querySelectorAll(".login-mode-btn");
    let loginMode = "inspector";

    modeButtons.forEach(btn=>{
      btn.addEventListener("click",()=>{
        loginMode = btn.dataset.mode;
        modeButtons.forEach(b=>b.classList.toggle("active", b===btn));
        document.getElementById("login-inspector-fields").style.display =
          (loginMode==="inspector"?"block":"none");
        document.getElementById("login-admin-fields").style.display =
          (loginMode==="admin"?"block":"none");
        loginError.style.display="none";
      });
    });

    // pr√©-carrega dados (inclui inspetores) para preencher o select do login
    (async ()=>{
      if(window.fbApi && window.fbApi.loadAll && !window._appDataLoaded){
        try{
          const data = await window.fbApi.loadAll();
          if(data.pieces && data.pieces.length) pieces = data.pieces;
          if(data.inspectors && data.inspectors.length) inspectors = data.inspectors;
          if(data.inspections && data.inspections.length) inspections = data.inspections;
          window._appDataLoaded = true;
          renderLoginInspectorSelect();
        }catch(err){
          console.error("Erro carregar dados iniciais:",err);
        }
      }
    })();

    loginForm.addEventListener("submit",async (e)=>{
      e.preventDefault();
      loginError.style.display="none";
      loginError.textContent = "";

      if(loginMode==="admin"){
        const pin = document.getElementById("login-admin-pin").value.trim();
        if(pin !== ADMIN_PIN){
          loginError.textContent="Senha de administrador inv√°lida.";
          loginError.style.display="block";
          return;
        }
        currentUser = { role:"admin", name:"Administrador" };
        document.getElementById("login-screen").style.display="none";
        document.getElementById("app-root").style.display="flex";
        updateHeaderUser();
        updateSidebarForRole();
        await initAppAfterLogin();
      }else{
        const sel = document.getElementById("login-insp-select");
        const name = (sel && sel.value) ? sel.value.trim() : "";
        const pin = document.getElementById("login-insp-pin").value.trim();
        if(!name || !pin){
          loginError.textContent="Selecione o inspetor e informe o PIN.";
          loginError.style.display="block";
          return;
        }
        if(pin.length !== 4){
          loginError.textContent="O PIN deve ter 4 d√≠gitos.";
          loginError.style.display="block";
          return;
        }

        try{
          // garantir que dados foram carregados
          if(window.fbApi && window.fbApi.loadAll && !window._appDataLoaded){
            const data = await window.fbApi.loadAll();
            if(data.pieces && data.pieces.length) pieces = data.pieces;
            if(data.inspectors && data.inspectors.length) inspectors = data.inspectors;
            if(data.inspections && data.inspections.length) inspections = data.inspections;
            window._appDataLoaded = true;
            renderLoginInspectorSelect();
          }

          let insp = inspectors.find(i=>i.name === name);
          if(!insp){
            loginError.textContent = "Inspetor n√£o encontrado.";
            loginError.style.display="block";
            return;
          }

          const pinHash = await hashString(pin);
          if(!insp.pinHash){
            if(!confirm(`Nenhum PIN cadastrado para "${insp.name}". Deseja cadastrar este PIN agora?`)){
              return;
            }
            insp.pinHash = pinHash;
            if(window.fbApi && window.fbApi.setInspectors){
              try{
                await window.fbApi.setInspectors(inspectors);
              }catch(err){
                console.error("Erro salvar PIN:",err);
              }
            }
          }else if(insp.pinHash !== pinHash){
            loginError.textContent="PIN inv√°lido.";
            loginError.style.display="block";
            return;
          }

          currentUser = { role:"inspector", name: insp.name };
          document.getElementById("login-screen").style.display="none";
          document.getElementById("app-root").style.display="flex";
          updateHeaderUser();
          updateSidebarForRole();
          await initAppAfterLogin();

        }catch(err){
          console.error("Erro login inspetor:",err);
          loginError.textContent="Erro ao validar PIN. Tente novamente.";
          loginError.style.display="block";
        }
      }
    });
  });
  </script>
</body>
</html>

