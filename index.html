<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Magius - Sistema de Checklist de Inspeção</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
/* --- layout e estilos (base do seu projeto) --- */
body { font-family: Arial, sans-serif; background:#fff; color:#333; margin:0;}
.container { max-width:1200px; margin:32px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 0 10px #0001;}
.header { background:#003366; color:#fff; padding:15px 20px; border-radius:8px 8px 0 0; margin:-20px -20px 0 -20px; display:flex;justify-content:space-between;align-items:center;}
.header-left { display:flex; align-items:center; gap:12px; }
.header-circles { display:flex; gap:8px; align-items:center; }
.header-circles span{display:inline-block;width:18px;height:18px;border:2px solid #fff;border-radius:50%;}
.header-tagline { color:#fff; font-size:13px; line-height:1.1; font-weight:600; }
.header-brand { text-align:right; min-width:180px; }
.header-logo {font-size:22px; font-weight:800;}
.header-sub { font-size:12px;color:#cfe6ff;margin-top:4px;font-weight:600; }

/* nav abaixo do cabeçalho */
.main-nav {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:14px -20px 20px -20px;
  padding:12px 20px;
  background:transparent;
  border-radius:0 0 8px 8px;
}
.nav-left { display:flex; align-items:center; gap:10px; }
.btn-home {
  background:#093762;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 2px 6px #0001;
}
.nav-right { display:flex; flex-direction:column; gap:10px; align-items:flex-end; }
.nav-right .nav-btn { background:#0b4b7a;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;box-shadow:0 2px 6px #0001;min-width:140px;text-align:center;}
.nav-right .nav-btn.admin { background:#093762; }

/* login status */
.auth-info { font-size:14px;color:#093762;margin-left:6px;}

/* modal */
.modal-overlay {position: fixed; top:0; left:0; right:0; bottom:0;background: rgba(0,0,0,0.35);display: none; align-items:center; justify-content:center;z-index: 9999;}
.modal-box {background: #fff;border-radius: 12px;padding:22px;min-width:320px;max-width:90vw;position:relative;}
.modal-close {position:absolute; top:8px; right:8px;border:none;background:none;font-size:20px;color:#093762;cursor:pointer;}

/* restante dos estilos originais (compactados para o exemplo) */
.nav-btn,.btn-primary,.btn-secondary,.btn-checklist,#finalizar-inspecao-btn { background:#003366 !important;color:#fff !important;border:none;box-shadow:0 2px 6px #0001;}
.nav-btn,.btn-primary,.btn-checklist { padding:13px 32px;border-radius:9px;font-size:20px;font-weight:500;cursor:pointer;transition:background-color 0.2s;}
.btn-primary,.btn-secondary,.btn-checklist,#finalizar-inspecao-btn { padding:10px 20px;border-radius:5px;font-size:16px;font-weight:500;}
.btn-secondary {margin-left:10px;}
.nav-btn:hover,.btn-primary:hover,.btn-secondary:hover,.btn-checklist:hover,#finalizar-inspecao-btn:hover{background:#005bb5 !important; color:#fff;}
.edit-btn {
    background: #093762 !important;
    color: #fff !important;
    border-radius: 8px;
    cursor: pointer;
    width: 56px; height: 44px;padding:0;font-size:0;border:none;
    display:inline-flex;align-items:center;justify-content:center;
}
.edit-btn::before {
    content: '';display:inline-block;width:20px;height:20px;
    background-image: url('data:image/svg+xml;utf8,<svg fill="white" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M290.74,93.24,218.49,165.49,346.51,293.5,418.76,221.25C437.1,202.91,437.1,175,418.76,156.66Z"/><path d="M223.25,232.6l-20,20L87.27,347.68a16,16,0,0,0,0,22.62l54.57,54.58a16,16,0,0,0,22.62,0l95.88-95.89,20-20Z"/></svg>');
    background-size:20px 20px;background-repeat:no-repeat;
}
/* ... (manter o resto do CSS do seu projeto conforme já tinha) ... */

.screen {display:none;padding:20px 0;}
.screen.active {display:block;}
.checklist-item{display:flex;align-items:flex-start;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;padding:10px;transition:background 0.25s;position:relative;}
.checklist-piece-title{font-size:2.4em;font-weight:700;color:#003366;margin-bottom:15px;}
/* pequeno ajuste responsivo */
@media (max-width:700px) {
  .main-nav { flex-direction:column; align-items:flex-start; gap:10px; }
  .nav-right { flex-direction:row; gap:8px; align-items:center; }
  .nav-right .nav-btn { min-width:unset; padding:8px 12px; }
}
</style>
</head>
<body>
<div class="container">
  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="header-circles" aria-hidden="true">
        <span></span><span></span><span></span><span></span>
      </div>
      <div class="header-tagline">AJUDANDO A CONSTRUIR, CULTIVAR,<br>TRANSPORTAR E SEGUIR EM FRENTE</div>
    </div>
    <div class="header-brand">
      <div class="header-logo">MAGIUS</div>
      <div class="header-sub">METALÚRGICA INDUSTRIAL</div>
    </div>
  </div>

  <!-- NAV -->
  <div class="main-nav">
    <div class="nav-left">
      <button class="btn-home" onclick="showScreen('home')">Início</button>
      <span id="signed-as" class="auth-info" style="display:none;">Logado: <b id="auth-email"></b></span>
    </div>
    <div class="nav-right" role="navigation" aria-label="Navegação principal">
      <button class="nav-btn" onclick="showScreen('reports')">Relatórios</button>
      <button class="nav-btn admin" id="admin-btn" onclick="requestAdminAccess()">Admin</button>
      <div style="margin-top:8px;">
        <button id="signin-btn" class="btn-primary" onclick="openSignInModal()">Entrar</button>
        <button id="signout-btn" class="btn-secondary" style="display:none;" onclick="signOut()">Sair</button>
      </div>
    </div>
  </div>

  <!-- HOME -->
  <div id="home" class="screen active">
    <h2 style="font-size:2em;font-weight:700;margin-bottom:0.2em;">MAGIUS - Sistema de Checklist de Inspeção</h2>
    <div class="form-group">
      <label for="inspector">Inspetor:</label>
      <select id="inspector"><option value="" disabled selected>Selecionar inspetor</option></select>
    </div>
    <div class="form-group">
      <label for="piece">Peça:</label>
      <select id="piece"><option value="" disabled selected>Selecionar peça</option></select>
    </div>
    <button class="btn-checklist" onclick="showChecklist()">Iniciar Checklist</button>
  </div>

  <!-- CHECKLIST -->
  <div id="checklist" class="screen">
    <div class="checklist-piece-title" id="checklist-header"></div>
    <div id="piece-image-box" style="background-color:#f0f5fa;height:260px;margin-bottom:20px;display:flex;justify-content:center;align-items:center;border-radius:10px;">
        [Imagem aqui]
    </div>
    <div class="checklist-item-list" id="checklist-item-list"></div>
    <button class="btn-primary" id="finalizar-inspecao-btn" style="margin-top:20px;">Finalizar Inspeção</button>
    <div class="checklist-nok-library" id="checklist-nok-library"></div>
  </div>

  <!-- REPORTS -->
  <div id="reports" class="screen">
    <div class="report-header">Relatórios</div>
    <div class="report-controls">
      <button class="report-csv-btn" onclick="exportCSV()">Exportar CSV</button>
      <div class="report-total-volume">
        Total (todas inspeções): <span id="total-inspecoes" style="margin-left:10px;font-size:21px;">0</span>
      </div>
      <div>
        <label for="report-month-select" style="font-weight:500;margin-right:7px;">Selecionar mês:</label>
        <select id="report-month-select"></select>
      </div>
    </div>
    <div style="font-weight:600;margin-bottom:7px;">Volume mensal</div>
    <div id="volume-mensal-box"><span id="volume-mensal-num">0</span> inspeções</div>
    <div class="report-graph-area">
      <canvas id="graficoRosca" class="grafico-bola" width="140" height="140"></canvas>
      <div class="report-graph-legend"></div>
    </div>
    <div style="font-weight:600;margin-bottom:6px;">Histórico</div>
    <div class="report-history">
      <table class="report-history-table">
        <thead>
          <tr><th>Data</th><th>Inspetor</th><th>Peça</th><th>Descrição</th></tr>
        </thead>
        <tbody id="reports-history-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin" class="screen">
    <div class="activity-block">
      <div class="activity-header">Adicionar Peça</div>
      <div id="piece-form-fields">
        <div class="form-group">
          <label for="new-code">Código (Ex: 597-2445#01)</label>
          <input type="text" id="new-code" placeholder="Ex: 597-2445#01">
        </div>
        <div class="form-group">
          <label for="new-description">Descrição</label>
          <input type="text" id="new-description" placeholder="Longarina">
        </div>
        <div class="form-group">
          <label for="new-image">Imagem (obrigatória)</label>
          <input type="file" id="new-image">
          <p style="font-size:12px;margin-top:5px;" id="image-file-info">Nenhum arquivo escolhido</p>
        </div>
      </div>
      <div class="edit-control hide" id="edit-piece-controls">
        <button class="btn-primary" id="update-piece-btn">Salvar edição</button>
      </div>
      <button class="btn-primary" id="add-piece-btn" style="margin-right:10px;">Adicionar peça</button>
      <button class="btn-secondary" id="clear-piece-btn">Limpar</button>
      <h4 style="margin-top:30px;">Peças existentes</h4>
      <div class="admin-piece-list" id="admin-piece-list"></div>
    </div>

    <div class="activity-block">
      <div class="activity-header">Adicionar Item</div>
      <div class="form-group">
        <label for="select-piece-item">Selecionar peça</label>
        <select id="select-piece-item"></select>
      </div>
      <h5 style="margin-top:10px;">Itens atuais</h5>
      <div id="admin-piece-items-list"></div>
      <div id="item-form-fields">
        <div class="form-group">
          <label for="new-item-name">Novo item</label>
          <input type="text" id="new-item-name" placeholder="Dimensão X">
        </div>
        <div class="form-group">
          <label for="new-item-description">Descrição do item (obrigatória)</label>
          <textarea id="new-item-description"></textarea>
        </div>
        <div class="form-group">
          <label for="new-item-image">Imagem do item (obrigatória)</label>
          <input type="file" id="new-item-image">
          <p style="font-size:12px;margin-top:5px;" id="item-image-file-info">Nenhum arquivo escolhido</p>
        </div>
      </div>
      <div class="edit-control hide" id="edit-item-controls">
        <button class="btn-primary" id="update-piece-item-btn">Salvar edição</button>
      </div>
      <button class="btn-primary" id="add-piece-item-btn">Adicionar item</button>
    </div>

    <div class="activity-block">
      <div class="activity-header">Adicionar Inspetor</div>
      <div style="display:flex;">
        <input type="text" id="inspector-new-name" placeholder="Nome do inspetor" style="margin-right:10px;">
        <button class="btn-primary" id="add-inspector-btn" style="height:40px;">Adicionar</button>
        <button class="btn-secondary" id="clear-inspector-btn" style="height:40px;margin-left:5px;">Limpar</button>
      </div>
      <h4 style="margin-top:30px;">Inspetores</h4>
      <div class="admin-inspector-list" id="admin-inspector-list"></div>
    </div>
  </div>

  <div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div id="modal-box" class="modal-box"></div>
  </div>
</div>

<!-- SCRIPT PRINCIPAL (module: firebase + app logic + auth integration) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
  import {
    getAuth, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged, getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCAAowsqkoUjIAPhSvq6dUlKMZGdXOO1b0",
    authDomain: "magiuschecklist-9ad0f.firebaseapp.com",
    projectId: "magiuschecklist-9ad0f",
    storageBucket: "magiuschecklist-9ad0f.appspot.com",
    messagingSenderId: "14669686712",
    appId: "1:14669686712:web:1c205b1111cde18379114d",
    measurementId: "G-GQS591WCBD"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  // fallback admin email (you provided)
  const FALLBACK_ADMIN_EMAIL = "debora.cristina@magius.com.br";

  // upload helper
  async function uploadFileAndGetUrl(path, file) {
    if (!file) return null;
    const ref = sRef(storage, path);
    const metadata = { contentType: file.type || 'image/jpeg' };
    await uploadBytes(ref, file, metadata);
    return await getDownloadURL(ref);
  }

  // load data from Firestore
  async function loadAll() {
    // pieces
    const piecesSnap = await getDocs(collection(db, "pieces"));
    const pieces = piecesSnap.docs.map(d => {
      const data = d.data();
      return {
        code: data.code,
        description: data.description,
        image: null,
        imageUrl: data.imageUrl || null,
        items: (data.items || []).map(it => ({
          name: it.name,
          description: it.description,
          image: null,
          imageUrl: it.imageUrl || null
        }))
      };
    });

    // inspectors
    let inspectors = [];
    try {
      const inspRef = doc(db, "config", "inspectors");
      const inspSnap = await getDoc(inspRef);
      if (inspSnap.exists()) inspectors = inspSnap.data().list || [];
    } catch (e) {
      console.warn("config/inspectors not found:", e);
    }

    // inspections
    const inspecSnap = await getDocs(collection(db, "inspections"));
    const inspections = inspecSnap.docs.map(d => {
      const data = d.data();
      return {
        id: d.id,
        date: data.date,
        inspector: data.inspector,
        piece: data.piece,
        descricao: data.descricao || "",
        itens: (data.itens || []).map(it => ({
          status: it.status,
          motivo: it.motivo,
          encaminhamento: it.encaminhamento,
          nome_terceiro: it.nome_terceiro || "",
          foto: null,
          fotoUrl: it.fotoUrl || null
        }))
      };
    });

    return { pieces, inspectors, inspections };
  }

  async function savePiece(piece) {
    if (!piece || !piece.code) return;
    let imageUrl = piece.imageUrl || null;

    if (piece.image instanceof File) {
      const ext = (piece.image.name && piece.image.name.split('.').pop()) || 'jpg';
      imageUrl = await uploadFileAndGetUrl(`pieces/${piece.code}/main_${Date.now()}.${ext}`, piece.image);
    }

    const itemsToSave = [];
    for (let idx = 0; idx < (piece.items || []).length; idx++) {
      const it = piece.items[idx];
      let itemImageUrl = it.imageUrl || null;
      if (it.image instanceof File) {
        const ext = (it.image.name && it.image.name.split('.').pop()) || 'jpg';
        itemImageUrl = await uploadFileAndGetUrl(`pieces/${piece.code}/items/${idx}_${Date.now()}.${ext}`, it.image);
      }
      itemsToSave.push({
        name: it.name,
        description: it.description,
        imageUrl: itemImageUrl
      });
    }

    const ref = doc(db, "pieces", piece.code);
    await setDoc(ref, {
      code: piece.code,
      description: piece.description,
      imageUrl,
      items: itemsToSave
    });
  }

  async function deletePiece(code) {
    if (!code) return;
    await deleteDoc(doc(db, "pieces", code));
  }

  async function setInspectors(list) {
    const ref = doc(db, "config", "inspectors");
    await setDoc(ref, { list: list || [] });
  }

  async function saveInspection(inspec) {
    const timeStamp = Date.now();
    const itensToSave = [];

    for (let idx = 0; idx < (inspec.itens || []).length; idx++) {
      const it = inspec.itens[idx];
      let fotoUrl = it.fotoUrl || null;
      if (it.foto instanceof File) {
        const ext = (it.foto.name && it.foto.name.split('.').pop()) || 'jpg';
        fotoUrl = await uploadFileAndGetUrl(
          `inspections/${inspec.piece}/${timeStamp}_${idx}.${ext}`,
          it.foto
        );
      }
      itensToSave.push({
        status: it.status,
        motivo: it.motivo,
        encaminhamento: it.encaminhamento,
        nome_terceiro: it.nome_terceiro || "",
        fotoUrl
      });
    }

    const docData = {
      date: inspec.date,
      inspector: inspec.inspector,
      piece: inspec.piece,
      descricao: inspec.descricao || "",
      itens: itensToSave
    };
    const ref = await addDoc(collection(db, "inspections"), docData);
    return { id: ref.id, ...docData };
  }

  // expose api for legacy code usage
  window.fbApi = {
    loadAll,
    savePiece,
    deletePiece,
    setInspectors,
    saveInspection
  };

  // ----------------- Now integrate UI logic (rendering / handlers) -----------------
  // copy of your original client-side logic (adapted to use the fbApi above)
  // initial local state
  let pieces = [
    {
      code: "597-2445#01",
      description: "Longarina",
      image: null,
      imageUrl: null,
      items: [
        { name: "Dimensão A (Ø)", description: "Verificar diâmetro da furação.", image: null, imageUrl:null },
        { name: "Furo B posição", description: "Conferir posição do furo de encaixe.", image: null, imageUrl:null },
        { name: "Solda - qualidade", description: "Avaliar acabamento da solda.", image: null, imageUrl:null }
      ]
    },
    {
      code: "597-2435#01",
      description: "Longarina",
      image: null,
      imageUrl: null,
      items: []
    }
  ];
  let inspectors = ["João Silva","Maria Santos"];
  let inspections = [];
  let checklistItemStates = [];
  let checklistCurrentPiece = null;

  const screens = {
    'home': document.getElementById('home'),
    'checklist': document.getElementById('checklist'),
    'reports': document.getElementById('reports'),
    'admin': document.getElementById('admin')
  };

  function showModal(html, onclose) {
    const overlay = document.getElementById('modal-overlay');
    const box = document.getElementById('modal-box');
    box.innerHTML = html;
    overlay.style.display = 'flex';

    const closeBtn = box.querySelector('.modal-close');
    if (closeBtn) {
      closeBtn.onclick = function() {
        overlay.style.display = 'none';
        box.innerHTML = '';
        if (onclose) onclose();
      };
    }
    overlay.onclick = function(e) {
      if (e.target === overlay) {
        overlay.style.display = 'none';
        box.innerHTML = '';
        if (onclose) onclose();
      }
    };
  }

  function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('modal-box').innerHTML = '';
  }

  function showImageModal(src) {
    if (!src) return;
    showModal(`
      <button class="modal-close" title="Fechar">&times;</button>
      <img src="${src}" style="max-width:80vw;max-height:80vh;display:block;margin:auto;border-radius:10px;box-shadow:0 6px 22px #0002;">
    `);
  }

  document.addEventListener("click", function(event) {
    if(event.target.closest(".edit-btn")) {
      const btn = event.target.closest(".edit-btn");
      const pieceIdx = btn.getAttribute('data-pieceidx');
      const itemIdx = btn.getAttribute('data-itemidx');
      if (itemIdx !== null && itemIdx !== undefined && itemIdx !== "") {
        editPieceItem(parseInt(pieceIdx), parseInt(itemIdx));
      } else {
        editPiece(parseInt(pieceIdx));
      }
    }
    if(event.target.closest(".remove-btn")) {
      const btn = event.target.closest(".remove-btn");
      const pieceIdx = btn.getAttribute('data-pieceidx');
      const itemIdx = btn.getAttribute('data-itemidx');
      const inspIdx = btn.getAttribute('data-inspectoridx');
      if (inspIdx !== null && inspIdx !== undefined && inspIdx !== "") {
        removeInspector(parseInt(inspIdx));
      } else if (itemIdx !== null && itemIdx !== undefined && itemIdx !== "") {
        removePieceItem(parseInt(pieceIdx), parseInt(itemIdx));
      } else {
        removePiece(parseInt(pieceIdx));
      }
    }
  });

  function showScreen(screenId) {
    for (let key in screens) screens[key].classList.remove('active');
    if (screens[screenId]) screens[screenId].classList.add('active');
    if (screenId === "home") renderHome();
    if (screenId === "admin") renderAdmin();
    if (screenId === "checklist") renderChecklist();
    if (screenId === "reports") renderReports();
  }

  function renderHome() {
    const inspSel = document.getElementById("inspector");
    inspSel.innerHTML = '<option value="" disabled selected>Selecionar inspetor</option>' +
        inspectors.map(i=>`<option value="${i}">${i}</option>`).join('');
    const pieceSel = document.getElementById("piece");
    pieceSel.innerHTML = '<option value="" disabled selected>Selecionar peça</option>' +
        pieces.map(p=>`<option value="${p.code}">${p.code}</option>`).join('');
  }

  function showChecklist() {
    const piece = document.getElementById('piece').value;
    const insp = document.getElementById('inspector').value;
    if(!piece || !insp) { alert("Selecione um inspetor e uma peça!"); return;}
    checklistCurrentPiece = pieces.find(p => p.code === piece);
    checklistItemStates = (checklistCurrentPiece?.items||[]).map(()=>({
        status:null,motivo:"",foto:null,fotoUrl:null,encaminhamento:"",nome_terceiro:""
    }));
    showScreen('checklist');
    renderChecklist();
  }

  function getPieceImageSrc(piece) {
    if (!piece) return null;
    if (piece.image instanceof File) return URL.createObjectURL(piece.image);
    if (piece.imageUrl) return piece.imageUrl;
    return null;
  }
  function getItemImageSrc(item) {
    if (!item) return null;
    if (item.image instanceof File) return URL.createObjectURL(item.image);
    if (item.imageUrl) return item.imageUrl;
    return null;
  }
  function getFotoSrc(it) {
    if (it.foto instanceof File) return URL.createObjectURL(it.foto);
    if (it.fotoUrl) return it.fotoUrl;
    return null;
  }

  function renderChecklist() {
    const headerEl = document.getElementById('checklist-header');
    const pieceImgBox = document.getElementById("piece-image-box");
    headerEl.textContent = checklistCurrentPiece ? checklistCurrentPiece.code : "";

    const mainImgSrc = getPieceImageSrc(checklistCurrentPiece);
    pieceImgBox.innerHTML = mainImgSrc
        ? `<img src="${mainImgSrc}" style="max-width:100%; max-height:240px; cursor:pointer; border-radius:10px;" onclick="showImageModal('${mainImgSrc}')">`
        : `[Imagem aqui]`;

    document.getElementById("checklist-item-list").innerHTML = (checklistCurrentPiece?.items||[]).map((item, idx) => {
        const state = checklistItemStates[idx];
        let divClass = "checklist-item";
        if(state.status==='OK') divClass += " ok";
        if(state.status==='NOK') divClass += " not-ok";

        const itemImgSrc = getItemImageSrc(item);
        let fileThumb = itemImgSrc
            ? `<img src="${itemImgSrc}" style="width:120px;height:120px;object-fit:cover;border-radius:10px;cursor:pointer;" onclick="showImageModal('${itemImgSrc}')">`
            : `<div style="background-color:#e9ecef; width:120px; height:120px; border-radius:10px;"></div>`;

        let extra = "";
        if(state.status==='NOK') {
            const fotoExistingSrc = getFotoSrc(state);
            extra = `
            <div class="checklist-extra-wrapper">
                <div class="checklist-extra-block" id="extra_box_${idx}">
                    <div class="checklist-extra-label">Descrição da não conformidade <span style="color:#e23636">(obrigatório)</span>:</div>
                    <textarea id="motivo_${idx}" placeholder="Descreva o motivo">${state.motivo||''}</textarea>
                    <div class="checklist-extra-label" style="margin-bottom:2px;">Foto <span style="color:#e23636">(obrigatório)</span>:</div>
                    <input type="file" id="foto_${idx}" accept="image/*">
                    <div class="checklist-radio-group" style="margin-top:10px;">
                        <label><input type="radio" name="encaminhar_${idx}" value="retrabalho" ${state.encaminhamento==="retrabalho"?"checked":""}> Encaminhar para retrabalho</label>
                        <label><input type="radio" name="encaminhar_${idx}" value="terceiro" ${state.encaminhamento==="terceiro"?"checked":""}> Aprovado por terceiro</label>
                    </div>
                    ${state.encaminhamento=="terceiro"?`
                    <div class="checklist-terceiro-nome-box">
                        <label for="nome_terceiro_${idx}">Nome ou matrícula do aprovador:</label>
                        <input type="text" id="nome_terceiro_${idx}" value="${state.nome_terceiro||''}">
                    </div>`:""}
                    ${fotoExistingSrc ? `<img src="${fotoExistingSrc}" style="width:120px;height:120px;object-fit:cover;border-radius:10px;margin-top:9px;cursor:pointer;" onclick="showImageModal('${fotoExistingSrc}')">` : ""}
                </div>
            </div>
            `;
        }
        return `<div class="${divClass}">
            <div style="display:flex;flex-direction:column;flex-grow:1;">
              <div style="display:flex;align-items:center;">
                ${fileThumb}
                <div class="checklist-item-info">
                  <strong>${item.name}</strong><br>
                  <small>${item.description||''}</small>
                </div>
                <div class="checklist-item-actions">
                  <button class="btn-ok" data-idx="${idx}">OK</button>
                  <button class="btn-nao-ok" data-idx="${idx}">NÃO OK</button>
                </div>
              </div>
              ${extra}
            </div>
        </div>`;
    }).join('');

    document.querySelectorAll(".checklist-item-actions .btn-ok").forEach(btn=>{
        btn.onclick = function(){
            let idx = parseInt(btn.dataset.idx);
            checklistItemStates[idx] = {
              status:"OK",motivo:"",foto:null,fotoUrl:null,encaminhamento:"",nome_terceiro:""
            };
            renderChecklist();
        };
    });
    document.querySelectorAll(".checklist-item-actions .btn-nao-ok").forEach(btn=>{
        btn.onclick = function(){
            let idx = parseInt(btn.dataset.idx);
            if (!checklistItemStates[idx]) checklistItemStates[idx] = {};
            checklistItemStates[idx].status = "NOK";
            renderChecklist();
        };
    });

    checklistItemStates.forEach((st, idx) => {
        if(st.status==='NOK') {
            let motivoEl = document.getElementById('motivo_'+idx);
            let fotoEl = document.getElementById('foto_'+idx);
            let nomeTerceiroEl = document.getElementById("nome_terceiro_"+idx);
            let retrabalhoRadio = document.querySelector('input[name="encaminhar_'+idx+'"][value="retrabalho"]');
            let terceiroRadio = document.querySelector('input[name="encaminhar_'+idx+'"][value="terceiro"]');
            motivoEl.oninput = ()=>{ checklistItemStates[idx].motivo = motivoEl.value; }
            fotoEl.onchange = ()=>{ 
              checklistItemStates[idx].foto = fotoEl.files[0]||null; 
              checklistItemStates[idx].fotoUrl = null;
              renderChecklist(); 
            };
            if(retrabalhoRadio){
                retrabalhoRadio.onchange = ()=>{
                    checklistItemStates[idx].encaminhamento = "retrabalho";
                    renderChecklist();
                };
            }
            if(terceiroRadio){
                terceiroRadio.onchange = ()=>{
                    checklistItemStates[idx].encaminhamento = "terceiro";
                    renderChecklist();
                };
            }
            if(nomeTerceiroEl){
                nomeTerceiroEl.oninput = ()=>{ checklistItemStates[idx].nome_terceiro = nomeTerceiroEl.value; }
            }
        }
    });
    renderNokLibrary();

    document.getElementById("finalizar-inspecao-btn").onclick = function() {
      for (let i = 0; i < checklistItemStates.length; i++) {
        const state = checklistItemStates[i];
        if (!state.status) {
          alert("Responda todos os itens do checklist.");
          return;
        }
        if (state.status === "NOK") {
          if (!state.motivo || !state.motivo.trim()) {
            alert("Preencha o motivo para todos itens NÃO OK.");
            return;
          }
          if (!state.foto && !state.fotoUrl) {
            alert("Insira uma foto evidência para todos itens NÃO OK.");
            return;
          }
          if (!state.encaminhamento) {
            alert("Escolha um encaminhamento para todos itens NÃO OK.");
            return;
          }
          if (state.encaminhamento === "terceiro" && (!state.nome_terceiro || !state.nome_terceiro.trim())) {
            alert("Informe o nome ou matrícula do aprovador terceiro.");
            return;
          }
        }
      }
      const now = new Date();
      const inspectionToSave = {
        date: now.toLocaleDateString('pt-BR'),
        inspector: document.getElementById('inspector').value,
        piece: checklistCurrentPiece.code,
        descricao: 'Inspeção realizada com sucesso',
        itens: checklistItemStates.map(s => ({
          status: s.status,
          motivo: s.motivo,
          encaminhamento: s.encaminhamento,
          nome_terceiro: s.nome_terceiro,
          foto: s.foto || null,
          fotoUrl: s.fotoUrl || null
        }))
      };

      if (window.fbApi && window.fbApi.saveInspection) {
        window.fbApi.saveInspection(inspectionToSave)
          .then(saved => {
            inspections.push(saved);
            alert("Inspeção finalizada e salva no Firebase!");
            showScreen('home');
            renderReports();
          })
          .catch(e => {
            console.error("Erro ao salvar inspeção no Firebase:", e);
            inspections.push({
              ...inspectionToSave,
              itens: inspectionToSave.itens.map(it => ({ ...it, foto:null, fotoUrl:null }))
            });
            alert("Erro ao salvar no servidor. Inspeção salva só localmente neste navegador.");
            showScreen('home');
            renderReports();
          });
      } else {
        inspections.push({
          ...inspectionToSave,
          itens: inspectionToSave.itens.map(it => ({ ...it, foto:null, fotoUrl:null }))
        });
        alert("Inspeção finalizada (somente local).");
        showScreen('home');
        renderReports();
      }
    };
  }

  function renderNokLibrary() {
    const nokDiv = document.getElementById('checklist-nok-library');
    const pieceCode = checklistCurrentPiece?.code || "";
    const nokCases = inspections
      .filter(i => i.piece === pieceCode)
      .flatMap(i =>
        (i.itens || [])
          .map((it, idx) => ({...it, inspection: i, idx}))
          .filter(it => it.status === 'NOK')
      );
    if (!nokCases.length) {
      nokDiv.innerHTML = `<div style="color:#888;font-weight:500;padding:13px 0;">Nenhum caso de reprovação para esta peça.</div>`;
      return;
    }
    nokDiv.innerHTML = `
      <div class="checklist-nok-title">Histórico de Casos de Reprovação (${nokCases.length})</div>
      <div class="checklist-nok-library-list">
        ${nokCases.map(caso => {
          const src = getFotoSrc(caso);
          return `
          <div class="checklist-nok-case">
            <strong>${caso.inspection.date}</strong><br/>
            <span style="font-size:95%;">Inspetor: <span style="color:#093762;">${caso.inspection.inspector}</span></span><br>
            <span style="font-size:95%;color:#c22;">${caso.motivo}</span><br>
            <span style="font-size:90%;">Encaminhamento: <b>${caso.encaminhamento}</b>${caso.encaminhamento==="terceiro"?"<br>Terceiro aprovador: <b>"+caso.nome_terceiro+"</b>":""}</span><br>
            ${src ? `<img src="${src}" onclick="showImageModal('${src}')" alt="foto não conforme">` : ``}
          </div>`;
        }).join('')}
      </div>
    `;
  }

  // Admin/edit handlers (same logic as previously)
  function editPiece(idx){
    const p = pieces[idx];
    showModal(`
      <button class="modal-close" title="Fechar">&times;</button>
      <div class="modal-title">Editar Peça</div>
      <div class="modal-form-row"><label>Código:</label>
        <input type="text" id="modal-edit-code" value="${p.code}">
      </div>
      <div class="modal-form-row"><label>Descrição:</label>
        <input type="text" id="modal-edit-desc" value="${p.description}">
      </div>
      <div class="modal-form-row"><label>Imagem:</label>
        <input type="file" id="modal-edit-img">
        <span>${p.image ? (p.image.name || 'Imagem existente') : (p.imageUrl ? 'Imagem já salva' : "Nenhum arquivo escolhido")}</span>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:15px;">
        <button class="btn-primary" id="modal-save-edit">Salvar</button>
      </div>
    `);
    setTimeout(function() {
      document.getElementById('modal-save-edit').onclick = function(){
        const code = document.getElementById('modal-edit-code').value.trim();
        const desc = document.getElementById('modal-edit-desc').value.trim();
        const imgFile = document.getElementById('modal-edit-img').files[0];
        if (!code || !desc) return alert("Preencha todos os campos!");
        p.code = code; 
        p.description = desc;
        if(imgFile) {
          p.image = imgFile;
          p.imageUrl = null;
        }
        closeModal();
        renderAdmin(); 
        renderHome();

        if (window.fbApi && window.fbApi.savePiece) {
          window.fbApi.savePiece(p).catch(e => {
            console.error("Erro ao salvar peça no Firebase:", e);
            alert("Erro ao enviar imagem/peça ao Firebase. Verifique console para detalhes.");
          });
        }
      };
    }, 0);
  };

  function removePiece(idx){
    const p = pieces[idx];
    showModal(`
      <button class="modal-close" title="Fechar">&times;</button>
      <div class="modal-title" style="margin-bottom:10px;">Confirma excluir esta Peça?</div>
      <div style="margin-bottom:25px;">Essa ação não pode ser desfeita.</div>
      <div style="display:flex;justify-content:flex-end;gap:15px;">
        <button class="btn-primary" id="modal-confirm-delete">Excluir</button>
      </div>
    `);
    setTimeout(function() {
      document.getElementById('modal-confirm-delete').onclick = function(){
        const codeToDelete = p.code;
        pieces.splice(idx,1);
        closeModal();
        renderAdmin(); 
        renderHome();

        if (window.fbApi && window.fbApi.deletePiece) {
          window.fbApi.deletePiece(codeToDelete).catch(e => {
            console.error("Erro ao apagar peça no Firebase:", e);
          });
        }
      };
    }, 0);
  };

  function editPieceItem(pieceIdx,itemIdx){
    const item = pieces[pieceIdx].items[itemIdx];
    showModal(`
      <button class="modal-close" title="Fechar">&times;</button>
      <div class="modal-title">Editar Item</div>
      <div class="modal-form-row"><label>Nome:</label>
        <input type="text" id="modal-edit-name" value="${item.name}">
      </div>
      <div class="modal-form-row"><label>Descrição:</label>
        <input type="text" id="modal-edit-desc" value="${item.description}">
      </div>
      <div class="modal-form-row"><label>Imagem:</label>
        <input type="file" id="modal-edit-img">
        <span>${item.image ? (item.image.name || 'Imagem existente') : (item.imageUrl ? 'Imagem já salva' : "Nenhum arquivo escolhido")}</span>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:15px;">
        <button class="btn-primary" id="modal-save-edit">Salvar</button>
      </div>
    `);
    setTimeout(function() {
      document.getElementById('modal-save-edit').onclick = function(){
        const name = document.getElementById('modal-edit-name').value.trim();
        const desc = document.getElementById('modal-edit-desc').value.trim();
        const imgFile = document.getElementById('modal-edit-img').files[0];
        if (!name || !desc) return alert("Preencha todos os campos!");
        item.name = name; 
        item.description = desc;
        if(imgFile) {
          item.image = imgFile;
          item.imageUrl = null;
        }
        closeModal();
        renderAdminPieceItems();

        if (window.fbApi && window.fbApi.savePiece) {
          window.fbApi.savePiece(pieces[pieceIdx]).catch(e => {
            console.error("Erro ao salvar item no Firebase:", e);
          });
        }
      };
    }, 0);
  };

  function removePieceItem(pieceIdx,itemIdx){
    showModal(`
      <button class="modal-close" title="Fechar">&times;</button>
      <div class="modal-title" style="margin-bottom:10px;">Confirma excluir este Item?</div>
      <div style="margin-bottom:25px;">Esta ação não pode ser desfeita.</div>
      <div style="display:flex;justify-content:flex-end;gap:15px;">
        <button class="btn-primary" id="modal-confirm-del-item">Excluir</button>
      </div>
    `);
    setTimeout(function () {
      document.getElementById('modal-confirm-del-item').onclick = function(){
        pieces[pieceIdx].items.splice(itemIdx,1);
        closeModal();
        renderAdminPieceItems();

        if (window.fbApi && window.fbApi.savePiece) {
          window.fbApi.savePiece(pieces[pieceIdx]).catch(e => {
            console.error("Erro ao salvar peça no Firebase:", e);
          });
        }
      };
    }, 0);
  };

  // Admin UI actions
  document.getElementById("add-piece-btn").onclick = function() {
    if (!window.isAdminUser) return alert('Apenas administradores podem adicionar peças.');
    const code = document.getElementById("new-code").value.trim();
    const desc = document.getElementById("new-description").value.trim();
    const imgInput = document.getElementById("new-image");
    const imgFile = imgInput.files[0];
    if (!code || !desc || !imgFile) {
        alert("Preencha todos os campos de peça!");
        return;
    }
    const newPiece = {code, description:desc, image:imgFile, imageUrl:null, items:[]};
    pieces.push(newPiece);
    renderAdmin(); 
    renderHome();

    if (window.fbApi && window.fbApi.savePiece) {
      window.fbApi.savePiece(newPiece).catch(e => {
        console.error("Erro ao salvar peça no Firebase:", e);
        alert("Erro ao enviar imagem/peça ao Firebase. Verifique as regras de Storage e o console.");
      });
    }
  };

  document.getElementById("clear-piece-btn").onclick = function(){
    document.getElementById('new-code').value = "";
    document.getElementById('new-description').value = "";
    document.getElementById('new-image').value = "";
    document.getElementById('image-file-info').textContent = "Nenhum arquivo escolhido";
  };

  document.getElementById("new-image").onchange = function(e){
    let txt = e.target.files[0] ? e.target.files[0].name : "Nenhum arquivo escolhido";
    document.getElementById('image-file-info').textContent = txt;
  };

  document.getElementById("add-piece-item-btn").onclick = function(){
    if (!window.isAdminUser) return alert('Apenas administradores podem adicionar itens.');
    let idx = document.getElementById("select-piece-item").value;
    let name = document.getElementById("new-item-name").value.trim();
    let desc = document.getElementById("new-item-description").value.trim();
    let imgFile = document.getElementById("new-item-image").files[0];
    if (!idx && idx !== 0) { alert("Selecione uma peça!"); return; }
    if (!name || !desc || !imgFile) {
        alert("Preencha todos os campos, incluindo imagem!");
        return;
    }
    pieces[idx].items.push({name, description:desc, image:imgFile, imageUrl:null});
    renderAdminPieceItems();
    document.getElementById("new-item-name").value = "";
    document.getElementById("new-item-description").value = "";
    document.getElementById("new-item-image").value = "";
    document.getElementById("item-image-file-info").textContent = "Nenhum arquivo escolhido";

    if (window.fbApi && window.fbApi.savePiece) {
      window.fbApi.savePiece(pieces[idx]).catch(e => {
        console.error("Erro ao salvar peça no Firebase:", e);
      });
    }
  };

  document.getElementById("select-piece-item").onchange = renderAdminPieceItems;

  document.getElementById("new-item-image").onchange = function(e){
    let txt = e.target.files[0] ? e.target.files[0].name : "Nenhum arquivo escolhido";
    document.getElementById('item-image-file-info').textContent = txt;
  };

  document.getElementById("add-inspector-btn").onclick = function() {
    if (!window.isAdminUser) return alert('Apenas administradores podem adicionar inspetores.');
    const name = document.getElementById("inspector-new-name").value.trim();
    if (!name) { alert("Digite o nome do inspetor!"); return; }
    if (inspectors.includes(name)) { alert("Já existe esse inspetor!"); return;}
    inspectors.push(name); 
    renderAdmin(); 
    renderHome();

    if (window.fbApi && window.fbApi.setInspectors) {
      window.fbApi.setInspectors(inspectors).catch(e => {
        console.error("Erro ao salvar inspetores no Firebase:", e);
      });
    }
  };

  document.getElementById("clear-inspector-btn").onclick = function(){
    document.getElementById("inspector-new-name").value = "";
  };

  function removeInspector(idx){
    if (!window.isAdminUser) return alert('Apenas administradores podem remover inspetores.');
    inspectors.splice(idx,1); 
    renderAdmin(); 
    renderHome();

    if (window.fbApi && window.fbApi.setInspectors) {
      window.fbApi.setInspectors(inspectors).catch(e => {
        console.error("Erro ao salvar inspetores no Firebase:", e);
      });
    }
  }

  function renderAdmin() {
    let pieceListDiv = document.getElementById("admin-piece-list");
    pieceListDiv.innerHTML = pieces.map((p,idx) => {
        const imgSrc = getPieceImageSrc(p);
        const thumb = imgSrc
          ? `<img src="${imgSrc}" style="width:50px;height:40px;border-radius:4px;object-fit:cover;">`
          : `<div style="width:50px;height:40px;background-color:#eee;margin-right:10px;border-radius:4px;display:flex;align-items:center;justify-content:center;">Sem imagem</div>`;
        return `
        <div class="admin-piece-item">
            ${thumb}
            <span>${p.code} — ${p.description}</span>
            <div>
                <button class="edit-btn" data-pieceidx="${idx}"></button>
                <button class="remove-btn" data-pieceidx="${idx}"></button>
            </div>
        </div>`;
    }).join('');

    let selectPieceItem = document.getElementById("select-piece-item");
    selectPieceItem.innerHTML = pieces.map((p,idx)=>`<option value="${idx}">${p.code} — ${p.description}</option>`).join('');
    renderAdminPieceItems();

    let inspList = document.getElementById("admin-inspector-list");
    inspList.innerHTML = inspectors.map((i,idx)=>
        `<div class="admin-inspector-item">
            <span>${i}</span>
            <button class="remove-btn" data-inspectoridx="${idx}"></button>
        </div>`
    ).join('');
    document.getElementById("inspector-new-name").value = "";
  }

  function renderAdminPieceItems(){
    let idx = document.getElementById("select-piece-item").value;
    if (idx==undefined || idx === "") return;
    let itemsBox = document.getElementById("admin-piece-items-list");
    let items = pieces[idx].items||[];
    itemsBox.innerHTML = items.map((item,i)=>{
        const imgSrc = getItemImageSrc(item);
        const icon = imgSrc ? `<img src="${imgSrc}" style="width:22px;height:22px;border-radius:3px;margin-right:4px;object-fit:cover;">` : "";
        return `
        <div class="admin-item-line"><div class="item-label-box">
            ${icon}
            <span>${item.name}</span></div>
            <div>
                <button class="edit-btn" data-pieceidx="${idx}" data-itemidx="${i}"></button>
                <button class="remove-btn" data-pieceidx="${idx}" data-itemidx="${i}"></button>
            </div>
        </div>`;
    }).join('');
  }

  function renderReports() {
    let monthsSet = new Set();
    inspections.forEach(i=>{
        if (!i.date) return;
        let [day, month, year] = i.date.split("/");
        if (month && year) monthsSet.add(`${month}/${year}`);
    });
    let selectMonth = document.getElementById("report-month-select");
    let months = Array.from(monthsSet).sort().reverse();
    selectMonth.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join('') || `<option value="">---</option>`;
    let currentMonth = selectMonth.value || months[0] || "";
    let embarcadas=0, retrabalho=0;
    let t = 0;
    inspections.forEach(i=>{
        if (!i.date) return;
        let [d,m,y]=i.date.split("/");
        let mes = `${m}/${y}`;
        if(mes!==currentMonth) return;
        t++;
        (i.itens || []).forEach(it=>
            (it.status==='OK')? embarcadas++ :
              (it.encaminhamento==='retrabalho')? retrabalho++ : embarcadas++
        );
    });
    document.getElementById("total-inspecoes").textContent = inspections.length;
    document.getElementById("volume-mensal-num").textContent = t;
    try {
      graficoRosca.data.datasets[0].data = [embarcadas,retrabalho];
      graficoRosca.update();
    } catch(e) {}
    let tbody = document.getElementById("reports-history-body");
    let filtered = inspections.filter(i=>{
      if (!i.date) return false;
      let [day, month, year] = i.date.split("/");
      return `${month}/${year}` === currentMonth;
    });
    tbody.innerHTML = filtered.length ?
      filtered.map(i=>`
      <tr>
        <td>${i.date}</td>
        <td>${i.inspector}</td>
        <td>${i.piece}</td>
        <td>${i.descricao||'-'}</td>
      </tr>
      `).join('')
      : `<tr><td colspan="4" style="text-align:center;">Nenhum histórico encontrado.</td></tr>`;
  }

  // chart
  const ctx = document.getElementById('graficoRosca')?.getContext('2d');
  const graficoRosca = ctx ? new Chart(ctx, {
      type: 'doughnut',
      data: {
          labels: ['Embarcadas', 'Retrabalho'],
          datasets: [{
              data: [0, 0],
              backgroundColor: ['#228be6', '#e23636'],
              borderColor: '#fff',
              borderWidth: 2
          }]
      },
      options: {responsive:false,plugins:{legend:{display:false}},cutout:'60%'}
  }) : null;

  document.getElementById('report-month-select').onchange = renderReports;

  function exportCSV() {
    if (!inspections.length) return alert("Sem inspeções!");
    let csv = "Data,Inspetor,Peça,Descrição\n"
        + inspections.map(i=>`${i.date},"${i.inspector}","${i.piece}","${(i.descricao||'').replace(/"/g,'""')}"`).join("\n");
    let blob = new Blob([csv],{type:'text/csv'});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "relatorio.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ---------------- AUTH UI and protection ----------------
  window.openSignInModal = function() {
    showModal(`
      <button class="modal-close">&times;</button>
      <h3>Entrar</h3>
      <div style="margin-top:8px;">
        <label>Email</label><br/>
        <input id="login-email" type="email" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;" value=""><br/><br/>
        <label>Senha</label><br/>
        <input id="login-pass" type="password" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;" value=""><br/><br/>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button class="btn-secondary" id="login-cancel">Cancelar</button>
          <button class="btn-primary" id="login-submit">Entrar</button>
        </div>
      </div>
    `);
    setTimeout(() => {
      document.getElementById('login-cancel').onclick = () => closeModal();
      document.getElementById('login-submit').onclick = async () => {
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value;
        if (!email || !pass) { alert('Preencha email e senha'); return; }
        try {
          await signInWithEmailAndPassword(auth, email, pass);
          closeModal();
        } catch (err) {
          console.error('Erro ao autenticar:', err);
          alert('Erro ao autenticar: ' + (err.message || err.code));
        }
      };
    }, 0);
  };

  window.signOut = async function() {
    await fbSignOut(auth);
  };

  // onAuthStateChanged: update UI and check admin
  onAuthStateChanged(auth, async (user) => {
    const signedAs = document.getElementById('signed-as');
    const authEmail = document.getElementById('auth-email');
    const signinBtn = document.getElementById('signin-btn');
    const signoutBtn = document.getElementById('signout-btn');

    if (user) {
      signedAs.style.display = 'inline-block';
      authEmail.textContent = user.email || user.uid;
      signinBtn.style.display = 'none';
      signoutBtn.style.display = 'inline-block';

      // check custom claim
      try {
        const idTokenResult = await getIdTokenResult(user);
        if (idTokenResult && idTokenResult.claims && idTokenResult.claims.admin === true) {
          window.isAdminUser = true;
          console.log('User has admin custom claim.');
          return;
        }
      } catch (err) {
        console.warn('Erro ao ler id token claims:', err);
      }

      // check firestore doc config/admins
      try {
        const admRef = doc(db, 'config', 'admins');
        const admSnap = await getDoc(admRef);
        if (admSnap.exists()) {
          const list = admSnap.data().list || [];
          window.isAdminUser = list.map(e => (e || '').toLowerCase()).includes((user.email || '').toLowerCase());
          console.log('Admins (from Firestore):', list, 'isAdminUser=', window.isAdminUser);
        } else {
          // fallback to provided email for convenience
          window.isAdminUser = ((user.email || '').toLowerCase() === (FALLBACK_ADMIN_EMAIL || '').toLowerCase());
          console.log('Admins doc not found. Using fallback email check => isAdminUser=', window.isAdminUser);
        }
      } catch (err) {
        console.error('Erro ao checar admins no Firestore:', err);
        window.isAdminUser = ((user.email || '').toLowerCase() === (FALLBACK_ADMIN_EMAIL || '').toLowerCase());
      }
    } else {
      signedAs.style.display = 'none';
      authEmail.textContent = '';
      signinBtn.style.display = 'inline-block';
      signoutBtn.style.display = 'none';
      window.isAdminUser = false;
    }
  });

  // requestAdminAccess called by Admin button
  window.requestAdminAccess = function() {
    if (!auth.currentUser) {
      openSignInModal();
      return;
    }
    if (window.isAdminUser) {
      showScreen('admin');
    } else {
      alert('Usuário autenticado, mas sem permissão de Admin. Peça para um administrador adicionar seu e-mail em firestore: config/admins (coleção config, documento admins -> campo list: ["email@..."]) ou aplique claim admin via Admin SDK.');
    }
  };

  // ---------------- Initialization: load data from Firebase on start ----------------
  document.addEventListener("DOMContentLoaded", async ()=>{
    // try load real data from Firestore
    if (window.fbApi && window.fbApi.loadAll) {
      try {
        const data = await window.fbApi.loadAll();
        if (data.pieces && data.pieces.length) pieces = data.pieces;
        if (data.inspectors && data.inspectors.length) inspectors = data.inspectors;
        if (data.inspections && data.inspections.length) inspections = data.inspections;
      } catch (e) {
        console.error("Erro ao carregar dados do Firebase:", e);
      }
    }
    // initial render
    showScreen('home');
    renderHome();
    renderReports();
  });

  // Expose some internals for debugging
  window._appDebug = { app, db, storage, auth };

</script>
</body>
</html>
