<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Magius - Sistema de Checklist de Inspe√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- ESTILOS (CSS) -->
  <style>
  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:#f4f6fb;
    color:#333;
  }

  /* LOGIN SCREEN */
  .login-screen{
    position:fixed;
    inset:0;
    background:#001a3d;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:99999;
  }
  .login-card{
    width:100%;
    max-width:360px;
    background:#fff;
    border-radius:12px;
    padding:20px 22px 22px;
    box-shadow:0 10px 30px rgba(0,0,0,0.35);
  }
  .login-logo{
    font-size:22px;
    font-weight:800;
    color:#003366;
  }
  .login-sub{
    font-size:12px;
    color:#666;
    margin-bottom:10px;
  }
  .login-tabs{
    display:flex;
    gap:6px;
    margin:8px 0 12px;
  }
  .login-tab{
    flex:1;
    border-radius:999px;
    padding:6px 8px;
    background:#e1e6f5;
    border:none;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    color:#003366;
  }
  .login-tab.active{
    background:#003366;
    color:#fff;
  }
  .login-form-group{
    margin-bottom:10px;
  }
  .login-form-group label{
    font-size:12px;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }
  .login-form-group input,
  .login-form-group select{
    width:100%;
    padding:7px 9px;
    border-radius:6px;
    border:1px solid #cbd3e3;
    font-size:13px;
  }
  .login-btn-primary{
    width:100%;
    border:none;
    border-radius:7px;
    padding:8px 12px;
    background:#0b4b7a;
    color:#fff;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    margin-top:4px;
  }
  .login-btn-primary:hover{background:#0f5f9c;}
  .login-hint{
    font-size:11px;
    color:#666;
    margin-top:6px;
  }
  .login-error{
    font-size:11px;
    color:#c0392b;
    margin-bottom:4px;
  }
  .login-title-small{
    font-size:14px;
    font-weight:700;
    margin-bottom:6px;
    color:#003366;
  }
  .login-back-link{
    font-size:11px;
    color:#003366;
    text-decoration:underline;
    cursor:pointer;
    margin-top:6px;
    display:inline-block;
  }

  /* LAYOUT PRINCIPAL */
  .layout{
    display:flex;
    min-height:100vh;
  }

  /* SIDEBAR LATERAL */
  .sidebar{
    width:230px;
    background:#0b2a63;
    color:#fff;
    display:flex;
    flex-direction:column;
    padding:16px 12px;
  }
  .sidebar-logo{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:18px;
  }
  .logo-icon{
    width:36px;height:36px;border-radius:10px;
    background:#19a38c;
    display:flex;align-items:center;justify-content:center;
    font-weight:800;font-size:20px;
  }
  .logo-text{line-height:1.1;}
  .logo-main{font-weight:800;font-size:16px;}
  .logo-sub{font-size:11px;opacity:0.7;}

  .sidebar-menu{
    display:flex;
    flex-direction:column;
    gap:4px;
    margin-top:8px;
  }
  .sidebar-item{
    border:none;
    background:transparent;
    color:#f0f4ff;
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
  }
  .sidebar-item:hover{background:#123a7a;}
  .sidebar-item.active{
    background:#fff;
    color:#0b2a63;
  }
  .sidebar-icon{
    width:22px;
    display:inline-flex;
    justify-content:center;
  }
  .sidebar-footer{
    margin-top:auto;
    font-size:11px;
    opacity:0.8;
    padding:8px 4px;
  }

  /* MAIN / HEADER */

  .main{
    flex:1;
    display:flex;
    flex-direction:column;
  }
  .top-header{
    background:#003366;
    color:#fff;
    padding:12px 24px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .header-left{display:flex;align-items:center;gap:10px;}
  .header-circles{display:flex;gap:6px;}
  .header-circles span{
    width:14px;height:14px;border-radius:50%;border:2px solid #fff;
  }
  .header-tagline{font-size:12px;font-weight:600;}
  .header-brand{text-align:right;}
  .header-logo{font-size:20px;font-weight:800;}
  .header-sub{font-size:11px;color:#cfe6ff;}
  .header-user-meta{
    margin-top:4px;
    font-size:11px;
    display:flex;
    align-items:center;
    gap:6px;
    justify-content:flex-end;
  }
  .btn-header-small{
    border-radius:999px;
    border:1px solid #cfe6ff;
    background:transparent;
    padding:2px 8px;
    font-size:10px;
    color:#cfe6ff;
    cursor:pointer;
  }
  .btn-header-small:hover{
    background:#cfe6ff;
    color:#003366;
  }

  .main-content{
    padding:16px 24px 32px;
  }

  /* CARDS, FORM, BOT√ïES */

  .card{
    background:#fff;
    border-radius:10px;
    padding:16px 18px 18px;
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
    margin-bottom:8px;
  }
  .screen-title{
    margin:0 0 12px;
    font-size:20px;
    font-weight:700;
  }
  .card-title{
    margin:0 0 10px;
    font-size:16px;
    font-weight:700;
  }

  .form-group{margin-bottom:10px;}
  .form-group label{
    font-weight:600;
    font-size:13px;
    display:block;
    margin-bottom:4px;
  }
  .form-group input[type="text"],
  .form-group input[type="file"],
  .form-group select,
  .form-group textarea{
    width:100%;
    padding:7px 9px;
    border-radius:5px;
    border:1px solid #cbd3e3;
    font-size:13px;
  }
  .form-group input[disabled]{
    background:#eef2fb;
    color:#555;
  }
  .form-group textarea{resize:vertical;}
  .form-group.small{max-width:200px;}

  .btn-primary,.btn-secondary{
    border:none;
    border-radius:7px;
    padding:8px 18px;
    font-size:14px;
    cursor:pointer;
    font-weight:600;
  }
  .btn-primary{
    background:#0b4b7a;
    color:#fff;
  }
  .btn-primary:hover{background:#0f5f9c;}
  .btn-secondary{
    background:#fff;
    color:#0b4b7a;
    border:1px solid #0b4b7a;
  }
  .btn-secondary:hover{background:#eef3ff;}

  .grid-2{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px 16px;
  }
  .grid-3{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px 16px;
  }

  @media (max-width:900px){
    .grid-2,.grid-3{grid-template-columns:1fr;}
    .layout{flex-direction:column;}
    .sidebar{
      flex-direction:row;
      align-items:center;
      width:100%;
      overflow-x:auto;
    }
    .sidebar-menu{
      flex-direction:row;
      margin-left:16px;
    }
    .sidebar-footer{display:none;}
    .top-header{
      flex-direction:column;
      align-items:flex-start;
    }
    .header-brand{text-align:left;}
    .header-user-meta{
      justify-content:flex-start;
    }
  }

  .screen{display:none;}
  .screen.active{display:block;}

  .mt-8{margin-top:8px;}
  .mt-16{margin-top:16px;}
  .mb-8{margin-bottom:8px;}

  /* CHECKLIST */

  .piece-image-box{
    height:220px;
    border-radius:10px;
    background:#f0f5fa;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top:8px;
    overflow:hidden;
  }
  .piece-image-box img{
    max-width:100%;
    max-height:220px;
    cursor:pointer;
  }
  .checklist-piece-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .checklist-piece-code{
    font-size:22px;
    font-weight:700;
    color:#003366;
  }
  .checklist-piece-desc{
    font-size:13px;
    color:#667;
    margin-top:2px;
  }

  .checklist-item{
    border-radius:8px;
    border:1px solid #d7ddeb;
    background:#fafbff;
    padding:10px;
    display:flex;
    gap:12px;
    margin-top:10px;
  }
  .checklist-item.ok{
    background:#e3fcec;
    border-color:#2ecc71;
  }
  .checklist-item.nok{
    background:#ffe6e8;
    border-color:#e74c3c;
  }

  .checklist-item-thumb{
    width:90px;height:90px;border-radius:8px;
    background:#e0e5f0;
    overflow:hidden;
    flex-shrink:0;
  }
  .checklist-item-thumb img{
    width:100%;height:100%;object-fit:cover;cursor:pointer;
  }

  .checklist-item-body{flex:1;}
  .checklist-item-title{
    font-weight:700;
    font-size:14px;
  }
  .checklist-item-desc{
    font-size:12px;
    color:#555;
    margin-top:2px;
  }
  .checklist-item-actions{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .checklist-status-btn{
    border-radius:5px;
    border:none;
    padding:6px 10px;
    font-size:13px;
    cursor:pointer;
    color:#fff;
  }
  .btn-ok{background:#28b649;}
  .btn-nok{background:#e23636;}

  .checklist-extra{
    margin-top:8px;
    border-radius:6px;
    border:2px solid #e23636;
    background:#fff6f7;
    padding:8px 10px;
    font-size:12px;
  }
  .checklist-extra label{
    font-weight:600;
    font-size:12px;
  }
  .checklist-extra textarea{
    width:100%;
    min-height:60px;
    margin-top:4px;
    margin-bottom:6px;
  }

  .checklist-nok-library{
    background:#f7edf0;
    border-radius:10px;
    padding:10px 12px;
  }
  .checklist-nok-title{
    font-weight:700;
    color:#b02a3a;
    margin-bottom:8px;
  }
  .checklist-nok-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .checklist-nok-card{
    width:230px;
    border-radius:8px;
    background:#fff;
    border:2px solid #e23636;
    padding:8px;
    font-size:11px;
  }
  .checklist-nok-card img{
    width:100%;
    height:120px;
    object-fit:cover;
    border-radius:6px;
    margin-top:4px;
    cursor:pointer;
  }

  /* INSPETORES */

  .inspectors-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .inspector-card{
    width:210px;
    border-radius:10px;
    border:1px solid #d6ddeb;
    padding:10px;
    background:#f9fbff;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
  }
  .inspector-avatar{
    width:72px;height:72px;border-radius:50%;
    background:#dce3f4;
    overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    font-weight:700;color:#4b5a80;font-size:26px;
  }
  .inspector-avatar img{
    width:100%;height:100%;object-fit:cover;
  }
  .inspector-name{
    font-size:14px;
    font-weight:700;
    text-align:center;
  }
  .inspector-pin-status{
    font-size:11px;
    color:#555;
  }
  .inspector-actions{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
    justify-content:center;
  }
  .btn-icon{
    border-radius:6px;
    border:none;
    padding:4px 8px;
    font-size:12px;
    cursor:pointer;
  }
  .btn-edit{background:#0b4b7a;color:#fff;}
  .btn-delete{background:#e23636;color:#fff;}
  .btn-reset-pin{background:#f1c40f;color:#333;}

  /* PE√áAS & ITENS */

  .pieces-list{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .piece-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-radius:8px;
    padding:6px 8px;
    background:#f8faff;
    border:1px solid #dde3f3;
  }
  .piece-row-left{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .piece-thumb{
    width:40px;height:32px;border-radius:6px;
    background:#e0e5f0;
    overflow:hidden;
  }
  .piece-thumb img{
    width:100%;height:100%;object-fit:cover;
  }
  .piece-label{
    font-size:13px;
    font-weight:600;
  }

  .piece-item-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 6px;
    border-radius:6px;
    border:1px solid #e0e3f0;
    background:#f9fbff;
    margin-bottom:4px;
  }
  .piece-item-main{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .piece-item-thumb{
    width:26px;height:26px;border-radius:4px;
    background:#e0e5f0;
    overflow:hidden;
  }
  .piece-item-thumb img{
    width:100%;height:100%;object-fit:cover;
  }

  /* DASHBOARD & RELAT√ìRIOS */

  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px;
  }
  .kpi-card{
    border-radius:10px;
    padding:10px 12px;
    background:#f8faff;
    border:1px solid #dde3f3;
  }
  .kpi-card.kpi-large{grid-column:span 1;}
  .kpi-label{
    font-size:12px;
    color:#555;
    margin-bottom:4px;
  }
  .kpi-value{
    font-size:22px;
    font-weight:800;
    color:#003366;
  }
  .kpi-list{
    font-size:12px;
    margin-top:4px;
  }
  .kpi-list div{margin-bottom:2px;}

  .chart-wrapper{
    display:flex;
    justify-content:center;
    padding:6px 0 10px;
  }

  .report-controls{
    display:flex;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
  }
  .report-total{
    font-weight:600;
    font-size:14px;
  }
  .history-table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .history-table thead{background:#dde7f3;}
  .history-table th,
  .history-table td{
    border:1px solid #c8d3e6;
    padding:6px 8px;
    text-align:left;
  }

  /* MODAL */

  .modal-overlay{
    position:fixed;inset:0;
    background:rgba(0,0,0,0.4);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:88888;
  }
  .modal-box{
    background:#fff;
    border-radius:12px;
    padding:16px 18px 18px;
    max-width:420px;
    width:100%;
    box-shadow:0 6px 20px rgba(0,0,0,0.25);
  }
  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .modal-title{
    font-size:16px;
    font-weight:700;
  }
  .modal-close-btn{
    border:none;
    background:transparent;
    font-size:22px;
    cursor:pointer;
  }

  .divider{border-bottom:1px solid #e0e4f0;}
  .hide{display:none!important;}
  </style>
</head>
<body>

  <!-- TELA DE LOGIN -->
  <div id="login-screen" class="login-screen">
    <div class="login-card" id="login-main-panel">
      <div class="login-logo">MAGIUS</div>
      <div class="login-sub">Sistema de Checklist de Inspe√ß√£o</div>

      <div class="login-tabs">
        <button id="login-tab-inspector" class="login-tab active">Inspetor</button>
        <button id="login-tab-admin" class="login-tab">Administrador</button>
      </div>

      <div id="login-error" class="login-error" style="display:none;"></div>

      <!-- PAINEL INSPETOR -->
      <div id="login-inspector-panel">
        <div class="login-form-group">
          <label for="login-insp-select">Inspetor</label>
          <select id="login-insp-select">
            <option value="" disabled selected>Selecione o inspetor</option>
          </select>
        </div>
        <div class="login-form-group">
          <label for="login-insp-pin">PIN (4 d√≠gitos)</label>
          <input type="password" id="login-insp-pin" maxlength="4" inputmode="numeric" placeholder="****">
        </div>
        <button id="btn-login-insp" class="login-btn-primary">Entrar</button>
        <div class="login-hint">
          Primeiro acesso: basta informar o nome, digitar o PIN desejado e o sistema vai pedir confirma√ß√£o.
        </div>
      </div>

      <!-- PAINEL ADMIN -->
      <div id="login-admin-panel" class="hide">
        <div class="login-form-group">
          <label for="login-admin-password">Senha do administrador</label>
          <input type="password" id="login-admin-password" placeholder="Digite a senha">
        </div>
        <button id="btn-login-admin" class="login-btn-primary">Entrar como Administrador</button>
        <div class="login-hint">
          Acesso restrito para configura√ß√£o de inspetores, pe√ßas e itens.
        </div>
      </div>
    </div>

    <!-- PAINEL CRIAR PIN -->
    <div class="login-card hide" id="create-pin-panel">
      <div class="login-title-small">Criar PIN de acesso</div>
      <div class="login-hint">
        Inspetor: <strong id="create-pin-name"></strong>
      </div>
      <div id="create-pin-error" class="login-error" style="display:none;"></div>
      <div class="login-form-group">
        <label for="create-pin-input">Novo PIN (4 d√≠gitos)</label>
        <input type="password" id="create-pin-input" maxlength="4" inputmode="numeric" placeholder="****">
      </div>
      <div class="login-form-group">
        <label for="create-pin-confirm">Confirmar PIN</label>
        <input type="password" id="create-pin-confirm" maxlength="4" inputmode="numeric" placeholder="****">
      </div>
      <button id="btn-create-pin-confirm" class="login-btn-primary">Salvar PIN e entrar</button>
      <span id="btn-create-pin-cancel" class="login-back-link">Voltar para login</span>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div class="layout" id="app-layout" style="display:none;">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="logo-icon">M</div>
        <div class="logo-text">
          <div class="logo-main">MAGIUS</div>
          <div class="logo-sub">Checklist</div>
        </div>
      </div>

      <nav class="sidebar-menu">
        <button class="sidebar-item active" data-screen="checklist" onclick="selectSidebar('checklist')">
          <span class="sidebar-icon">‚úÖ</span><span class="sidebar-label">Checklist</span>
        </button>
        <button class="sidebar-item" data-screen="inspectors" onclick="selectSidebar('inspectors')">
          <span class="sidebar-icon">üë§</span><span class="sidebar-label">Inspetores</span>
        </button>
        <button class="sidebar-item" data-screen="pieces" onclick="selectSidebar('pieces')">
          <span class="sidebar-icon">üß©</span><span class="sidebar-label">Pe√ßas & Itens</span>
        </button>
        <button class="sidebar-item" data-screen="dashboard" onclick="selectSidebar('dashboard')">
          <span class="sidebar-icon">üìä</span><span class="sidebar-label">Dashboard</span>
        </button>
        <button class="sidebar-item" data-screen="reports" onclick="selectSidebar('reports')">
          <span class="sidebar-icon">üìë</span><span class="sidebar-label">Relat√≥rios</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        Ajudando a construir,<br>
        cultivar, transportar e<br>
        seguir em frente.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="top-header">
        <div class="header-left">
          <div class="header-circles"><span></span><span></span><span></span><span></span></div>
          <div class="header-tagline">
            AJUDANDO A CONSTRUIR, CULTIVAR,<br>TRANSPORTAR E SEGUIR EM FRENTE
          </div>
        </div>
        <div class="header-brand">
          <div class="header-logo">MAGIUS</div>
          <div class="header-sub">METAL√öRGICA INDUSTRIAL</div>
          <div class="header-user-meta">
            <span id="header-user-label"></span>
            <button id="btn-change-pin" class="btn-header-small" style="display:none;">Alterar PIN</button>
            <button id="btn-logout" class="btn-header-small">Sair</button>
          </div>
        </div>
      </header>

      <div class="main-content">

        <!-- TELA: CHECKLIST -->
        <section id="checklist" class="screen active">
          <div class="card">
            <h2 class="screen-title">Checklist de Inspe√ß√£o</h2>
            <div class="grid-2">
              <div class="form-group">
                <label>Inspetor logado</label>
                <input type="text" id="insp-display" disabled placeholder="Nenhum usu√°rio logado">
              </div>
              <div class="form-group">
                <label for="piece-selector">Pe√ßa</label>
                <select id="piece-selector">
                  <option value="" disabled selected>Selecionar pe√ßa</option>
                </select>
              </div>
            </div>
            <button class="btn-primary mt-8" id="btn-start-checklist">Iniciar Checklist</button>
          </div>

          <div id="checklist-execution" class="card mt-16 hide">
            <div class="checklist-piece-header">
              <div>
                <div class="checklist-piece-code" id="cl-piece-code"></div>
                <div class="checklist-piece-desc" id="cl-piece-desc"></div>
              </div>
            </div>
            <div id="cl-piece-image-box" class="piece-image-box">[Imagem da pe√ßa]</div>
            <div id="checklist-item-list"></div>
            <button class="btn-primary mt-16" id="btn-finish-checklist">Finalizar inspe√ß√£o</button>
            <div id="checklist-nok-library" class="checklist-nok-library mt-16"></div>
          </div>
        </section>

        <!-- TELA: INSPETORES -->
        <section id="inspectors" class="screen">
          <div class="card">
            <h2 class="screen-title">Cadastro de Inspetores</h2>
            <div class="grid-2">
              <div class="form-group">
                <label for="insp-name-input">Nome do inspetor</label>
                <input type="text" id="insp-name-input" placeholder="Ex: Jo√£o Silva">
              </div>
              <div class="form-group">
                <label for="insp-photo-input">Foto do inspetor</label>
                <input type="file" id="insp-photo-input" accept="image/*">
              </div>
            </div>
            <button class="btn-primary" id="btn-add-inspector">Adicionar inspetor</button>
            <div class="login-hint" style="margin-top:6px;">
              O PIN ser√° criado pelo pr√≥prio inspetor no primeiro login.
            </div>
          </div>

          <div class="card mt-16">
            <h3 class="card-title">Inspetores cadastrados</h3>
            <div id="inspectors-list" class="inspectors-grid"></div>
          </div>
        </section>

        <!-- TELA: PE√áAS & ITENS -->
        <section id="pieces" class="screen">
          <div class="card">
            <h2 class="screen-title">Cadastro de Pe√ßas</h2>
            <div class="grid-3">
              <div class="form-group">
                <label for="piece-code-input">C√≥digo da pe√ßa</label>
                <input type="text" id="piece-code-input" placeholder="597-2445#01">
              </div>
              <div class="form-group">
                <label for="piece-desc-input">Descri√ß√£o</label>
                <input type="text" id="piece-desc-input" placeholder="Longarina">
              </div>
              <div class="form-group">
                <label for="piece-image-input">Imagem da pe√ßa</label>
                <input type="file" id="piece-image-input" accept="image/*">
              </div>
            </div>
            <button class="btn-primary" id="btn-add-piece">Adicionar pe√ßa</button>
          </div>

          <div class="grid-2 mt-16">
            <div class="card">
              <h3 class="card-title">Pe√ßas cadastradas</h3>
              <div id="pieces-list" class="pieces-list"></div>
            </div>
            <div class="card">
              <h3 class="card-title">Itens de checklist da pe√ßa</h3>
              <div class="form-group">
                <label for="piece-items-selector">Selecionar pe√ßa</label>
                <select id="piece-items-selector"></select>
              </div>
              <div id="piece-items-list"></div>
              <div class="divider mt-8 mb-8"></div>
              <div class="form-group">
                <label for="item-name-input">Novo item</label>
                <input type="text" id="item-name-input" placeholder="Ex: Dimens√£o A (√ò)">
              </div>
              <div class="form-group">
                <label for="item-desc-input">Descri√ß√£o do item</label>
                <textarea id="item-desc-input" rows="2" placeholder="Descreva o que deve ser verificado"></textarea>
              </div>
              <div class="form-group">
                <label for="item-image-input">Imagem do item</label>
                <input type="file" id="item-image-input" accept="image/*">
              </div>
              <button class="btn-primary" id="btn-add-item">Adicionar item</button>
            </div>
          </div>
        </section>

        <!-- TELA: DASHBOARD -->
        <section id="dashboard" class="screen">
          <div class="card">
            <h2 class="screen-title">Dashboard ‚Äì KPIs de Inspe√ß√£o</h2>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label">Inspe√ß√µes no m√™s</div>
                <div class="kpi-value" id="kpi-inspecoes-mes">0</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">% Itens N√ÉO OK</div>
                <div class="kpi-value" id="kpi-percent-nok">0%</div>
              </div>
              <div class="kpi-card kpi-large">
                <div class="kpi-label">Pe√ßas com mais reprova√ß√µes</div>
                <div class="kpi-list" id="kpi-top-pecas"></div>
              </div>
            </div>
          </div>

          <div class="card mt-16">
            <h3 class="card-title">Distribui√ß√£o de status (OK x Retrabalho)</h3>
            <div class="chart-wrapper">
              <canvas id="dashboard-chart" width="200" height="200"></canvas>
            </div>
          </div>
        </section>

        <!-- TELA: RELAT√ìRIOS -->
        <section id="reports" class="screen">
          <div class="card">
            <h2 class="screen-title">Relat√≥rios</h2>
            <div class="report-controls">
              <button class="btn-secondary" id="btn-export-csv">Exportar CSV</button>
              <div class="form-group small">
                <label for="report-month-select">M√™s:</label>
                <select id="report-month-select"></select>
              </div>
              <div class="report-total">
                Total inspe√ß√µes: <span id="total-inspecoes">0</span>
              </div>
            </div>
            <div class="chart-wrapper">
              <canvas id="reports-chart" width="200" height="200"></canvas>
            </div>
          </div>

          <div class="card mt-16">
            <h3 class="card-title">Hist√≥rico de inspe√ß√µes</h3>
            <table class="history-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Inspetor</th>
                  <th>Pe√ßa</th>
                  <th>Descri√ß√£o</th>
                </tr>
              </thead>
              <tbody id="reports-history-body"></tbody>
            </table>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- MODAL -->
  <div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div id="modal-box" class="modal-box"></div>
  </div>

  <!-- SCRIPT FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAAowsqkoUjIAPhSvq6dUlKMZGdXOO1b0",
      authDomain: "magiuschecklist-9ad0f.firebaseapp.com",
      projectId: "magiuschecklist-9ad0f",
      storageBucket: "magiuschecklist-9ad0f.firebasestorage.app",
      messagingSenderId: "14669686712",
      appId: "1:14669686712:web:1c205b1111cde18379114d",
      measurementId: "G-GQS591WCBD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const auth = getAuth(app);
    signInAnonymously(auth).catch(err => console.warn("Falha auth an√¥nima:", err));
    onAuthStateChanged(auth, user => {
      if (user) console.log("Auth ok:", user.uid);
      else console.log("Auth none");
    });

    async function uploadFileAndGetUrl(path, file) {
      if (!file) return null;
      const ref = sRef(storage, path);
      const metadata = { contentType: file.type || "image/jpeg" };
      await uploadBytes(ref, file, metadata);
      const url = await getDownloadURL(ref);
      return url;
    }

    async function loadAll() {
      const pieces = [];
      let inspectorsArr = [];
      let inspections = [];

      try {
        const piecesSnap = await getDocs(collection(db, "pieces"));
        piecesSnap.docs.forEach(d => {
          const data = d.data();
          pieces.push({
            code: data.code,
            description: data.description,
            image: null,
            imageUrl: data.imageUrl || null,
            items: (data.items || []).map(it => ({
              name: it.name,
              description: it.description,
              image: null,
              imageUrl: it.imageUrl || null
            }))
          });
        });
      } catch (err) {
        console.warn("Erro load pieces:", err);
      }

      try {
        const inspRef = doc(db, "config", "inspectors");
        const inspSnap = await getDoc(inspRef);
        if (inspSnap && inspSnap.exists()) {
          const rawList = inspSnap.data().list || [];
          inspectorsArr = rawList.map(it => {
            if (typeof it === "string") {
              return { name: it, pin: null };
            } else {
              return {
                name: it.name || "",
                pin: it.pin || null
              };
            }
          });
        }
      } catch (err) {
        console.warn("Erro load inspectors:", err);
      }

      try {
        const inspecSnap = await getDocs(collection(db, "inspections"));
        inspecSnap.docs.forEach(d => {
          const data = d.data();
          inspections.push({
            id: d.id,
            date: data.date,
            inspector: data.inspector,
            piece: data.piece,
            descricao: data.descricao || "",
            itens: (data.itens || []).map(it => ({
              status: it.status,
              motivo: it.motivo,
              encaminhamento: it.encaminhamento,
              nome_terceiro: it.nome_terceiro || "",
              foto: null,
              fotoUrl: it.fotoUrl || null
            }))
          });
        });
      } catch (err) {
        console.warn("Erro load inspections:", err);
      }

      return { pieces, inspectors: inspectorsArr, inspections };
    }

    async function savePiece(piece) {
      if (!piece || !piece.code) return;
      let imageUrl = piece.imageUrl || null;
      if (piece.image instanceof File) {
        const ext = (piece.image.name && piece.image.name.split(".").pop()) || "jpg";
        imageUrl = await uploadFileAndGetUrl(`pieces/${piece.code}/main_${Date.now()}.${ext}`, piece.image);
      }
      const itemsToSave = [];
      for (let idx = 0; idx < (piece.items || []).length; idx++) {
        const it = piece.items[idx];
        let itemImageUrl = it.imageUrl || null;
        if (it.image instanceof File) {
          const ext = (it.image.name && it.image.name.split(".").pop()) || "jpg";
          itemImageUrl = await uploadFileAndGetUrl(`pieces/${piece.code}/items/${idx}_${Date.now()}.${ext}`, it.image);
        }
        itemsToSave.push({
          name: it.name,
          description: it.description,
          imageUrl: itemImageUrl
        });
      }
      const ref = doc(db, "pieces", piece.code);
      await setDoc(ref, {
        code: piece.code,
        description: piece.description,
        imageUrl,
        items: itemsToSave
      });
    }

    async function deletePiece(code) {
      if (!code) return;
      await deleteDoc(doc(db, "pieces", code));
    }

    async function setInspectors(list) {
      const ref = doc(db, "config", "inspectors");
      await setDoc(ref, { list: list || [] });
    }

    async function saveInspection(inspec) {
      const timeStamp = Date.now();
      const itensToSave = [];
      for (let idx = 0; idx < (inspec.itens || []).length; idx++) {
        const it = inspec.itens[idx];
        let fotoUrl = it.fotoUrl || null;
        if (it.foto instanceof File) {
          const ext = (it.foto.name && it.foto.name.split(".").pop()) || "jpg";
          fotoUrl = await uploadFileAndGetUrl(
            `inspections/${inspec.piece}/${timeStamp}_${idx}.${ext}`,
            it.foto
          );
        }
        itensToSave.push({
          status: it.status,
          motivo: it.motivo,
          encaminhamento: it.encaminhamento,
          nome_terceiro: it.nome_terceiro || "",
          fotoUrl
        });
      }
      const docData = {
        date: inspec.date,
        inspector: inspec.inspector,
        piece: inspec.piece,
        descricao: inspec.descricao || "",
        itens: itensToSave
      };
      const ref = await addDoc(collection(db, "inspections"), docData);
      return { id: ref.id, ...docData };
    }

    window.fbApi = { loadAll, savePiece, deletePiece, setInspectors, saveInspection };
  </script>

  <!-- SCRIPT PRINCIPAL (UI) -->
  <script>
  // ESTADO PRINCIPAL
  let pieces = [
    {
      code: "597-2445#01",
      description: "Longarina",
      image: null,
      imageUrl: null,
      items: [
        { name: "Dimens√£o A (√ò)", description: "Verificar di√¢metro da fura√ß√£o.", image: null, imageUrl: null },
        { name: "Furo B posi√ß√£o", description: "Conferir posi√ß√£o do furo de encaixe.", image: null, imageUrl: null }
      ]
    }
  ];

  // Agora inspetores s√£o objetos {name, pin}
  let inspectors = [
    { name: "Jo√£o Silva", pin: null },
    { name: "Maria Santos", pin: null }
  ];

  let inspectorPhotos = {};
  let inspections = [];

  let currentChecklistPiece = null;
  let checklistItemStates = [];

  let reportsChart = null;
  let dashboardChart = null;

  let currentUser = null;   // { name, role: 'inspector' | 'admin' }
  let isAdmin = false;
  let pendingPinInspector = null;

  // =========================
  // FUN√á√ïES GERAIS / MODAL
  // =========================

  function selectSidebar(screenId){
    // Bloqueia acesso a telas de admin para n√£o admin
    const adminScreens = ["inspectors","pieces"];
    if (adminScreens.includes(screenId) && !isAdmin) {
      alert("Apenas o Administrador pode acessar esta √°rea.");
      return;
    }

    document.querySelectorAll(".sidebar-item").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.screen===screenId);
    });
    document.querySelectorAll(".screen").forEach(s=>{
      s.classList.toggle("active", s.id===screenId);
    });

    if(screenId==="checklist") renderChecklistSelectors();
    if(screenId==="inspectors") renderInspectors();
    if(screenId==="pieces") renderPieces();
    if(screenId==="reports") renderReports();
    if(screenId==="dashboard") renderDashboard();
  }
  window.selectSidebar = selectSidebar;

  function showModal(html){
    const overlay = document.getElementById("modal-overlay");
    const box = document.getElementById("modal-box");
    box.innerHTML = html;
    overlay.style.display = "flex";
    const closeBtn = box.querySelector(".modal-close-btn");
    if(closeBtn) closeBtn.onclick = closeModal;
    overlay.onclick = e=>{ if(e.target===overlay) closeModal(); };
  }
  function closeModal(){
    const overlay = document.getElementById("modal-overlay");
    const box = document.getElementById("modal-box");
    overlay.style.display="none";
    box.innerHTML="";
  }
  function showImageModal(src){
    if(!src) return;
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Visualizar imagem</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div style="margin-top:8px;text-align:center;">
        <img src="${src}" style="max-width:100%;max-height:70vh;border-radius:10px;">
      </div>
    `);
  }

  function findInspectorByName(name){
    return inspectors.find(i => i.name === name) || null;
  }

  function updateHeaderUserInfo(){
    const label = document.getElementById("header-user-label");
    const btnChangePin = document.getElementById("btn-change-pin");
    if(!label) return;
    if(!currentUser){
      label.textContent = "";
      if(btnChangePin) btnChangePin.style.display="none";
    } else {
      if(currentUser.role === "admin"){
        label.textContent = `Admin: ${currentUser.name}`;
        if(btnChangePin) btnChangePin.style.display="none";
      } else {
        label.textContent = `Inspetor: ${currentUser.name}`;
        if(btnChangePin) btnChangePin.style.display="inline-block";
      }
    }
    const inspDisplay = document.getElementById("insp-display");
    if(inspDisplay){
      inspDisplay.value = currentUser && currentUser.role==="inspector" ? currentUser.name :
                          currentUser && currentUser.role==="admin" ? "Administrador" : "";
    }
  }

  function completeLogin(user){
    currentUser = user;
    isAdmin = user && user.role === "admin";
    updateHeaderUserInfo();
    // Fecha login, abre app
    const loginScreen = document.getElementById("login-screen");
    const appLayout = document.getElementById("app-layout");
    if(loginScreen) loginScreen.style.display="none";
    if(appLayout) appLayout.style.display="flex";
    selectSidebar("checklist");
  }

  function logout(){
    currentUser = null;
    isAdmin = false;
    updateHeaderUserInfo();
    // Esconde app, mostra login
    document.getElementById("app-layout").style.display="none";
    document.getElementById("login-screen").style.display="flex";
    // Limpa campos de login
    const pinInput = document.getElementById("login-insp-pin");
    const adminInput = document.getElementById("login-admin-password");
    if(pinInput) pinInput.value="";
    if(adminInput) adminInput.value="";
  }

  // =========================
  // LOGIN / PIN
  // =========================

  function setLoginError(msg){
    const el = document.getElementById("login-error");
    if(!el) return;
    if(msg){
      el.textContent = msg;
      el.style.display="block";
    } else {
      el.textContent = "";
      el.style.display="none";
    }
  }

  function setCreatePinError(msg){
    const el = document.getElementById("create-pin-error");
    if(!el) return;
    if(msg){
      el.textContent = msg;
      el.style.display="block";
    } else {
      el.textContent = "";
      el.style.display="none";
    }
  }

  function renderLoginInspectorSelect(){
    const sel = document.getElementById("login-insp-select");
    if(!sel) return;
    sel.innerHTML = '<option value="" disabled selected>Selecione o inspetor</option>' +
      inspectors.map(i=>`<option value="${i.name}">${i.name}</option>`).join("");
  }

  function showLoginPanelMain(){
    document.getElementById("login-main-panel").classList.remove("hide");
    document.getElementById("create-pin-panel").classList.add("hide");
    setLoginError("");
    setCreatePinError("");
    pendingPinInspector = null;
  }

  function startCreatePinFlow(name){
    pendingPinInspector = name;
    document.getElementById("login-main-panel").classList.add("hide");
    const panel = document.getElementById("create-pin-panel");
    panel.classList.remove("hide");
    document.getElementById("create-pin-name").textContent = name;
    document.getElementById("create-pin-input").value="";
    document.getElementById("create-pin-confirm").value="";
    setCreatePinError("");
  }

  async function handleInspectorLogin(){
    setLoginError("");
    const sel = document.getElementById("login-insp-select");
    const pinInput = document.getElementById("login-insp-pin");
    const name = sel ? sel.value : "";
    const pin = (pinInput ? pinInput.value : "").trim();
    if(!name){
      setLoginError("Selecione o inspetor.");
      return;
    }
    if(!pin){
      setLoginError("Digite o PIN.");
      return;
    }
    if(!/^\d{4}$/.test(pin)){
      setLoginError("PIN deve conter 4 d√≠gitos num√©ricos.");
      return;
    }
    const insp = findInspectorByName(name);
    if(!insp){
      setLoginError("Inspetor n√£o encontrado.");
      return;
    }
    if(!insp.pin){
      // Primeiro acesso -> criar PIN
      startCreatePinFlow(name);
      // pr√© preenche o campo de cria√ß√£o com o que ele digitou, se quiser
      document.getElementById("create-pin-input").value = pin;
      return;
    }
    if(insp.pin !== pin){
      setLoginError("PIN incorreto.");
      return;
    }
    // login ok
    pinInput.value="";
    completeLogin({ name: insp.name, role:"inspector" });
  }

  async function handleCreatePinConfirm(){
    setCreatePinError("");
    if(!pendingPinInspector){
      setCreatePinError("Erro interno, volte ao login.");
      return;
    }
    const pin1 = document.getElementById("create-pin-input").value.trim();
    const pin2 = document.getElementById("create-pin-confirm").value.trim();
    if(!/^\d{4}$/.test(pin1)){
      setCreatePinError("PIN deve ter exatamente 4 d√≠gitos num√©ricos.");
      return;
    }
    if(pin1 !== pin2){
      setCreatePinError("Os PINs n√£o coincidem.");
      return;
    }
    const insp = findInspectorByName(pendingPinInspector);
    if(!insp){
      setCreatePinError("Inspetor n√£o encontrado.");
      return;
    }
    insp.pin = pin1;
    if(window.fbApi && window.fbApi.setInspectors){
      try{
        await window.fbApi.setInspectors(inspectors);
      }catch(e){
        console.error("Erro salvar PIN no Firebase:", e);
      }
    }
    alert("PIN criado com sucesso!");
    showLoginPanelMain();
    completeLogin({ name: insp.name, role:"inspector" });
  }

  function handleAdminLogin(){
    setLoginError("");
    const input = document.getElementById("login-admin-password");
    const pwd = (input ? input.value : "").trim();
    if(!pwd){
      setLoginError("Digite a senha do administrador.");
      return;
    }
    // Senha definida por voc√™
    if(pwd !== "qualidade2025"){
      setLoginError("Senha de administrador incorreta.");
      return;
    }
    input.value="";
    completeLogin({ name: "Administrador", role:"admin" });
  }

  function setupLoginUI(){
    const tabInsp = document.getElementById("login-tab-inspector");
    const tabAdmin = document.getElementById("login-tab-admin");
    const inspPanel = document.getElementById("login-inspector-panel");
    const adminPanel = document.getElementById("login-admin-panel");

    if(tabInsp && tabAdmin && inspPanel && adminPanel){
      tabInsp.addEventListener("click", ()=>{
        tabInsp.classList.add("active");
        tabAdmin.classList.remove("active");
        inspPanel.classList.remove("hide");
        adminPanel.classList.add("hide");
        setLoginError("");
      });
      tabAdmin.addEventListener("click", ()=>{
        tabAdmin.classList.add("active");
        tabInsp.classList.remove("active");
        adminPanel.classList.remove("hide");
        inspPanel.classList.add("hide");
        setLoginError("");
      });
    }

    const btnInsp = document.getElementById("btn-login-insp");
    if(btnInsp) btnInsp.addEventListener("click", handleInspectorLogin);

    const btnAdmin = document.getElementById("btn-login-admin");
    if(btnAdmin) btnAdmin.addEventListener("click", handleAdminLogin);

    const btnCreatePin = document.getElementById("btn-create-pin-confirm");
    if(btnCreatePin) btnCreatePin.addEventListener("click", handleCreatePinConfirm);

    const btnCreatePinCancel = document.getElementById("btn-create-pin-cancel");
    if(btnCreatePinCancel) btnCreatePinCancel.addEventListener("click", showLoginPanelMain);
  }

  // =========================
  // CHECKLIST
  // =========================

  function getPieceImageSrc(piece){
    if(!piece) return null;
    if(piece.image instanceof File) return URL.createObjectURL(piece.image);
    return piece.imageUrl || null;
  }
  function getItemImageSrc(item){
    if(!item) return null;
    if(item.image instanceof File) return URL.createObjectURL(item.image);
    return item.imageUrl || null;
  }
  function getStatePhotoSrc(st){
    if(!st) return null;
    if(st.fotoFile instanceof File) return URL.createObjectURL(st.fotoFile);
    return st.fotoUrl || null;
  }

  function renderChecklistSelectors(){
    const pieceSel = document.getElementById("piece-selector");
    if(pieceSel){
      pieceSel.innerHTML = '<option value="" disabled selected>Selecionar pe√ßa</option>' +
        pieces.map(p=>`<option value="${p.code}">${p.code}</option>`).join("");
    }
    const inspDisplay = document.getElementById("insp-display");
    if(inspDisplay){
      inspDisplay.value = currentUser && currentUser.role==="inspector"
        ? currentUser.name
        : currentUser && currentUser.role==="admin"
          ? "Administrador"
          : "";
    }
    document.getElementById("checklist-execution").classList.add("hide");
  }

  function startChecklist(){
    if(!currentUser){
      alert("Fa√ßa login antes de iniciar o checklist.");
      return;
    }
    const pieceCode = document.getElementById("piece-selector").value;
    if(!pieceCode){
      alert("Selecione a pe√ßa para iniciar o checklist.");
      return;
    }
    currentChecklistPiece = pieces.find(p=>p.code===pieceCode);
    if(!currentChecklistPiece){
      alert("Pe√ßa n√£o encontrada.");
      return;
    }
    checklistItemStates = (currentChecklistPiece.items||[]).map(()=>({
      status:null,motivo:"",encaminhamento:"",nomeTerceiro:"",
      fotoFile:null,fotoUrl:null
    }));
    renderChecklistExecution();
    document.getElementById("checklist-execution").classList.remove("hide");
  }

  function renderChecklistExecution(){
    const piece = currentChecklistPiece;
    if(!piece) return;

    document.getElementById("cl-piece-code").textContent = piece.code;
    document.getElementById("cl-piece-desc").textContent = piece.description || "";

    const imgBox = document.getElementById("cl-piece-image-box");
    const mainSrc = getPieceImageSrc(piece);
    if(mainSrc){
      imgBox.innerHTML = `<img src="${mainSrc}" onclick="showImageModal('${mainSrc}')">`;
    }else{
      imgBox.textContent = "[Imagem da pe√ßa]";
    }

    const listDiv = document.getElementById("checklist-item-list");
    listDiv.innerHTML = "";

    (piece.items||[]).forEach((item,idx)=>{
      const st = checklistItemStates[idx] || {};
      const statusClass = st.status==="OK" ? "ok" : st.status==="NOK" ? "nok" : "";
      const itemSrc = getItemImageSrc(item);
      const wrap = document.createElement("div");
      wrap.className = `checklist-item ${statusClass}`;
      wrap.innerHTML = `
        <div class="checklist-item-thumb">
          ${itemSrc?`<img src="${itemSrc}" onclick="showImageModal('${itemSrc}')">`:``}
        </div>
        <div class="checklist-item-body">
          <div class="checklist-item-title">${item.name}</div>
          <div class="checklist-item-desc">${item.description||""}</div>
          <div class="checklist-item-extra" id="extra-${idx}"></div>
        </div>
        <div class="checklist-item-actions">
          <button class="checklist-status-btn btn-ok" data-idx="${idx}" data-status="OK">OK</button>
          <button class="checklist-status-btn btn-nok" data-idx="${idx}" data-status="NOK">N√ÉO OK</button>
        </div>
      `;
      listDiv.appendChild(wrap);

      if(st.status==="NOK"){
        const extraDiv = wrap.querySelector(`#extra-${idx}`);
        extraDiv.innerHTML = `
          <div class="checklist-extra">
            <label>Descri√ß√£o da n√£o conformidade (obrigat√≥rio):</label>
            <textarea id="motivo-${idx}">${st.motivo||""}</textarea>

            <label>Foto (obrigat√≥rio):</label>
            <input type="file" id="foto-${idx}" accept="image/*">

            <div style="margin-top:6px;">
              <label><input type="radio" name="enc-${idx}" value="retrabalho" ${st.encaminhamento==="retrabalho"?"checked":""}> Encaminhar para retrabalho</label><br>
              <label><input type="radio" name="enc-${idx}" value="terceiro" ${st.encaminhamento==="terceiro"?"checked":""}> Aprovado por terceiro</label>
            </div>
            ${st.encaminhamento==="terceiro" ? `
              <div style="margin-top:6px;">
                <label>Nome / matr√≠cula do aprovador:</label>
                <input type="text" id="terceiro-${idx}" value="${st.nomeTerceiro||""}">
              </div>
            `:""}
            ${getStatePhotoSrc(st)?`
              <div style="margin-top:6px;">
                <img src="${getStatePhotoSrc(st)}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImageModal('${getStatePhotoSrc(st)}')">
              </div>
            `:""}
          </div>
        `;
        const motivo = extraDiv.querySelector(`#motivo-${idx}`);
        const fotoInput = extraDiv.querySelector(`#foto-${idx}`);
        const radios = extraDiv.querySelectorAll(`input[name="enc-${idx}"]`);
        const terceiro = extraDiv.querySelector(`#terceiro-${idx}`);

        motivo.addEventListener("input",()=>{
          checklistItemStates[idx].motivo = motivo.value;
        });
        fotoInput.addEventListener("change",()=>{
          const f = fotoInput.files[0]||null;
          checklistItemStates[idx].fotoFile = f;
          checklistItemStates[idx].fotoUrl = null;
          renderChecklistExecution();
        });
        radios.forEach(r=>r.addEventListener("change",()=>{
          checklistItemStates[idx].encaminhamento = r.value;
          renderChecklistExecution();
        }));
        if(terceiro){
          terceiro.addEventListener("input",()=>{
            checklistItemStates[idx].nomeTerceiro = terceiro.value;
          });
        }
      }
    });

    document.querySelectorAll(".checklist-status-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx = Number(btn.dataset.idx);
        const status = btn.dataset.status;
        checklistItemStates[idx].status = status;
        if(status==="OK"){
          checklistItemStates[idx].motivo="";
          checklistItemStates[idx].fotoFile=null;
          checklistItemStates[idx].fotoUrl=null;
          checklistItemStates[idx].encaminhamento="";
          checklistItemStates[idx].nomeTerceiro="";
        }
        renderChecklistExecution();
      });
    });

    renderNokLibrary();
  }

  function renderNokLibrary(){
    const div = document.getElementById("checklist-nok-library");
    const pieceCode = currentChecklistPiece?.code;
    if(!pieceCode){ div.innerHTML=""; return; }

    const nokCases = inspections
      .filter(i=>i.piece===pieceCode)
      .flatMap(ins => (ins.itens||[])
        .map(it=>({...it, ins}))
        .filter(it=>it.status==="NOK")
      );

    if(!nokCases.length){
      div.innerHTML = '<div style="font-size:12px;color:#555;">Nenhuma reprova√ß√£o registrada para esta pe√ßa.</div>';
      return;
    }

    div.innerHTML = `
      <div class="checklist-nok-title">Hist√≥rico de reprova√ß√µes (${nokCases.length})</div>
      <div class="checklist-nok-grid">
        ${nokCases.map(c=>{
          const src = c.fotoUrl || "";
          return `
            <div class="checklist-nok-card">
              <div><strong>${c.ins.date}</strong></div>
              <div>Inspetor: ${c.inspector || c.ins.inspector}</div>
              <div style="margin-top:4px;">${c.motivo||""}</div>
              ${src?`<img src="${src}" onclick="showImageModal('${src}')">`:""}
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  async function finishChecklist(){
    if(!currentChecklistPiece){
      alert("Nenhuma pe√ßa selecionada.");
      return;
    }
    if(!currentUser){
      alert("Sem usu√°rio logado.");
      return;
    }
    for(let i=0;i<checklistItemStates.length;i++){
      const st = checklistItemStates[i];
      if(!st.status){
        alert("Responda todos os itens do checklist.");
        return;
      }
      if(st.status==="NOK"){
        if(!st.motivo?.trim()){
          alert("Preencha o motivo em todos os itens N√ÉO OK.");
          return;
        }
        if(!st.fotoFile && !st.fotoUrl){
          alert("Adicione foto em todos os itens N√ÉO OK.");
          return;
        }
        if(!st.encaminhamento){
          alert("Selecione o encaminhamento em todos os itens N√ÉO OK.");
          return;
        }
        if(st.encaminhamento==="terceiro" && !st.nomeTerceiro?.trim()){
          alert("Informe o aprovador em todos os itens aprovados por terceiro.");
          return;
        }
      }
    }

    const now = new Date();
    const inspName = currentUser.name;
    const inspecToSave = {
      date: now.toLocaleDateString("pt-BR"),
      inspector: inspName,
      piece: currentChecklistPiece.code,
      descricao: "Inspe√ß√£o realizada",
      itens: checklistItemStates.map(s=>({
        status: s.status,
        motivo: s.motivo,
        encaminhamento: s.encaminhamento,
        nome_terceiro: s.nomeTerceiro,
        foto: s.fotoFile,
        fotoUrl: s.fotoUrl
      }))
    };

    if(window.fbApi && window.fbApi.saveInspection){
      try{
        const saved = await window.fbApi.saveInspection(inspecToSave);
        inspections.push(saved);
        alert("Inspe√ß√£o salva no servidor.");
      }catch(err){
        console.error("Erro salvar inspe√ß√£o Firebase:", err);
        inspections.push({
          ...inspecToSave,
          itens: inspecToSave.itens.map(i=>({...i, foto:null, fotoUrl:null}))
        });
        alert("Erro ao salvar no servidor. Inspe√ß√£o registrada apenas neste navegador.");
      }
    }else{
      inspections.push({
        ...inspecToSave,
        itens: inspecToSave.itens.map(i=>({...i, foto:null, fotoUrl:null}))
      });
      alert("Inspe√ß√£o registrada localmente.");
    }

    renderReports();
    renderDashboard();
    renderChecklistExecution();

    // Voltar para tela inicial do checklist e limpar
    selectSidebar('checklist');
    const pieceSel = document.getElementById("piece-selector");
    if(pieceSel) pieceSel.value="";
    document.getElementById("checklist-execution").classList.add("hide");
    currentChecklistPiece = null;
    checklistItemStates = [];
  }

  // =========================
  // INSPETORES
  // =========================

  function loadInspectorPhotosFromLocalStorage(){
    try{
      const raw = localStorage.getItem("inspPhotos");
      inspectorPhotos = raw ? JSON.parse(raw) : {};
    }catch{ inspectorPhotos = {}; }
  }
  function saveInspectorPhotosToLocalStorage(){
    try{
      localStorage.setItem("inspPhotos", JSON.stringify(inspectorPhotos||{}));
    }catch(e){ console.warn("Erro salvar fotos localStorage",e); }
  }

  function renderInspectors(){
    const listDiv = document.getElementById("inspectors-list");
    listDiv.innerHTML = "";
    inspectors.forEach(insp=>{
      const name = insp.name;
      const card = document.createElement("div");
      card.className="inspector-card";
      const photoSrc = inspectorPhotos[name] || "";
      const hasPin = !!insp.pin;
      card.innerHTML = `
        <div class="inspector-avatar">
          ${photoSrc?`<img src="${photoSrc}" onclick="showImageModal('${photoSrc}')">`:
            name.split(" ").map(p=>p[0]).join("")}
        </div>
        <div class="inspector-name">${name}</div>
        <div class="inspector-pin-status">
          PIN: ${hasPin ? "cadastrado" : "n√£o cadastrado"}
        </div>
        <div class="inspector-actions">
          <button class="btn-icon btn-edit" data-name="${name}">Editar</button>
          <button class="btn-icon btn-delete" data-name="${name}">Remover</button>
          <button class="btn-icon btn-reset-pin" data-name="${name}">Resetar PIN</button>
        </div>
      `;
      listDiv.appendChild(card);
    });

    listDiv.querySelectorAll(".btn-edit").forEach(btn=>{
      btn.addEventListener("click",()=>{
        openEditInspectorModal(btn.dataset.name);
      });
    });
    listDiv.querySelectorAll(".btn-delete").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const name = btn.dataset.name;
        if(!confirm(`Remover inspetor "${name}"?`)) return;
        inspectors = inspectors.filter(i=>i.name!==name);
        delete inspectorPhotos[name];
        saveInspectorPhotosToLocalStorage();
        renderInspectors();
        renderChecklistSelectors();
        renderLoginInspectorSelect();
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
      });
    });
    listDiv.querySelectorAll(".btn-reset-pin").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const name = btn.dataset.name;
        const insp = findInspectorByName(name);
        if(!insp) return;
        if(!confirm(`Resetar PIN do inspetor "${name}"?`)) return;
        insp.pin = null;
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
        alert("PIN resetado. No pr√≥ximo login o inspetor dever√° criar um novo PIN.");
        renderInspectors();
      });
    });

    document.getElementById("insp-name-input").value="";
    document.getElementById("insp-photo-input").value="";
  }

  function openEditInspectorModal(name){
    const insp = findInspectorByName(name);
    if(!insp) return;
    const currentPhoto = inspectorPhotos[name] || "";
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Inspetor</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Nome</label>
        <input type="text" id="modal-insp-name" value="${insp.name}">
      </div>
      <div class="form-group">
        <label>Foto</label>
        <input type="file" id="modal-insp-photo" accept="image/*">
      </div>
      ${currentPhoto?`
        <div style="margin-top:6px;text-align:center;">
          <img src="${currentPhoto}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
        </div>`:""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-insp-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-insp-save").addEventListener("click",()=>{
      const newName = document.getElementById("modal-insp-name").value.trim();
      const file = document.getElementById("modal-insp-photo").files[0];
      if(!newName){ alert("Nome n√£o pode ser vazio."); return; }

      // Atualiza nome
      insp.name = newName;

      // Ajusta mapa de fotos se nome mudou
      if(newName!==name){
        inspectorPhotos[newName] = inspectorPhotos[name];
        delete inspectorPhotos[name];
      }

      const finalize = ()=>{
        saveInspectorPhotosToLocalStorage();
        closeModal();
        renderInspectors();
        renderChecklistSelectors();
        renderLoginInspectorSelect();
        updateHeaderUserInfo();
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
      };

      if(file){
        const reader = new FileReader();
        reader.onload = e=>{
          inspectorPhotos[newName] = e.target.result;
          finalize();
        };
        reader.readAsDataURL(file);
      }else{
        finalize();
      }
    });
  }

  function openChangePinModal(){
    if(!currentUser || currentUser.role!=="inspector") return;
    const insp = findInspectorByName(currentUser.name);
    if(!insp) return;
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Alterar PIN</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>PIN atual</label>
        <input type="password" id="change-pin-current" maxlength="4" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>Novo PIN (4 d√≠gitos)</label>
        <input type="password" id="change-pin-new" maxlength="4" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>Confirmar novo PIN</label>
        <input type="password" id="change-pin-confirm" maxlength="4" inputmode="numeric">
      </div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="change-pin-save">Salvar</button>
      </div>
    `);

    document.getElementById("change-pin-save").addEventListener("click",async()=>{
      const cur = document.getElementById("change-pin-current").value.trim();
      const pinNew = document.getElementById("change-pin-new").value.trim();
      const pinConf = document.getElementById("change-pin-confirm").value.trim();
      if(!cur || !pinNew || !pinConf){
        alert("Preencha todos os campos.");
        return;
      }
      if(!/^\d{4}$/.test(pinNew)){
        alert("Novo PIN deve ter 4 d√≠gitos num√©ricos.");
        return;
      }
      if(pinNew !== pinConf){
        alert("Novo PIN e confirma√ß√£o n√£o coincidem.");
        return;
      }
      if(!insp.pin){
        // se ainda n√£o tinha PIN salvo, ignoramos o atual
      } else {
        if(cur !== insp.pin){
          alert("PIN atual incorreto.");
          return;
        }
      }
      insp.pin = pinNew;
      if(window.fbApi && window.fbApi.setInspectors){
        try{
          await window.fbApi.setInspectors(inspectors);
        }catch(e){
          console.error("Erro salvar PIN no Firebase:", e);
        }
      }
      alert("PIN atualizado com sucesso.");
      closeModal();
      renderInspectors();
    });
  }

  // =========================
  // PE√áAS & ITENS
  // =========================

  function renderPieces(){
    const listDiv = document.getElementById("pieces-list");
    const selectItems = document.getElementById("piece-items-selector");
    listDiv.innerHTML=""; selectItems.innerHTML="";

    pieces.forEach((p,idx)=>{
      const row = document.createElement("div");
      row.className="piece-row";
      const src = getPieceImageSrc(p);
      row.innerHTML = `
        <div class="piece-row-left">
          <div class="piece-thumb">${src?`<img src="${src}">`:""}</div>
          <div class="piece-label">${p.code} ‚Äî ${p.description||""}</div>
        </div>
        <div>
          <button class="btn-icon btn-edit" data-idx="${idx}">Editar</button>
          <button class="btn-icon btn-delete" data-idx="${idx}">Remover</button>
        </div>
      `;
      listDiv.appendChild(row);
      selectItems.innerHTML += `<option value="${idx}">${p.code}</option>`;
    });

    document.querySelectorAll("#pieces-list .btn-edit").forEach(btn=>{
      btn.addEventListener("click",()=>openEditPieceModal(Number(btn.dataset.idx)));
    });
    document.querySelectorAll("#pieces-list .btn-delete").forEach(btn=>{
      btn.addEventListener("click",async()=>{
        const idx = Number(btn.dataset.idx);
        const p = pieces[idx];
        if(!confirm(`Excluir pe√ßa "${p.code}"?`)) return;
        pieces.splice(idx,1);
        renderPieces();
        renderChecklistSelectors();
        if(window.fbApi && window.fbApi.deletePiece){
          window.fbApi.deletePiece(p.code).catch(e=>console.error("Erro delete pe√ßa Firebase",e));
        }
      });
    });

    if(pieces.length){
      document.getElementById("piece-items-selector").value = 0;
      renderPieceItemsList(0);
    }else{
      document.getElementById("piece-items-list").innerHTML =
        "<div style='font-size:12px;color:#666;'>Nenhuma pe√ßa cadastrada.</div>";
    }

    document.getElementById("piece-code-input").value="";
    document.getElementById("piece-desc-input").value="";
    document.getElementById("piece-image-input").value="";
  }

  function openEditPieceModal(idx){
    const p = pieces[idx];
    const src = getPieceImageSrc(p) || "";
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Pe√ßa</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>C√≥digo</label>
        <input type="text" id="modal-piece-code" value="${p.code}">
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <input type="text" id="modal-piece-desc" value="${p.description||""}">
      </div>
      <div class="form-group">
        <label>Imagem</label>
        <input type="file" id="modal-piece-img" accept="image/*">
      </div>
      ${src?`
        <div style="margin-top:6px;text-align:center;">
          <img src="${src}" style="max-width:120px;max-height:80px;border-radius:6px;">
        </div>`:""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-piece-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-piece-save").addEventListener("click",async()=>{
      const newCode = document.getElementById("modal-piece-code").value.trim();
      const newDesc = document.getElementById("modal-piece-desc").value.trim();
      const file = document.getElementById("modal-piece-img").files[0];
      if(!newCode || !newDesc){ alert("Preencha c√≥digo e descri√ß√£o."); return; }
      p.code=newCode; p.description=newDesc;
      if(file){ p.image=file; p.imageUrl=null; }
      closeModal();
      renderPieces();
      renderChecklistSelectors();
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(p).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });
  }

  function renderPieceItemsList(pieceIdx){
    const box = document.getElementById("piece-items-list");
    box.innerHTML="";
    const p = pieces[pieceIdx];
    if(!p) return;
    (p.items||[]).forEach((it,idx)=>{
      const row = document.createElement("div");
      row.className="piece-item-row";
      const src = getItemImageSrc(it);
      row.innerHTML = `
        <div class="piece-item-main">
          <div class="piece-item-thumb">${src?`<img src="${src}">`:""}</div>
          <div>
            <div style="font-size:13px;font-weight:600;">${it.name}</div>
            <div style="font-size:11px;color:#555;">${it.description||""}</div>
          </div>
        </div>
        <div>
          <button class="btn-icon btn-edit" data-pidx="${pieceIdx}" data-idx="${idx}">Editar</button>
          <button class="btn-icon btn-delete" data-pidx="${pieceIdx}" data-idx="${idx}">Remover</button>
        </div>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll(".btn-edit").forEach(btn=>{
      btn.addEventListener("click",()=>openEditItemModal(Number(btn.dataset.pidx),Number(btn.dataset.idx)));
    });
    box.querySelectorAll(".btn-delete").forEach(btn=>{
      btn.addEventListener("click",async()=>{
        const pidx = Number(btn.dataset.pidx);
        const idx = Number(btn.dataset.idx);
        const p = pieces[pidx];
        if(!confirm(`Remover item "${p.items[idx].name}"?`)) return;
        p.items.splice(idx,1);
        renderPieceItemsList(pidx);
        if(window.fbApi && window.fbApi.savePiece){
          window.fbApi.savePiece(p).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
        }
      });
    });
  }

  function openEditItemModal(pieceIdx,idx){
    const item = pieces[pieceIdx].items[idx];
    const src = getItemImageSrc(item) || "";
    showModal(`
      <div class="modal-header">
        <div class="modal-title">Editar Item</div>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Nome</label>
        <input type="text" id="modal-item-name" value="${item.name}">
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <textarea id="modal-item-desc" rows="2">${item.description||""}</textarea>
      </div>
      <div class="form-group">
        <label>Imagem</label>
        <input type="file" id="modal-item-img" accept="image/*">
      </div>
      ${src?`
        <div style="margin-top:6px;text-align:center;">
          <img src="${src}" style="max-width:120px;max-height:80px;border-radius:6px;">
        </div>`:""}
      <div style="margin-top:12px;text-align:right;">
        <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn-primary" id="modal-item-save">Salvar</button>
      </div>
    `);

    document.getElementById("modal-item-save").addEventListener("click",async()=>{
      const name = document.getElementById("modal-item-name").value.trim();
      const desc = document.getElementById("modal-item-desc").value.trim();
      const file = document.getElementById("modal-item-img").files[0];
      if(!name || !desc){ alert("Preencha nome e descri√ß√£o."); return; }
      item.name=name; item.description=desc;
      if(file){ item.image=file; item.imageUrl=null; }
      closeModal();
      renderPieceItemsList(pieceIdx);
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(pieces[pieceIdx]).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });
  }

  // =========================
  // RELAT√ìRIOS / DASHBOARD
  // =========================

  function ensureReportsChart(){
    const ctx = document.getElementById("reports-chart")?.getContext("2d");
    if(!ctx) return;
    if(!reportsChart){
      reportsChart = new Chart(ctx,{
        type:"doughnut",
        data:{
          labels:["Embarcadas","Retrabalho"],
          datasets:[{
            data:[0,0],
            backgroundColor:["#228be6","#e23636"],
            borderColor:"#fff",
            borderWidth:2
          }]
        },
        options:{responsive:false,plugins:{legend:{display:true}},cutout:"60%"}
      });
    }
  }

  function renderReports(){
    ensureReportsChart();
    const monthSelect = document.getElementById("report-month-select");
    const tbody = document.getElementById("reports-history-body");
    const totalSpan = document.getElementById("total-inspecoes");
    if(!monthSelect || !tbody || !totalSpan) return;

    const monthsSet = new Set();
    inspections.forEach(i=>{
      if(!i.date) return;
      const [d,m,y] = i.date.split("/");
      if(m&&y) monthsSet.add(`${m}/${y}`);
    });
    const months = Array.from(monthsSet).sort().reverse();
    monthSelect.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");
    const current = monthSelect.value || (months[0]||"");
    monthSelect.value = current;

    let embarcadas=0, retrabalho=0;
    const filtered = inspections.filter(i=>{
      if(!i.date) return false;
      const [d,m,y] = i.date.split("/");
      return `${m}/${y}`===current;
    });

    filtered.forEach(i=>{
      (i.itens||[]).forEach(it=>{
        if(it.status==="OK") embarcadas++;
        else if(it.encaminhamento==="retrabalho") retrabalho++;
        else embarcadas++;
      });
    });

    totalSpan.textContent = inspections.length;
    tbody.innerHTML = filtered.length
      ? filtered.map(i=>`
        <tr>
          <td>${i.date}</td>
          <td>${i.inspector}</td>
          <td>${i.piece}</td>
          <td>${i.descricao||"-"}</td>
        </tr>`).join("")
      : `<tr><td colspan="4" style="text-align:center;">Nenhuma inspe√ß√£o para o m√™s selecionado.</td></tr>`;

    if(reportsChart){
      reportsChart.data.datasets[0].data = [embarcadas,retrabalho];
      reportsChart.update();
    }
  }

  function exportCSV(){
    if(!inspections.length){
      alert("Sem inspe√ß√µes para exportar.");
      return;
    }
    const rows = ["Data,Inspetor,Pe√ßa,Descri√ß√£o"];
    inspections.forEach(i=>{
      const desc = (i.descricao||"").replace(/"/g,'""');
      rows.push(`${i.date},"${i.inspector}","${i.piece}","${desc}"`);
    });
    const blob = new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="relatorio_inspecoes.csv"; a.click();
    URL.revokeObjectURL(url);
  }

  function ensureDashboardChart(){
    const ctx = document.getElementById("dashboard-chart")?.getContext("2d");
    if(!ctx) return;
    if(!dashboardChart){
      dashboardChart = new Chart(ctx,{
        type:"doughnut",
        data:{
          labels:["Embarcadas","Retrabalho"],
          datasets:[{
            data:[0,0],
            backgroundColor:["#228be6","#e23636"],
            borderColor:"#fff",
            borderWidth:2
          }]
        },
        options:{responsive:false,plugins:{legend:{display:true}},cutout:"60%"}
      });
    }
  }

  function renderDashboard(){
    ensureDashboardChart();
    const kpiInsMes = document.getElementById("kpi-inspecoes-mes");
    const kpiPercentNok = document.getElementById("kpi-percent-nok");
    const kpiTopPecas = document.getElementById("kpi-top-pecas");
    if(!kpiInsMes || !kpiPercentNok || !kpiTopPecas) return;

    if(!inspections.length){
      kpiInsMes.textContent="0";
      kpiPercentNok.textContent="0%";
      kpiTopPecas.innerHTML="<div>Sem dados suficientes.</div>";
      if(dashboardChart){
        dashboardChart.data.datasets[0].data=[0,0];
        dashboardChart.update();
      }
      return;
    }

    const last = inspections[inspections.length-1];
    const [d,m,y] = (last.date||"").split("/");
    const currentMonth = `${m}/${y}`;

    let countIns=0,totalItens=0,totalNok=0,embarcadas=0,retrabalho=0;
    const nokByPiece={};
    inspections.forEach(i=>{
      const [dd,mm,yy] = (i.date||"").split("/");
      if(`${mm}/${yy}`!==currentMonth) return;
      countIns++;
      (i.itens||[]).forEach(it=>{
        totalItens++;
        if(it.status==="NOK"){
          totalNok++;
          nokByPiece[i.piece] = (nokByPiece[i.piece]||0)+1;
        }
        if(it.status==="OK") embarcadas++;
        else if(it.encaminhamento==="retrabalho") retrabalho++;
        else embarcadas++;
      });
    });

    kpiInsMes.textContent = String(countIns);
    const percent = totalItens>0 ? ((totalNok/totalItens)*100).toFixed(1) : "0.0";
    kpiPercentNok.textContent = `${percent}%`;

    const top = Object.entries(nokByPiece)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,3);
    kpiTopPecas.innerHTML = top.length
      ? top.map(([code,q])=>`<div>${code}: <strong>${q}</strong> NOK</div>`).join("")
      : "<div>Nenhuma reprova√ß√£o no m√™s atual.</div>";

    if(dashboardChart){
      dashboardChart.data.datasets[0].data = [embarcadas,retrabalho];
      dashboardChart.update();
    }
  }

  // =========================
  // DOMCONTENTLOADED
  // =========================

  document.addEventListener("DOMContentLoaded",async()=>{
    loadInspectorPhotosFromLocalStorage();
    setupLoginUI();

    if(window.fbApi && window.fbApi.loadAll){
      try{
        const data = await window.fbApi.loadAll();
        if(data.pieces && data.pieces.length) pieces = data.pieces;
        if(data.inspectors && data.inspectors.length) inspectors = data.inspectors;
        if(data.inspections && data.inspections.length) inspections = data.inspections;
      }catch(err){
        console.error("Erro carregar Firebase:",err);
      }
    }

    // Bot√µes principais
    const btnStart = document.getElementById("btn-start-checklist");
    if(btnStart) btnStart.addEventListener("click", startChecklist);

    const btnFinish = document.getElementById("btn-finish-checklist");
    if(btnFinish) btnFinish.addEventListener("click", finishChecklist);

    const btnAddInspector = document.getElementById("btn-add-inspector");
    if(btnAddInspector) btnAddInspector.addEventListener("click",()=>{
      const name = document.getElementById("insp-name-input").value.trim();
      const file = document.getElementById("insp-photo-input").files[0];
      if(!name){ alert("Informe o nome do inspetor."); return; }
      if(findInspectorByName(name)){ alert("J√° existe um inspetor com esse nome."); return; }

      const addInspector = (photoDataUrl)=>{
        inspectors.push({ name, pin: null });
        if(photoDataUrl) inspectorPhotos[name]=photoDataUrl;
        saveInspectorPhotosToLocalStorage();
        renderInspectors();
        renderChecklistSelectors();
        renderLoginInspectorSelect();
        if(window.fbApi && window.fbApi.setInspectors){
          window.fbApi.setInspectors(inspectors).catch(e=>console.error("Erro salvar insp Firebase",e));
        }
      };

      if(file){
        const reader = new FileReader();
        reader.onload = e=>addInspector(e.target.result);
        reader.readAsDataURL(file);
      }else{
        addInspector(null);
      }
    });

    const pieceItemsSelector = document.getElementById("piece-items-selector");
    if(pieceItemsSelector) pieceItemsSelector.addEventListener("change",e=>{
      const idx = Number(e.target.value);
      renderPieceItemsList(idx);
    });

    const btnAddPiece = document.getElementById("btn-add-piece");
    if(btnAddPiece) btnAddPiece.addEventListener("click",async()=>{
      const code = document.getElementById("piece-code-input").value.trim();
      const desc = document.getElementById("piece-desc-input").value.trim();
      const file = document.getElementById("piece-image-input").files[0];
      if(!code || !desc || !file){
        alert("Preencha c√≥digo, descri√ß√£o e imagem.");
        return;
      }
      if(pieces.some(p=>p.code===code)){
        alert("J√° existe uma pe√ßa com esse c√≥digo.");
        return;
      }
      const newPiece = {code,description:desc,image:file,imageUrl:null,items:[]};
      pieces.push(newPiece);
      renderPieces();
      renderChecklistSelectors();
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(newPiece).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });

    const btnAddItem = document.getElementById("btn-add-item");
    if(btnAddItem) btnAddItem.addEventListener("click",async()=>{
      const pieceIdx = Number(document.getElementById("piece-items-selector").value);
      if(Number.isNaN(pieceIdx) || !pieces[pieceIdx]){
        alert("Selecione uma pe√ßa.");
        return;
      }
      const name = document.getElementById("item-name-input").value.trim();
      const desc = document.getElementById("item-desc-input").value.trim();
      const file = document.getElementById("item-image-input").files[0];
      if(!name || !desc || !file){
        alert("Preencha nome, descri√ß√£o e imagem do item.");
        return;
      }
      pieces[pieceIdx].items.push({name,description:desc,image:file,imageUrl:null});
      document.getElementById("item-name-input").value="";
      document.getElementById("item-desc-input").value="";
      document.getElementById("item-image-input").value="";
      renderPieceItemsList(pieceIdx);
      if(window.fbApi && window.fbApi.savePiece){
        window.fbApi.savePiece(pieces[pieceIdx]).catch(e=>console.error("Erro salvar pe√ßa Firebase",e));
      }
    });

    const btnExportCsv = document.getElementById("btn-export-csv");
    if(btnExportCsv) btnExportCsv.addEventListener("click", exportCSV);

    const reportMonthSelect = document.getElementById("report-month-select");
    if(reportMonthSelect) reportMonthSelect.addEventListener("change",renderReports);

    const btnChangePin = document.getElementById("btn-change-pin");
    if(btnChangePin) btnChangePin.addEventListener("click", openChangePinModal);

    const btnLogout = document.getElementById("btn-logout");
    if(btnLogout) btnLogout.addEventListener("click", logout);

    // Render inicial em background (app oculto at√© login)
    renderChecklistSelectors();
    renderInspectors();
    renderPieces();
    renderReports();
    renderDashboard();
    renderLoginInspectorSelect();
  });
  </script>
</body>
</html>
