<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Magius - Sistema de Checklist de Inspeção</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
body { font-family: Arial,sans-serif; background:#fff; color:#333; margin:0;}
.container { max-width:1200px; margin:32px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 0 10px #0001;}
.header { background:#003366; color:#fff; padding:15px 20px; border-radius:8px 8px 0 0; margin:-20px -20px 24px -20px; display:flex;justify-content:space-between;align-items:center;}
.header-logo {font-size:24px; font-weight:bold;}
.header-circles span{display:inline-block;width:20px;height:20px;border:2px solid #fff;border-radius:50%;margin-right:10px;}
.nav-btn,.btn-primary,.btn-secondary,.btn-checklist,#finalizar-inspecao-btn { background:#003366 !important;color:#fff !important;border:none;box-shadow:0 2px 6px #0001;}
.nav-btn,.btn-primary,.btn-checklist { padding:13px 32px;border-radius:9px;font-size:20px;font-weight:500;cursor:pointer;transition:background-color 0.2s;}
.btn-primary,.btn-secondary,.btn-checklist,#finalizar-inspecao-btn { padding:10px 20px;border-radius:5px;font-size:16px;font-weight:500;}
.btn-secondary {margin-left:10px;}
.nav-btn:hover,.btn-primary:hover,.btn-secondary:hover,.btn-checklist:hover,#finalizar-inspecao-btn:hover{background:#005bb5 !important; color:#fff;}
.edit-btn {
    background: #093762 !important;
    color: #fff !important;
    border-radius: 8px;
    cursor: pointer;
    width: 56px; height: 44px;padding:0;font-size:0;border:none;
    display:inline-flex;align-items:center;justify-content:center;
}
.edit-btn::before {
    content: '';display:inline-block;width:20px;height:20px;
    background-image: url('data:image/svg+xml;utf8,<svg fill="white" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M290.74,93.24,218.49,165.49,346.51,293.5,418.76,221.25C437.1,202.91,437.1,175,418.76,156.66Z"/><path d="M223.25,232.6l-20,20L87.27,347.68a16,16,0,0,0,0,22.62l54.57,54.58a16,16,0,0,0,22.62,0l95.88-95.89,20-20Z"/></svg>');
    background-size:20px 20px;background-repeat:no-repeat;
}
.remove-btn {
    background: #dc3545 !important;
    color: #fff !important;
    border-radius: 8px;
    width: 44px; height: 44px;
    padding:0;font-size:0;border:none;margin-left:8px;
    display:inline-flex;align-items:center;justify-content:center;
}
.remove-btn::before {
    content: '';display:inline-block;width:20px;height:20px;
    background-image:url('data:image/svg+xml;utf8,<svg fill="white" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 320 320"><path d="M20 20L300 300M20 300L300 20" stroke="white" stroke-width="35"/></svg>');
    background-size:20px 20px;background-repeat:no-repeat;
}
.activity-header,.report-header { background:#003366;color:#fff;padding:11px 18px;font-size:17px;font-weight:700;border-radius:7px 7px 0 0;margin-bottom:14px;letter-spacing:0.5px;}
.report-header {margin-bottom:24px;}
.activity-block {background:#f6f8fa;border-radius:7px;box-shadow:0 2px 12px #0001;margin-bottom:28px;padding:20px 18px 15px 18px;}
.form-group label {font-weight:bold;display:block;margin-bottom:5px;}
input[type="text"],select,textarea {width:100%;padding:10px;margin:8px 0 16px 0;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;}
input[type="file"] {margin-bottom:12px;}
.screen {display:none;padding:20px 0;}
.screen.active {display:block;}
.checklist-item{display:flex;align-items:flex-start;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;padding:10px;transition:background 0.25s;position:relative;}
.checklist-item.ok{background:#dafdda !important;}
.checklist-item.not-ok{background:#fedede !important;}
.checklist-item-info { flex-grow:1; padding-left:10px;}
.checklist-item-actions{display:flex;gap:0px;align-items:center;height:38px;margin-left:6px;}
.checklist-item-actions .btn-ok,.checklist-item-actions .btn-nao-ok{width:90px;height:38px;display:inline-flex;align-items:center;justify-content:center;border:none;outline:none;font-size:18px;font-family:Arial,sans-serif;font-weight:700;color:#fff;margin:0;cursor:pointer;border-radius:3px;transition:filter 0.15s;background:#28b649 !important;}
.checklist-item-actions .btn-nao-ok{background:#e23636 !important;margin-left:-1px;}
.checklist-item-actions .btn-ok{border-top-right-radius:0;border-bottom-right-radius:0;}
.checklist-item-actions .btn-nao-ok{border-top-left-radius:0;border-bottom-left-radius:0;}
.checklist-piece-title{font-size:2.4em;font-weight:700;color:#003366;margin-bottom:15px;}
.checklist-extra-wrapper { width:100%;margin-top:6px;display:flex;flex-direction:row;gap:0;}
.checklist-extra-block{flex:1;padding:15px;border-radius:6px;border:2px solid #e23636;background:#fff6f7;box-sizing:border-box;display:flex;flex-direction:column;gap:17px;margin-left:0;}
.checklist-extra-label{color:#e23636;font-weight:600;margin-bottom:7px;font-size:16px;}
.checklist-radio-group{display:flex;gap:32px;margin-top:2px;}
.checklist-radio-group label{font-size:17px;font-weight:600;}
input[type="radio"]{margin-right:7px;transform:scale(1.2);}
.checklist-terceiro-nome-box{margin-top:8px;}
.checklist-terceiro-nome-box label{font-size:15px;font-weight:600;margin-bottom:4px;display:block;}
.checklist-terceiro-nome-box input{padding:8px;border-radius:4px;border:1px solid #bbb;width:99%;}
input[type="file"]{margin-bottom:4px;}
textarea{font-size:15px;}
.hide{display:none !important;}
.admin-piece-item,.admin-inspector-item {display:flex;justify-content:space-between;align-items:center;padding:5px 10px;border:1px solid #eee;margin-bottom:5px;background:#f9f9f9;border-radius:4px;}
.admin-piece-list,.admin-inspector-list {margin-top:10px;max-height:200px;overflow-y:auto;}
.admin-item-line{display:flex;align-items:center;justify-content:flex-end;margin-bottom:5px;gap:6px;}
.item-label-box{display:flex;align-items:center;gap:6px;flex-grow:1;word-break:break-word;}
.edit-control{margin-top:8px;display:flex;gap:8px;}
.report-controls {display:flex;align-items:center;gap:30px;margin-bottom:22px;}
.report-total-volume,.report-csv-btn{padding:13px 34px;background:#093762;color:#fff;font-weight:700;border-radius:8px;box-shadow:0 3px 11px #0001;font-size:18px;display:inline-flex;align-items:center;border:none;cursor:pointer;}
.report-csv-btn:hover{background:#16457c;}
#report-month-select {padding:6px 12px;border-radius:5px;border:1px solid #bbb;font-size:15px;}
#volume-mensal-box {border:1px solid #ddd;padding:38px 20px;text-align:center;background-color:#f8fafc;border-radius:6px;margin-bottom:18px;font-size:21px;}
.report-graph-area {background:#f8fafc;border:1px solid #ddd;border-radius:12px;margin-bottom:30px;padding:10px 0 30px 0;display: flex;flex-direction:column;align-items:center;justify-content:center;}
.report-graph-legend {display:flex;gap:30px;justify-content:center;margin-top:8px;}
.report-graph-legend-item {display:flex;gap:7px;align-items:center;font-weight:500;margin-top:9px;}
.grafico-bola {width:140px;height:140px;}
.report-history-table {width:100%;background:#e8f0fa;border-radius:8px;box-shadow:0 1px 6px #0001;border-spacing:0;border-collapse:separate;margin-top:7px;}
.report-history-table thead tr{background:#dde7f3;}
.report-history-table th {padding:14px 0;border-bottom:2px solid #093762;font-weight:700;font-size:17px;text-align:center;}
.report-history-table td {padding:12px 0;border-bottom:1px solid #b8d4f1;font-size:17px;text-align:center;background:#e8f0fa;}
@media (max-width: 600px) {
    .container { padding:10px; }
    .report-controls { flex-direction:column; gap:14px; }
    .report-total-volume, .report-csv-btn { width:100%; justify-content:center; }
}
.checklist-nok-library {
  background: #f8f0f3;
  border-radius: 10px;
  padding: 12px 16px;
  margin-top: 30px;
  margin-bottom: 10px;
}
.checklist-nok-library-list {
  display: flex;
  flex-wrap: wrap;
  gap: 18px;
}
.checklist-nok-case {
  background: #f8f4f6;
  border-radius: 9px;
  border: 2px solid #e23636;
  padding: 17px;
  width: 260px;
  box-sizing: border-box;
  word-break:break-word;
}
.checklist-nok-case img {
  width: 100%;
  max-width: 200px;
  max-height: 160px;
  object-fit:cover;
  margin-top: 8px;
  cursor: pointer;
  border-radius:8px;
  box-shadow:0 2px 16px #0002;
}
.checklist-nok-title {
  font-size:1.12em;
  color:#e23636;
  font-weight:700;
  margin-bottom:17px;
}
@media (max-width: 700px) {
  .checklist-nok-library-list { flex-direction: column; gap: 11px;}
  .checklist-nok-case { width: 100%; max-width: 99vw; }
}
.modal-overlay {position: fixed; top:0; left:0; right:0; bottom:0;background: rgba(0,0,0,0.35);display: flex; align-items:center; justify-content:center;z-index: 9999;}
.modal-box {background: #fff;border-radius: 15px;box-shadow: 0 6px 24px #0002;padding: 36px 30px 30px 30px;min-width: 320px;max-width: 98vw;max-height: 96vh;position: relative;}
.modal-close {position: absolute; top: 12px; right: 12px;font-size: 28px; background: none; border: none; color: #093762; cursor: pointer;padding: 8px;border-radius: 7px;font-weight: bold;}
.modal-title { font-size: 1.5em; font-weight: 700; margin-bottom: 28px; color: #093762;}
.modal-form-row { margin-bottom:22px; } .modal-form-row label {font-weight:500;margin-right:7px;}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left">
            <div class="header-circles">
                <span></span><span></span><span></span><span></span>
            </div>
            <div class="header-tagline">AJUDANDO A CONSTRUIR, CULTIVAR,<br>TRANSPORTAR E SEGUIR EM FRENTE</div>
        </div>
        <div class="header-right">
            <div class="header-logo">MAGIUS</div>
            <div class="header-tagline">METALÚRGICA INDUSTRIAL</div>
        </div>
    </div>
    <div style="display:flex;justify-content:flex-end;align-items:flex-start;margin-bottom:20px;">
      <div style="display:flex;flex-direction:column;gap:10px;">
        <button class="nav-btn" onclick="showScreen('reports')">Relatórios</button>
        <div style="display:flex;gap:10px;">
          <button class="nav-btn" onclick="showScreen('admin')">Admin</button>
          <button class="nav-btn" onclick="showScreen('home')">Início</button>
        </div>
      </div>
    </div>
    <div id="home" class="screen active">
        <h2 style="font-size:2em;font-weight:700;margin-bottom:0.2em;">MAGIUS - Sistema de Checklist de Inspeção</h2>
        <div class="form-group">
            <label for="inspector">Inspetor:</label>
            <select id="inspector"><option value="" disabled selected>Selecionar inspetor</option></select>
        </div>
        <div class="form-group">
            <label for="piece">Peça:</label>
            <select id="piece"><option value="" disabled selected>Selecionar peça</option></select>
        </div>
        <button class="btn-checklist" onclick="showChecklist()">Iniciar Checklist</button>
    </div>
    <div id="checklist" class="screen">
        <div class="checklist-piece-title" id="checklist-header"></div>
        <div id="piece-image-box" style="background-color:#f0f5fa;height:260px;margin-bottom:20px;display:flex;justify-content:center;align-items:center;border-radius:10px;">
            [Imagem aqui]
        </div>
        <div class="checklist-item-list" id="checklist-item-list"></div>
        <button class="btn-primary" id="finalizar-inspecao-btn" style="margin-top:20px;">Finalizar Inspeção</button>
        <div class="checklist-nok-library" id="checklist-nok-library"></div>
    </div>
    <div id="reports" class="screen">
      <div class="report-header">Relatórios</div>
      <div class="report-controls">
          <button class="report-csv-btn" onclick="exportCSV()">Exportar CSV</button>
          <div class="report-total-volume">
              Total (todas inspeções): <span id="total-inspecoes" style="margin-left:10px;font-size:21px;">0</span>
          </div>
          <div>
              <label for="report-month-select" style="font-weight:500;margin-right:7px;">Selecionar mês:</label>
              <select id="report-month-select"></select>
          </div>
      </div>
      <div style="font-weight:600;margin-bottom:7px;">Volume mensal</div>
      <div id="volume-mensal-box"><span id="volume-mensal-num">0</span> inspeções</div>
      <div class="report-graph-area">
          <canvas id="graficoRosca" class="grafico-bola" width="140" height="140"></canvas>
          <div class="report-graph-legend">
              <div class="report-graph-legend-item">
                  <span style="display:inline-block;width:18px;height:18px;background:#228be6;border-radius:6px;"></span>
                  <span>Embarcadas</span>
              </div>
              <div class="report-graph-legend-item">
                  <span style="display:inline-block;width:18px;height:18px;background:#e23636;border-radius:6px;"></span>
                  <span>Retrabalho</span>
              </div>
          </div>
      </div>
      <div style="font-weight:600;margin-bottom:6px;">Histórico</div>
      <div class="report-history">
          <table class="report-history-table">
              <thead>
                  <tr>
                      <th>Data</th>
                      <th>Inspetor</th>
                      <th>Peça</th>
                      <th>Descrição</th>
                  </tr>
              </thead>
              <tbody id="reports-history-body"></tbody>
          </table>
      </div>
    </div>
    <div id="admin" class="screen">
        <div class="activity-block">
            <div class="activity-header">Adicionar Peça</div>
            <div id="piece-form-fields">
                <div class="form-group">
                    <label for="new-code">Código (Ex: 597-2445#01)</label>
                    <input type="text" id="new-code" placeholder="Ex: 597-2445#01">
                </div>
                <div class="form-group">
                    <label for="new-description">Descrição</label>
                    <input type="text" id="new-description" placeholder="Longarina">
                </div>
                <div class="form-group">
                    <label for="new-image">Imagem (obrigatória)</label>
                    <input type="file" id="new-image">
                    <p style="font-size:12px;margin-top:5px;" id="image-file-info">Nenhum arquivo escolhido</p>
                </div>
            </div>
            <div class="edit-control hide" id="edit-piece-controls">
                <button class="btn-primary" id="update-piece-btn">Salvar edição</button>
            </div>
            <button class="btn-primary" id="add-piece-btn" style="margin-right:10px;">Adicionar peça</button>
            <button class="btn-secondary" id="clear-piece-btn">Limpar</button>
            <h4 style="margin-top:30px;">Peças existentes</h4>
            <div class="admin-piece-list" id="admin-piece-list"></div>
        </div>
        <div class="activity-block">
            <div class="activity-header">Adicionar Item</div>
            <div class="form-group">
                <label for="select-piece-item">Selecionar peça</label>
                <select id="select-piece-item"></select>
            </div>
            <h5 style="margin-top:10px;">Itens atuais</h5>
            <div id="admin-piece-items-list"></div>
            <div id="item-form-fields">
                <div class="form-group">
                    <label for="new-item-name">Novo item</label>
                    <input type="text" id="new-item-name" placeholder="Dimensão X">
                </div>
                <div class="form-group">
                    <label for="new-item-description">Descrição do item (obrigatória)</label>
                    <textarea id="new-item-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="new-item-image">Imagem do item (obrigatória)</label>
                    <input type="file" id="new-item-image">
                    <p style="font-size:12px;margin-top:5px;" id="item-image-file-info">Nenhum arquivo escolhido</p>
                </div>
            </div>
            <div class="edit-control hide" id="edit-item-controls">
                <button class="btn-primary" id="update-piece-item-btn">Salvar edição</button>
            </div>
            <button class="btn-primary" id="add-piece-item-btn">Adicionar item</button>
        </div>
        <div class="activity-block">
            <div class="activity-header">Adicionar Inspetor</div>
            <div style="display:flex;">
                <input type="text" id="inspector-new-name" placeholder="Nome do inspetor" style="margin-right:10px;">
                <button class="btn-primary" id="add-inspector-btn" style="height:40px;">Adicionar</button>
                <button class="btn-secondary" id="clear-inspector-btn" style="height:40px;margin-left:5px;">Limpar</button>
            </div>
            <h4 style="margin-top:30px;">Inspetores</h4>
            <div class="admin-inspector-list" id="admin-inspector-list"></div>
        </div>
    </div>
    <div id="modal-overlay" class="modal-overlay" style="display:none;">
      <div class="modal-box" id="modal-box"></div>
    </div>
</div>

<!-- SCRIPT FIREBASE (MÓDULO) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { 
    getStorage, ref as storageRef, uploadBytes, getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCAAowsqkoUjIAPhSvq6dUlKMZGdXOO1b0",
    authDomain: "magiuschecklist-9ad0f.firebaseapp.com",
    projectId: "magiuschecklist-9ad0f",
    storageBucket: "magiuschecklist-9ad0f.firebasestorage.app", <!-- ✅ corrigido aqui -->
    messagingSenderId: "14669686712",
    appId: "1:14669686712:web:1c205b1111cde18379114d",
    measurementId: "G-GQS591WCBD"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  async function uploadFile(file, path) {
    if (!file) return null;
    const ref = storageRef(storage, path);
    await uploadBytes(ref, file);
    const url = await getDownloadURL(ref);
    return url;
  }

  async function loadAll() {
    // pieces
    const piecesSnap = await getDocs(collection(db, "pieces"));
    const pieces = piecesSnap.docs.map(d => {
      const data = d.data();
      return {
        code: data.code,
        description: data.description,
        image: null,
        imageUrl: data.imageUrl || null,
        items: (data.items || []).map(it => ({
          name: it.name,
          description: it.description,
          image: null,
          imageUrl: it.imageUrl || null
        }))
      };
    });

    // inspectors (config/inspectors)
    let inspectors = [];
    const inspRef = doc(db, "config", "inspectors");
    const inspSnap = await getDoc(inspRef);
    if (inspSnap.exists()) {
      const d = inspSnap.data();
      inspectors = d.list || [];
    }

    // inspections
    const inspecSnap = await getDocs(collection(db, "inspections"));
    const inspections = inspecSnap.docs.map(d => {
      const data = d.data();
      return {
        id: d.id,
        date: data.date,
        inspector: data.inspector,
        piece: data.piece,
        descricao: data.descricao || "",
        itens: (data.itens || []).map(it => ({
          status: it.status,
          motivo: it.motivo,
          encaminhamento: it.encaminhamento,
          nome_terceiro: it.nome_terceiro || "",
          foto: null,
          fotoUrl: it.fotoUrl || null
        }))
      };
    });

    return { pieces, inspectors, inspections };
  }

  async function savePiece(piece) {
    if (!piece || !piece.code) return;
    let imageUrl = piece.imageUrl || null;
    if (piece.image instanceof File) {
      imageUrl = await uploadFile(
        piece.image,
        `pieces/${piece.code}/${Date.now()}_${piece.image.name}`
      );
    }
    const processedItems = [];
    if (Array.isArray(piece.items)) {
      for (const it of piece.items) {
        let itemImgUrl = it.imageUrl || null;
        if (it.image instanceof File) {
          itemImgUrl = await uploadFile(
            it.image,
            `pieces/${piece.code}/items/${Date.now()}_${it.image.name}`
          );
        }
        processedItems.push({
          name: it.name,
          description: it.description,
          imageUrl: itemImgUrl
        });
      }
    }
    const ref = doc(db, "pieces", piece.code);
    await setDoc(ref, {
      code: piece.code,
      description: piece.description,
      imageUrl,
      items: processedItems
    });
  }

  async function deletePiece(code) {
    if (!code) return;
    await deleteDoc(doc(db, "pieces", code));
  }

  async function setInspectors(list) {
    const ref = doc(db, "config", "inspectors");
    await setDoc(ref, { list: list || [] });
  }

  async function saveInspection(inspec) {
    const itensProcessed = [];
    let idx = 0;
    for (const it of (inspec.itens || [])) {
      let fotoUrl = it.fotoUrl || null;
      if (it.foto instanceof File) {
        fotoUrl = await uploadFile(
          it.foto,
          `inspections/${inspec.piece}/${Date.now()}_${idx}_${it.foto.name}`
        );
      }
      itensProcessed.push({
        status: it.status,
        motivo: it.motivo,
        encaminhamento: it.encaminhamento,
        nome_terceiro: it.nome_terceiro || "",
        fotoUrl
      });
      idx++;
    }
    const docData = {
      date: inspec.date,
      inspector: inspec.inspector,
      piece: inspec.piece,
      descricao: inspec.descricao || "",
      itens: itensProcessed
    };
    const ref = await addDoc(collection(db, "inspections"), docData);
    return { id: ref.id, ...docData };
  }

  window.fbApi = {
    loadAll,
    savePiece,
    deletePiece,
    setInspectors,
    saveInspection
  };
</script>

<!-- SCRIPT PRINCIPAL (APP) -->
<script>
/* ... TODO: resto do JS igual ao que você já enviou, não alterei nada dele ... */
</script>
</body>
</html>
